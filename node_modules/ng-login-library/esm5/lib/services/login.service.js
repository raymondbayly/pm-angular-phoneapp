/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Storage } from '@ionic/storage';
import { JwtHelperService } from '@auth0/angular-jwt';
import { TokenApiService, User } from 'ng-common-library';
import { LoginConfigService } from './login-config.service';
import { Subject } from 'rxjs';
import { first } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@ionic/storage";
import * as i3 from "@auth0/angular-jwt/src/jwthelper.service";
import * as i4 from "./login-config.service";
import * as i5 from "ng-common-library";
var LoginService = /** @class */ (function () {
    function LoginService(http, storage, jwtHelper, loginConfigService, tokenService) {
        var _this = this;
        this.http = http;
        this.storage = storage;
        this.jwtHelper = jwtHelper;
        this.loginConfigService = loginConfigService;
        this.tokenService = tokenService;
        this.currentUser = null;
        this.login$ = new Subject();
        this.hideLogin = true;
        this.JWT_USER_NAME = 'jwt_user';
        /*
          Check if a user is already stored
          This is for when child windows (ie. PSG)
          are being opened.
        */
        storage.get(this.JWT_USER_NAME)
            .then(function (user) {
            _this.setCurrentUser(user);
        });
    }
    /**
     * @return {?}
     */
    LoginService.prototype.getCurrentUser = /**
     * @return {?}
     */
    function () {
        return this.currentUser;
    };
    /**
     * @param {?} user
     * @return {?}
     */
    LoginService.prototype.setCurrentUser = /**
     * @param {?} user
     * @return {?}
     */
    function (user) {
        this.currentUser = user;
    };
    /**
     * @return {?}
     */
    LoginService.prototype.getLogoSrc = /**
     * @return {?}
     */
    function () {
        return this.loginConfigService.getLogoSrc();
    };
    /**
     * @return {?}
     */
    LoginService.prototype.getLoginApiUrl = /**
     * @return {?}
     */
    function () {
        return this.loginConfigService.getLoginApiUrl();
    };
    /**
     * @return {?}
     */
    LoginService.prototype.getLoginIpUrl = /**
     * @return {?}
     */
    function () {
        return this.loginConfigService.getLoginIpUrl();
    };
    /**
     * @return {?}
     */
    LoginService.prototype.getLoginUrl = /**
     * @return {?}
     */
    function () {
        return this.loginConfigService.getLoginUrl();
    };
    /**
     * @return {?}
     */
    LoginService.prototype.getLogoutUrl = /**
     * @return {?}
     */
    function () {
        return this.loginConfigService.getLogoutUrl();
    };
    /**
     * @return {?}
     */
    LoginService.prototype.getTitle = /**
     * @return {?}
     */
    function () {
        return this.loginConfigService.getTitle();
    };
    /*
      Check if we already have a token and see if it is still valid.
      This is used to prevent the login screen from being presented
      to the user when they restart the app.
     */
    /*
          Check if we already have a token and see if it is still valid.
          This is used to prevent the login screen from being presented
          to the user when they restart the app.
         */
    /**
     * @return {?}
     */
    LoginService.prototype.checkLogin = /*
          Check if we already have a token and see if it is still valid.
          This is used to prevent the login screen from being presented
          to the user when they restart the app.
         */
    /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.tokenService.token$.pipe(first()).subscribe(function (token) {
            if (!token) {
                _this.login$.next(null);
                _this.clearLocalUser();
            }
            else {
                /** @type {?} */
                var decodedToken = _this.jwtHelper.decodeToken(token);
                if (!decodedToken) {
                    console.log('Invalid token received from server!');
                    _this.clearLocalUser();
                    _this.login$.next(null);
                }
                else {
                    /** @type {?} */
                    var user = new User();
                    user.username = decodedToken['sub'];
                    user.firstname = decodedToken['firstname'];
                    user.lastname = decodedToken['lastname'];
                    user.roles = decodedToken['roles'];
                    user.appid = decodedToken['appid'];
                    /*
                      This is set for the PSG popup window (or other windows like it) so that they can
                      all have access to the current user. This only works if the popup windows
                      all come from the same originating address, so it is quite safe.
                     */
                    _this.storage.set(_this.JWT_USER_NAME, user)
                        .then(function () {
                        console.log('New user [' + _this.getCurrentUser().username + '] added to storage.');
                    });
                    _this.setCurrentUser(user);
                    _this.login$.next(user);
                }
            }
        });
        this.tokenService.checkToken();
    };
    /**
     * @param {?} user
     * @return {?}
     */
    LoginService.prototype.logIn = /**
     * @param {?} user
     * @return {?}
     */
    function (user) {
        user.appid = this.loginConfigService.getAppid();
        this.subAndCheckToken(user, true);
        this.tokenService.getToken(user);
    };
    /**
     * @private
     * @param {?} user
     * @param {?} sendNullResponse
     * @return {?}
     */
    LoginService.prototype.subAndCheckToken = /**
     * @private
     * @param {?} user
     * @param {?} sendNullResponse
     * @return {?}
     */
    function (user, sendNullResponse) {
        var _this = this;
        this.tokenService.token$.pipe(first()).subscribe(function (token) {
            if (!token) {
                // The server thinks the token is not valid (expired, the secret key changed, etc)
                console.log('Invalid token, not logged in.');
                _this.clearLocalUser();
                if (sendNullResponse) {
                    _this.login$.next(null);
                }
            }
            else {
                /** @type {?} */
                var decodedToken = _this.jwtHelper.decodeToken(token);
                if (!decodedToken) {
                    console.log('Invalid token received from server!');
                    _this.setCurrentUser(null);
                    if (sendNullResponse) {
                        _this.login$.next(null);
                    }
                }
                else if (decodedToken['sub'] !== user.username) {
                    console.log('Invalid username in token received from server!');
                    _this.setCurrentUser(null);
                    if (sendNullResponse) {
                        _this.login$.next(null);
                    }
                }
                else {
                    user.firstname = decodedToken['firstname'];
                    user.lastname = decodedToken['lastname'];
                    user.roles = decodedToken['roles'];
                    /*
                      This is set for the PSG popup window (or other windows like it) so that they can
                      all have access to the current user. This only works if the popup windows
                      all come from the same originating address, so it is quite safe.
                     */
                    _this.storage.set(_this.JWT_USER_NAME, user)
                        .then(function () {
                        console.log('New user [' + _this.getCurrentUser().username + '] added to storage.');
                    });
                    _this.setCurrentUser(user);
                    _this.login$.next(user);
                }
            }
        });
    };
    /** Log the user out and return them to the login screen. */
    /**
     * Log the user out and return them to the login screen.
     * @return {?}
     */
    LoginService.prototype.logOut = /**
     * Log the user out and return them to the login screen.
     * @return {?}
     */
    function () {
        if (this.getCurrentUser() && this.getCurrentUser().username) {
            this.http.post(this.loginConfigService.getLogoutUrl(), this.getCurrentUser()).pipe(first()).subscribe(function () {
                console.log('Logged out');
            });
        }
        this.clearLocalUser();
    };
    /**
     * @private
     * @return {?}
     */
    LoginService.prototype.clearLocalUser = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var username = null;
        if (this.getCurrentUser() && this.getCurrentUser().username) {
            username = this.getCurrentUser().username;
        }
        this.setCurrentUser(null);
        this.hideLogin = false;
        this.tokenService.clearToken();
        this.storage.remove(this.JWT_USER_NAME)
            .then(function () {
            if (username) {
                console.log('User [' + username + '] removed from storage');
            }
            else {
                console.log('User removed from storage');
            }
        });
    };
    LoginService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    LoginService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: Storage },
        { type: JwtHelperService },
        { type: LoginConfigService },
        { type: TokenApiService }
    ]; };
    /** @nocollapse */ LoginService.ngInjectableDef = i0.defineInjectable({ factory: function LoginService_Factory() { return new LoginService(i0.inject(i1.HttpClient), i0.inject(i2.Storage), i0.inject(i3.JwtHelperService), i0.inject(i4.LoginConfigService), i0.inject(i5.TokenApiService)); }, token: LoginService, providedIn: "root" });
    return LoginService;
}());
export { LoginService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.currentUser;
    /** @type {?} */
    LoginService.prototype.login$;
    /** @type {?} */
    LoginService.prototype.hideLogin;
    /** @type {?} */
    LoginService.prototype.JWT_USER_NAME;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.storage;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.jwtHelper;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.loginConfigService;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.tokenService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWxvZ2luLWxpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbG9naW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxlQUFlLEVBQUUsSUFBSSxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDMUQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7QUFFckM7SUFhSSxzQkFDWSxJQUFnQixFQUNoQixPQUFnQixFQUNoQixTQUEyQixFQUMzQixrQkFBc0MsRUFDdEMsWUFBNkI7UUFMekMsaUJBZ0JDO1FBZlcsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixZQUFPLEdBQVAsT0FBTyxDQUFTO1FBQ2hCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsaUJBQVksR0FBWixZQUFZLENBQWlCO1FBYmpDLGdCQUFXLEdBQVMsSUFBSSxDQUFDO1FBRTFCLFdBQU0sR0FBa0IsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUU1QyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBRVIsa0JBQWEsR0FBRyxVQUFVLENBQUM7UUFTdkM7Ozs7VUFJRTtRQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEs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Ozs7SUFFckIsbUNBQWlDOztJQUVqQyw4QkFBbUQ7O0lBRW5ELGlDQUF3Qjs7SUFFeEIscUNBQTJDOzs7OztJQUd2Qyw0QkFBd0I7Ozs7O0lBQ3hCLCtCQUF3Qjs7Ozs7SUFDeEIsaUNBQW1DOzs7OztJQUNuQywwQ0FBOEM7Ozs7O0lBQzlDLG9DQUFxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0h0dHBDbGllbnR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7U3RvcmFnZX0gZnJvbSAnQGlvbmljL3N0b3JhZ2UnO1xuaW1wb3J0IHtKd3RIZWxwZXJTZXJ2aWNlfSBmcm9tICdAYXV0aDAvYW5ndWxhci1qd3QnO1xuaW1wb3J0IHtUb2tlbkFwaVNlcnZpY2UsIFVzZXJ9IGZyb20gJ25nLWNvbW1vbi1saWJyYXJ5JztcbmltcG9ydCB7TG9naW5Db25maWdTZXJ2aWNlfSBmcm9tICcuL2xvZ2luLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7U3ViamVjdH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2ZpcnN0fSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTG9naW5TZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgY3VycmVudFVzZXI6IFVzZXIgPSBudWxsO1xuXG4gICAgcHVibGljIGxvZ2luJDogU3ViamVjdDxVc2VyPiA9IG5ldyBTdWJqZWN0PFVzZXI+KCk7XG5cbiAgICBwdWJsaWMgaGlkZUxvZ2luID0gdHJ1ZTtcblxuICAgIHB1YmxpYyByZWFkb25seSBKV1RfVVNFUl9OQU1FID0gJ2p3dF91c2VyJztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZTogU3RvcmFnZSxcbiAgICAgICAgcHJpdmF0ZSBqd3RIZWxwZXI6IEp3dEhlbHBlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgbG9naW5Db25maWdTZXJ2aWNlOiBMb2dpbkNvbmZpZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdG9rZW5TZXJ2aWNlOiBUb2tlbkFwaVNlcnZpY2UpIHtcblxuICAgICAgICAvKlxuICAgICAgICAgIENoZWNrIGlmIGEgdXNlciBpcyBhbHJlYWR5IHN0b3JlZFxuICAgICAgICAgIFRoaXMgaXMgZm9yIHdoZW4gY2hpbGQgd2luZG93cyAoaWUuIFBTRylcbiAgICAgICAgICBhcmUgYmVpbmcgb3BlbmVkLlxuICAgICAgICAqL1xuICAgICAgICBzdG9yYWdlLmdldCh0aGlzLkpXVF9VU0VSX05BTUUpXG4gICAgICAgICAgICAudGhlbigodXNlcjogVXNlcikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudFVzZXIodXNlcik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q3VycmVudFVzZXIoKTogVXNlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRVc2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDdXJyZW50VXNlcih1c2VyOiBVc2VyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY3VycmVudFVzZXIgPSB1c2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb2dvU3JjKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luQ29uZmlnU2VydmljZS5nZXRMb2dvU3JjKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldExvZ2luQXBpVXJsKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luQ29uZmlnU2VydmljZS5nZXRMb2dpbkFwaVVybCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb2dpbklwVXJsKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luQ29uZmlnU2VydmljZS5nZXRMb2dpbklwVXJsKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldExvZ2luVXJsKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luQ29uZmlnU2VydmljZS5nZXRMb2dpblVybCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb2dvdXRVcmwoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9naW5Db25maWdTZXJ2aWNlLmdldExvZ291dFVybCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRUaXRsZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dpbkNvbmZpZ1NlcnZpY2UuZ2V0VGl0bGUoKTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAgQ2hlY2sgaWYgd2UgYWxyZWFkeSBoYXZlIGEgdG9rZW4gYW5kIHNlZSBpZiBpdCBpcyBzdGlsbCB2YWxpZC5cbiAgICAgIFRoaXMgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBsb2dpbiBzY3JlZW4gZnJvbSBiZWluZyBwcmVzZW50ZWRcbiAgICAgIHRvIHRoZSB1c2VyIHdoZW4gdGhleSByZXN0YXJ0IHRoZSBhcHAuXG4gICAgICovXG4gICAgcHVibGljIGNoZWNrTG9naW4oKSB7XG4gICAgICAgIHRoaXMudG9rZW5TZXJ2aWNlLnRva2VuJC5waXBlKGZpcnN0KCkpLnN1YnNjcmliZSgodG9rZW46IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICAgICAgICAgIHRoaXMubG9naW4kLm5leHQobnVsbCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhckxvY2FsVXNlcigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZWNvZGVkVG9rZW4gPSB0aGlzLmp3dEhlbHBlci5kZWNvZGVUb2tlbih0b2tlbik7XG4gICAgICAgICAgICAgICAgaWYgKCFkZWNvZGVkVG9rZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ludmFsaWQgdG9rZW4gcmVjZWl2ZWQgZnJvbSBzZXJ2ZXIhJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJMb2NhbFVzZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbiQubmV4dChudWxsKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gbmV3IFVzZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgdXNlci51c2VybmFtZSA9IGRlY29kZWRUb2tlblsnc3ViJ107XG4gICAgICAgICAgICAgICAgICAgIHVzZXIuZmlyc3RuYW1lID0gZGVjb2RlZFRva2VuWydmaXJzdG5hbWUnXTtcbiAgICAgICAgICAgICAgICAgICAgdXNlci5sYXN0bmFtZSA9IGRlY29kZWRUb2tlblsnbGFzdG5hbWUnXTtcbiAgICAgICAgICAgICAgICAgICAgdXNlci5yb2xlcyA9IGRlY29kZWRUb2tlblsncm9sZXMnXTtcbiAgICAgICAgICAgICAgICAgICAgdXNlci5hcHBpZCA9IGRlY29kZWRUb2tlblsnYXBwaWQnXTtcbiAgICAgICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgICAgICBUaGlzIGlzIHNldCBmb3IgdGhlIFBTRyBwb3B1cCB3aW5kb3cgKG9yIG90aGVyIHdpbmRvd3MgbGlrZSBpdCkgc28gdGhhdCB0aGV5IGNhblxuICAgICAgICAgICAgICAgICAgICAgIGFsbCBoYXZlIGFjY2VzcyB0byB0aGUgY3VycmVudCB1c2VyLiBUaGlzIG9ubHkgd29ya3MgaWYgdGhlIHBvcHVwIHdpbmRvd3NcbiAgICAgICAgICAgICAgICAgICAgICBhbGwgY29tZSBmcm9tIHRoZSBzYW1lIG9yaWdpbmF0aW5nIGFkZHJlc3MsIHNvIGl0IGlzIHF1aXRlIHNhZmUuXG4gICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KHRoaXMuSldUX1VTRVJfTkFNRSwgdXNlcilcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ05ldyB1c2VyIFsnICsgdGhpcy5nZXRDdXJyZW50VXNlcigpLnVzZXJuYW1lICsgJ10gYWRkZWQgdG8gc3RvcmFnZS4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRVc2VyKHVzZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2luJC5uZXh0KHVzZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudG9rZW5TZXJ2aWNlLmNoZWNrVG9rZW4oKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9nSW4odXNlcjogVXNlcikge1xuICAgICAgICB1c2VyLmFwcGlkID0gdGhpcy5sb2dpbkNvbmZpZ1NlcnZpY2UuZ2V0QXBwaWQoKTtcbiAgICAgICAgdGhpcy5zdWJBbmRDaGVja1Rva2VuKHVzZXIsIHRydWUpO1xuICAgICAgICB0aGlzLnRva2VuU2VydmljZS5nZXRUb2tlbih1c2VyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN1YkFuZENoZWNrVG9rZW4odXNlcjogVXNlciwgc2VuZE51bGxSZXNwb25zZTogYm9vbGVhbikge1xuICAgICAgICB0aGlzLnRva2VuU2VydmljZS50b2tlbiQucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoKHRva2VuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgc2VydmVyIHRoaW5rcyB0aGUgdG9rZW4gaXMgbm90IHZhbGlkIChleHBpcmVkLCB0aGUgc2VjcmV0IGtleSBjaGFuZ2VkLCBldGMpXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ludmFsaWQgdG9rZW4sIG5vdCBsb2dnZWQgaW4uJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhckxvY2FsVXNlcigpO1xuICAgICAgICAgICAgICAgIGlmIChzZW5kTnVsbFJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9naW4kLm5leHQobnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZWNvZGVkVG9rZW4gPSB0aGlzLmp3dEhlbHBlci5kZWNvZGVUb2tlbih0b2tlbik7XG4gICAgICAgICAgICAgICAgaWYgKCFkZWNvZGVkVG9rZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ludmFsaWQgdG9rZW4gcmVjZWl2ZWQgZnJvbSBzZXJ2ZXIhJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudFVzZXIobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZW5kTnVsbFJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2luJC5uZXh0KG51bGwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkZWNvZGVkVG9rZW5bJ3N1YiddICE9PSB1c2VyLnVzZXJuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIHVzZXJuYW1lIGluIHRva2VuIHJlY2VpdmVkIGZyb20gc2VydmVyIScpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRVc2VyKG51bGwpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VuZE51bGxSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbiQubmV4dChudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXIuZmlyc3RuYW1lID0gZGVjb2RlZFRva2VuWydmaXJzdG5hbWUnXTtcbiAgICAgICAgICAgICAgICAgICAgdXNlci5sYXN0bmFtZSA9IGRlY29kZWRUb2tlblsnbGFzdG5hbWUnXTtcbiAgICAgICAgICAgICAgICAgICAgdXNlci5yb2xlcyA9IGRlY29kZWRUb2tlblsncm9sZXMnXTtcbiAgICAgICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgICAgICBUaGlzIGlzIHNldCBmb3IgdGhlIFBTRyBwb3B1cCB3aW5kb3cgKG9yIG90aGVyIHdpbmRvd3MgbGlrZSBpdCkgc28gdGhhdCB0aGV5IGNhblxuICAgICAgICAgICAgICAgICAgICAgIGFsbCBoYXZlIGFjY2VzcyB0byB0aGUgY3VycmVudCB1c2VyLiBUaGlzIG9ubHkgd29ya3MgaWYgdGhlIHBvcHVwIHdpbmRvd3NcbiAgICAgICAgICAgICAgICAgICAgICBhbGwgY29tZSBmcm9tIHRoZSBzYW1lIG9yaWdpbmF0aW5nIGFkZHJlc3MsIHNvIGl0IGlzIHF1aXRlIHNhZmUuXG4gICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KHRoaXMuSldUX1VTRVJfTkFNRSwgdXNlcilcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ05ldyB1c2VyIFsnICsgdGhpcy5nZXRDdXJyZW50VXNlcigpLnVzZXJuYW1lICsgJ10gYWRkZWQgdG8gc3RvcmFnZS4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRVc2VyKHVzZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2luJC5uZXh0KHVzZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqIExvZyB0aGUgdXNlciBvdXQgYW5kIHJldHVybiB0aGVtIHRvIHRoZSBsb2dpbiBzY3JlZW4uICovXG4gICAgcHVibGljIGxvZ091dCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZ2V0Q3VycmVudFVzZXIoKSAmJiB0aGlzLmdldEN1cnJlbnRVc2VyKCkudXNlcm5hbWUpIHtcbiAgICAgICAgICAgIHRoaXMuaHR0cC5wb3N0KHRoaXMubG9naW5Db25maWdTZXJ2aWNlLmdldExvZ291dFVybCgpLCB0aGlzLmdldEN1cnJlbnRVc2VyKCkpLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnTG9nZ2VkIG91dCcpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbGVhckxvY2FsVXNlcigpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJMb2NhbFVzZXIoKSB7XG4gICAgICAgIGxldCB1c2VybmFtZSA9IG51bGw7XG4gICAgICAgIGlmICh0aGlzLmdldEN1cnJlbnRVc2VyKCkgJiYgdGhpcy5nZXRDdXJyZW50VXNlcigpLnVzZXJuYW1lKSB7XG4gICAgICAgICAgICB1c2VybmFtZSA9IHRoaXMuZ2V0Q3VycmVudFVzZXIoKS51c2VybmFtZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldEN1cnJlbnRVc2VyKG51bGwpO1xuICAgICAgICB0aGlzLmhpZGVMb2dpbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLnRva2VuU2VydmljZS5jbGVhclRva2VuKCk7XG4gICAgICAgIHRoaXMuc3RvcmFnZS5yZW1vdmUodGhpcy5KV1RfVVNFUl9OQU1FKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh1c2VybmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVXNlciBbJyArIHVzZXJuYW1lICsgJ10gcmVtb3ZlZCBmcm9tIHN0b3JhZ2UnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVXNlciByZW1vdmVkIGZyb20gc3RvcmFnZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==