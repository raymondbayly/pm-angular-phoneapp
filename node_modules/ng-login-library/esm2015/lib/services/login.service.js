/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Storage } from '@ionic/storage';
import { JwtHelperService } from '@auth0/angular-jwt';
import { TokenApiService, User } from 'ng-common-library';
import { LoginConfigService } from './login-config.service';
import { Subject } from 'rxjs';
import { first } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@ionic/storage";
import * as i3 from "@auth0/angular-jwt/src/jwthelper.service";
import * as i4 from "./login-config.service";
import * as i5 from "ng-common-library";
export class LoginService {
    /**
     * @param {?} http
     * @param {?} storage
     * @param {?} jwtHelper
     * @param {?} loginConfigService
     * @param {?} tokenService
     */
    constructor(http, storage, jwtHelper, loginConfigService, tokenService) {
        this.http = http;
        this.storage = storage;
        this.jwtHelper = jwtHelper;
        this.loginConfigService = loginConfigService;
        this.tokenService = tokenService;
        this.currentUser = null;
        this.login$ = new Subject();
        this.hideLogin = true;
        this.JWT_USER_NAME = 'jwt_user';
        /*
          Check if a user is already stored
          This is for when child windows (ie. PSG)
          are being opened.
        */
        storage.get(this.JWT_USER_NAME)
            .then((user) => {
            this.setCurrentUser(user);
        });
    }
    /**
     * @return {?}
     */
    getCurrentUser() {
        return this.currentUser;
    }
    /**
     * @param {?} user
     * @return {?}
     */
    setCurrentUser(user) {
        this.currentUser = user;
    }
    /**
     * @return {?}
     */
    getLogoSrc() {
        return this.loginConfigService.getLogoSrc();
    }
    /**
     * @return {?}
     */
    getLoginApiUrl() {
        return this.loginConfigService.getLoginApiUrl();
    }
    /**
     * @return {?}
     */
    getLoginIpUrl() {
        return this.loginConfigService.getLoginIpUrl();
    }
    /**
     * @return {?}
     */
    getLoginUrl() {
        return this.loginConfigService.getLoginUrl();
    }
    /**
     * @return {?}
     */
    getLogoutUrl() {
        return this.loginConfigService.getLogoutUrl();
    }
    /**
     * @return {?}
     */
    getTitle() {
        return this.loginConfigService.getTitle();
    }
    /*
          Check if we already have a token and see if it is still valid.
          This is used to prevent the login screen from being presented
          to the user when they restart the app.
         */
    /**
     * @return {?}
     */
    checkLogin() {
        this.tokenService.token$.pipe(first()).subscribe((token) => {
            if (!token) {
                this.login$.next(null);
                this.clearLocalUser();
            }
            else {
                /** @type {?} */
                const decodedToken = this.jwtHelper.decodeToken(token);
                if (!decodedToken) {
                    console.log('Invalid token received from server!');
                    this.clearLocalUser();
                    this.login$.next(null);
                }
                else {
                    /** @type {?} */
                    const user = new User();
                    user.username = decodedToken['sub'];
                    user.firstname = decodedToken['firstname'];
                    user.lastname = decodedToken['lastname'];
                    user.roles = decodedToken['roles'];
                    user.appid = decodedToken['appid'];
                    /*
                      This is set for the PSG popup window (or other windows like it) so that they can
                      all have access to the current user. This only works if the popup windows
                      all come from the same originating address, so it is quite safe.
                     */
                    this.storage.set(this.JWT_USER_NAME, user)
                        .then(() => {
                        console.log('New user [' + this.getCurrentUser().username + '] added to storage.');
                    });
                    this.setCurrentUser(user);
                    this.login$.next(user);
                }
            }
        });
        this.tokenService.checkToken();
    }
    /**
     * @param {?} user
     * @return {?}
     */
    logIn(user) {
        user.appid = this.loginConfigService.getAppid();
        this.subAndCheckToken(user, true);
        this.tokenService.getToken(user);
    }
    /**
     * @private
     * @param {?} user
     * @param {?} sendNullResponse
     * @return {?}
     */
    subAndCheckToken(user, sendNullResponse) {
        this.tokenService.token$.pipe(first()).subscribe((token) => {
            if (!token) {
                // The server thinks the token is not valid (expired, the secret key changed, etc)
                console.log('Invalid token, not logged in.');
                this.clearLocalUser();
                if (sendNullResponse) {
                    this.login$.next(null);
                }
            }
            else {
                /** @type {?} */
                const decodedToken = this.jwtHelper.decodeToken(token);
                if (!decodedToken) {
                    console.log('Invalid token received from server!');
                    this.setCurrentUser(null);
                    if (sendNullResponse) {
                        this.login$.next(null);
                    }
                }
                else if (decodedToken['sub'] !== user.username) {
                    console.log('Invalid username in token received from server!');
                    this.setCurrentUser(null);
                    if (sendNullResponse) {
                        this.login$.next(null);
                    }
                }
                else {
                    user.firstname = decodedToken['firstname'];
                    user.lastname = decodedToken['lastname'];
                    user.roles = decodedToken['roles'];
                    /*
                      This is set for the PSG popup window (or other windows like it) so that they can
                      all have access to the current user. This only works if the popup windows
                      all come from the same originating address, so it is quite safe.
                     */
                    this.storage.set(this.JWT_USER_NAME, user)
                        .then(() => {
                        console.log('New user [' + this.getCurrentUser().username + '] added to storage.');
                    });
                    this.setCurrentUser(user);
                    this.login$.next(user);
                }
            }
        });
    }
    /**
     * Log the user out and return them to the login screen.
     * @return {?}
     */
    logOut() {
        if (this.getCurrentUser() && this.getCurrentUser().username) {
            this.http.post(this.loginConfigService.getLogoutUrl(), this.getCurrentUser()).pipe(first()).subscribe(() => {
                console.log('Logged out');
            });
        }
        this.clearLocalUser();
    }
    /**
     * @private
     * @return {?}
     */
    clearLocalUser() {
        /** @type {?} */
        let username = null;
        if (this.getCurrentUser() && this.getCurrentUser().username) {
            username = this.getCurrentUser().username;
        }
        this.setCurrentUser(null);
        this.hideLogin = false;
        this.tokenService.clearToken();
        this.storage.remove(this.JWT_USER_NAME)
            .then(() => {
            if (username) {
                console.log('User [' + username + '] removed from storage');
            }
            else {
                console.log('User removed from storage');
            }
        });
    }
}
LoginService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
LoginService.ctorParameters = () => [
    { type: HttpClient },
    { type: Storage },
    { type: JwtHelperService },
    { type: LoginConfigService },
    { type: TokenApiService }
];
/** @nocollapse */ LoginService.ngInjectableDef = i0.defineInjectable({ factory: function LoginService_Factory() { return new LoginService(i0.inject(i1.HttpClient), i0.inject(i2.Storage), i0.inject(i3.JwtHelperService), i0.inject(i4.LoginConfigService), i0.inject(i5.TokenApiService)); }, token: LoginService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.currentUser;
    /** @type {?} */
    LoginService.prototype.login$;
    /** @type {?} */
    LoginService.prototype.hideLogin;
    /** @type {?} */
    LoginService.prototype.JWT_USER_NAME;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.storage;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.jwtHelper;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.loginConfigService;
    /**
     * @type {?}
     * @private
     */
    LoginService.prototype.tokenService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWxvZ2luLWxpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbG9naW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxlQUFlLEVBQUUsSUFBSSxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDMUQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7QUFLckMsTUFBTSxPQUFPLFlBQVk7Ozs7Ozs7O0lBVXJCLFlBQ1ksSUFBZ0IsRUFDaEIsT0FBZ0IsRUFDaEIsU0FBMkIsRUFDM0Isa0JBQXNDLEVBQ3RDLFlBQTZCO1FBSjdCLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGlCQUFZLEdBQVosWUFBWSxDQUFpQjtRQWJqQyxnQkFBVyxHQUFTLElBQUksQ0FBQztRQUUxQixXQUFNLEdBQWtCLElBQUksT0FBTyxFQUFRLENBQUM7UUFFNUMsY0FBUyxHQUFHLElBQUksQ0FBQztRQUVSLGtCQUFhLEdBQUcsVUFBVSxDQUFDO1FBU3ZDOzs7O1VBSUU7UUFDRixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUks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Q0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1N0b3JhZ2V9IGZyb20gJ0Bpb25pYy9zdG9yYWdlJztcbmltcG9ydCB7Snd0SGVscGVyU2VydmljZX0gZnJvbSAnQGF1dGgwL2FuZ3VsYXItand0JztcbmltcG9ydCB7VG9rZW5BcGlTZXJ2aWNlLCBVc2VyfSBmcm9tICduZy1jb21tb24tbGlicmFyeSc7XG5pbXBvcnQge0xvZ2luQ29uZmlnU2VydmljZX0gZnJvbSAnLi9sb2dpbi1jb25maWcuc2VydmljZSc7XG5pbXBvcnQge1N1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmaXJzdH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIExvZ2luU2VydmljZSB7XG5cbiAgICBwcml2YXRlIGN1cnJlbnRVc2VyOiBVc2VyID0gbnVsbDtcblxuICAgIHB1YmxpYyBsb2dpbiQ6IFN1YmplY3Q8VXNlcj4gPSBuZXcgU3ViamVjdDxVc2VyPigpO1xuXG4gICAgcHVibGljIGhpZGVMb2dpbiA9IHRydWU7XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgSldUX1VTRVJfTkFNRSA9ICdqd3RfdXNlcic7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgICAgICBwcml2YXRlIHN0b3JhZ2U6IFN0b3JhZ2UsXG4gICAgICAgIHByaXZhdGUgand0SGVscGVyOiBKd3RIZWxwZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvZ2luQ29uZmlnU2VydmljZTogTG9naW5Db25maWdTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHRva2VuU2VydmljZTogVG9rZW5BcGlTZXJ2aWNlKSB7XG5cbiAgICAgICAgLypcbiAgICAgICAgICBDaGVjayBpZiBhIHVzZXIgaXMgYWxyZWFkeSBzdG9yZWRcbiAgICAgICAgICBUaGlzIGlzIGZvciB3aGVuIGNoaWxkIHdpbmRvd3MgKGllLiBQU0cpXG4gICAgICAgICAgYXJlIGJlaW5nIG9wZW5lZC5cbiAgICAgICAgKi9cbiAgICAgICAgc3RvcmFnZS5nZXQodGhpcy5KV1RfVVNFUl9OQU1FKVxuICAgICAgICAgICAgLnRoZW4oKHVzZXI6IFVzZXIpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRVc2VyKHVzZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEN1cnJlbnRVc2VyKCk6IFVzZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VXNlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0Q3VycmVudFVzZXIodXNlcjogVXNlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmN1cnJlbnRVc2VyID0gdXNlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TG9nb1NyYygpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dpbkNvbmZpZ1NlcnZpY2UuZ2V0TG9nb1NyYygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb2dpbkFwaVVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dpbkNvbmZpZ1NlcnZpY2UuZ2V0TG9naW5BcGlVcmwoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TG9naW5JcFVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dpbkNvbmZpZ1NlcnZpY2UuZ2V0TG9naW5JcFVybCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRMb2dpblVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dpbkNvbmZpZ1NlcnZpY2UuZ2V0TG9naW5VcmwoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TG9nb3V0VXJsKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luQ29uZmlnU2VydmljZS5nZXRMb2dvdXRVcmwoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0VGl0bGUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9naW5Db25maWdTZXJ2aWNlLmdldFRpdGxlKCk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgIENoZWNrIGlmIHdlIGFscmVhZHkgaGF2ZSBhIHRva2VuIGFuZCBzZWUgaWYgaXQgaXMgc3RpbGwgdmFsaWQuXG4gICAgICBUaGlzIGlzIHVzZWQgdG8gcHJldmVudCB0aGUgbG9naW4gc2NyZWVuIGZyb20gYmVpbmcgcHJlc2VudGVkXG4gICAgICB0byB0aGUgdXNlciB3aGVuIHRoZXkgcmVzdGFydCB0aGUgYXBwLlxuICAgICAqL1xuICAgIHB1YmxpYyBjaGVja0xvZ2luKCkge1xuICAgICAgICB0aGlzLnRva2VuU2VydmljZS50b2tlbiQucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoKHRva2VuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2luJC5uZXh0KG51bGwpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJMb2NhbFVzZXIoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVjb2RlZFRva2VuID0gdGhpcy5qd3RIZWxwZXIuZGVjb2RlVG9rZW4odG9rZW4pO1xuICAgICAgICAgICAgICAgIGlmICghZGVjb2RlZFRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIHRva2VuIHJlY2VpdmVkIGZyb20gc2VydmVyIScpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyTG9jYWxVc2VyKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9naW4kLm5leHQobnVsbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKCk7XG4gICAgICAgICAgICAgICAgICAgIHVzZXIudXNlcm5hbWUgPSBkZWNvZGVkVG9rZW5bJ3N1YiddO1xuICAgICAgICAgICAgICAgICAgICB1c2VyLmZpcnN0bmFtZSA9IGRlY29kZWRUb2tlblsnZmlyc3RuYW1lJ107XG4gICAgICAgICAgICAgICAgICAgIHVzZXIubGFzdG5hbWUgPSBkZWNvZGVkVG9rZW5bJ2xhc3RuYW1lJ107XG4gICAgICAgICAgICAgICAgICAgIHVzZXIucm9sZXMgPSBkZWNvZGVkVG9rZW5bJ3JvbGVzJ107XG4gICAgICAgICAgICAgICAgICAgIHVzZXIuYXBwaWQgPSBkZWNvZGVkVG9rZW5bJ2FwcGlkJ107XG4gICAgICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgICAgICAgVGhpcyBpcyBzZXQgZm9yIHRoZSBQU0cgcG9wdXAgd2luZG93IChvciBvdGhlciB3aW5kb3dzIGxpa2UgaXQpIHNvIHRoYXQgdGhleSBjYW5cbiAgICAgICAgICAgICAgICAgICAgICBhbGwgaGF2ZSBhY2Nlc3MgdG8gdGhlIGN1cnJlbnQgdXNlci4gVGhpcyBvbmx5IHdvcmtzIGlmIHRoZSBwb3B1cCB3aW5kb3dzXG4gICAgICAgICAgICAgICAgICAgICAgYWxsIGNvbWUgZnJvbSB0aGUgc2FtZSBvcmlnaW5hdGluZyBhZGRyZXNzLCBzbyBpdCBpcyBxdWl0ZSBzYWZlLlxuICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yYWdlLnNldCh0aGlzLkpXVF9VU0VSX05BTUUsIHVzZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdOZXcgdXNlciBbJyArIHRoaXMuZ2V0Q3VycmVudFVzZXIoKS51c2VybmFtZSArICddIGFkZGVkIHRvIHN0b3JhZ2UuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDdXJyZW50VXNlcih1c2VyKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbiQubmV4dCh1c2VyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRva2VuU2VydmljZS5jaGVja1Rva2VuKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvZ0luKHVzZXI6IFVzZXIpIHtcbiAgICAgICAgdXNlci5hcHBpZCA9IHRoaXMubG9naW5Db25maWdTZXJ2aWNlLmdldEFwcGlkKCk7XG4gICAgICAgIHRoaXMuc3ViQW5kQ2hlY2tUb2tlbih1c2VyLCB0cnVlKTtcbiAgICAgICAgdGhpcy50b2tlblNlcnZpY2UuZ2V0VG9rZW4odXNlcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJBbmRDaGVja1Rva2VuKHVzZXI6IFVzZXIsIHNlbmROdWxsUmVzcG9uc2U6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy50b2tlblNlcnZpY2UudG9rZW4kLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKCh0b2tlbjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIHNlcnZlciB0aGlua3MgdGhlIHRva2VuIGlzIG5vdCB2YWxpZCAoZXhwaXJlZCwgdGhlIHNlY3JldCBrZXkgY2hhbmdlZCwgZXRjKVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIHRva2VuLCBub3QgbG9nZ2VkIGluLicpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJMb2NhbFVzZXIoKTtcbiAgICAgICAgICAgICAgICBpZiAoc2VuZE51bGxSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2luJC5uZXh0KG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVjb2RlZFRva2VuID0gdGhpcy5qd3RIZWxwZXIuZGVjb2RlVG9rZW4odG9rZW4pO1xuICAgICAgICAgICAgICAgIGlmICghZGVjb2RlZFRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIHRva2VuIHJlY2VpdmVkIGZyb20gc2VydmVyIScpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRVc2VyKG51bGwpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VuZE51bGxSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbiQubmV4dChudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVjb2RlZFRva2VuWydzdWInXSAhPT0gdXNlci51c2VybmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnSW52YWxpZCB1c2VybmFtZSBpbiB0b2tlbiByZWNlaXZlZCBmcm9tIHNlcnZlciEnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDdXJyZW50VXNlcihudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbmROdWxsUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9naW4kLm5leHQobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB1c2VyLmZpcnN0bmFtZSA9IGRlY29kZWRUb2tlblsnZmlyc3RuYW1lJ107XG4gICAgICAgICAgICAgICAgICAgIHVzZXIubGFzdG5hbWUgPSBkZWNvZGVkVG9rZW5bJ2xhc3RuYW1lJ107XG4gICAgICAgICAgICAgICAgICAgIHVzZXIucm9sZXMgPSBkZWNvZGVkVG9rZW5bJ3JvbGVzJ107XG4gICAgICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgICAgICAgVGhpcyBpcyBzZXQgZm9yIHRoZSBQU0cgcG9wdXAgd2luZG93IChvciBvdGhlciB3aW5kb3dzIGxpa2UgaXQpIHNvIHRoYXQgdGhleSBjYW5cbiAgICAgICAgICAgICAgICAgICAgICBhbGwgaGF2ZSBhY2Nlc3MgdG8gdGhlIGN1cnJlbnQgdXNlci4gVGhpcyBvbmx5IHdvcmtzIGlmIHRoZSBwb3B1cCB3aW5kb3dzXG4gICAgICAgICAgICAgICAgICAgICAgYWxsIGNvbWUgZnJvbSB0aGUgc2FtZSBvcmlnaW5hdGluZyBhZGRyZXNzLCBzbyBpdCBpcyBxdWl0ZSBzYWZlLlxuICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yYWdlLnNldCh0aGlzLkpXVF9VU0VSX05BTUUsIHVzZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdOZXcgdXNlciBbJyArIHRoaXMuZ2V0Q3VycmVudFVzZXIoKS51c2VybmFtZSArICddIGFkZGVkIHRvIHN0b3JhZ2UuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDdXJyZW50VXNlcih1c2VyKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dpbiQubmV4dCh1c2VyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKiBMb2cgdGhlIHVzZXIgb3V0IGFuZCByZXR1cm4gdGhlbSB0byB0aGUgbG9naW4gc2NyZWVuLiAqL1xuICAgIHB1YmxpYyBsb2dPdXQoKSB7XG4gICAgICAgIGlmICh0aGlzLmdldEN1cnJlbnRVc2VyKCkgJiYgdGhpcy5nZXRDdXJyZW50VXNlcigpLnVzZXJuYW1lKSB7XG4gICAgICAgICAgICB0aGlzLmh0dHAucG9zdCh0aGlzLmxvZ2luQ29uZmlnU2VydmljZS5nZXRMb2dvdXRVcmwoKSwgdGhpcy5nZXRDdXJyZW50VXNlcigpKS5waXBlKGZpcnN0KCkpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0xvZ2dlZCBvdXQnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2xlYXJMb2NhbFVzZXIoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsZWFyTG9jYWxVc2VyKCkge1xuICAgICAgICBsZXQgdXNlcm5hbWUgPSBudWxsO1xuICAgICAgICBpZiAodGhpcy5nZXRDdXJyZW50VXNlcigpICYmIHRoaXMuZ2V0Q3VycmVudFVzZXIoKS51c2VybmFtZSkge1xuICAgICAgICAgICAgdXNlcm5hbWUgPSB0aGlzLmdldEN1cnJlbnRVc2VyKCkudXNlcm5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRDdXJyZW50VXNlcihudWxsKTtcbiAgICAgICAgdGhpcy5oaWRlTG9naW4gPSBmYWxzZTtcbiAgICAgICAgdGhpcy50b2tlblNlcnZpY2UuY2xlYXJUb2tlbigpO1xuICAgICAgICB0aGlzLnN0b3JhZ2UucmVtb3ZlKHRoaXMuSldUX1VTRVJfTkFNRSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodXNlcm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgWycgKyB1c2VybmFtZSArICddIHJlbW92ZWQgZnJvbSBzdG9yYWdlJyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgcmVtb3ZlZCBmcm9tIHN0b3JhZ2UnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=