/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { LocationsConfigService } from '../config/locations-config.service';
import { Subject } from 'rxjs';
import { map } from 'rxjs/operators';
import { Locations } from '../../../model/Locations';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../config/locations-config.service";
var LocationsApiService = /** @class */ (function () {
    function LocationsApiService(http, locationsConfigService) {
        this.http = http;
        this.locationsConfigService = locationsConfigService;
        this.locations = new Locations();
        this.facilitiesAndUnit$ = new Subject();
    }
    /**
     * Updates facilities and units and calls the facilitiesAndUnitSubject when it completes.
     * Will use a cache if they were previously retrieved.
     * @return {?}
     */
    LocationsApiService.prototype.getFacilitiesAndUnits = /**
     * Updates facilities and units and calls the facilitiesAndUnitSubject when it completes.
     * Will use a cache if they were previously retrieved.
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.locations.facilities && this.locations.facilities.length > 0 && this.locations.units && this.locations.units.length > 0) {
            this.facilitiesAndUnit$.next(this.locations);
        }
        else {
            /** Receive all facilities and active units and set instance variables for caching */
            this.facilitySubscription = this.getActiveFacilities().pipe(map(function (f) { return f.facilities; })).subscribe(function (facilities) {
                if (facilities && facilities.length > 0) {
                    /** @type {?} */
                    var facilityIds = [];
                    try {
                        for (var facilities_1 = tslib_1.__values(facilities), facilities_1_1 = facilities_1.next(); !facilities_1_1.done; facilities_1_1 = facilities_1.next()) {
                            var facility = facilities_1_1.value;
                            facilityIds.push(facility.facilityID);
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (facilities_1_1 && !facilities_1_1.done && (_a = facilities_1.return)) _a.call(facilities_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                    _this.unitSubscription = _this.getActiveUnitsForFacilities(facilityIds).pipe((map(function (u) { return u.units; }))).subscribe(function (units) {
                        // filter out facilities with no active units
                        // filter out facilities with no active units
                        _this.locations = new Locations();
                        try {
                            for (var facilities_2 = tslib_1.__values(facilities), facilities_2_1 = facilities_2.next(); !facilities_2_1.done; facilities_2_1 = facilities_2.next()) {
                                var f = facilities_2_1.value;
                                /** @type {?} */
                                var hasActiveUnits = false;
                                try {
                                    for (var units_1 = tslib_1.__values(units), units_1_1 = units_1.next(); !units_1_1.done; units_1_1 = units_1.next()) {
                                        var u = units_1_1.value;
                                        if (u.key.facilityID === f.facilityID) {
                                            hasActiveUnits = true;
                                            break;
                                        }
                                    }
                                }
                                catch (e_2_1) { e_2 = { error: e_2_1 }; }
                                finally {
                                    try {
                                        if (units_1_1 && !units_1_1.done && (_a = units_1.return)) _a.call(units_1);
                                    }
                                    finally { if (e_2) throw e_2.error; }
                                }
                                if (hasActiveUnits) {
                                    _this.locations.facilities.push(f);
                                }
                            }
                        }
                        catch (e_3_1) { e_3 = { error: e_3_1 }; }
                        finally {
                            try {
                                if (facilities_2_1 && !facilities_2_1.done && (_b = facilities_2.return)) _b.call(facilities_2);
                            }
                            finally { if (e_3) throw e_3.error; }
                        }
                        _this.locations.units = units;
                        _this.facilitiesAndUnit$.next(_this.locations);
                        var e_3, _b, e_2, _a;
                    }, function (e) {
                        console.log('Could not update units! Error = ' + e.message);
                    });
                }
                var e_1, _a;
            }, function (e) {
                console.log('Could not update facilities! Error = ' + e.message);
            });
        }
    };
    /**
     * @return {?}
     */
    LocationsApiService.prototype.getActiveFacilities = /**
     * @return {?}
     */
    function () {
        console.log('Getting all facilities: ' + this.locationsConfigService.getActiveFacilitiesEndpoint());
        return this.http.get(this.locationsConfigService.getActiveFacilitiesEndpoint());
    };
    /**
     * @param {?} facilities
     * @return {?}
     */
    LocationsApiService.prototype.getActiveUnitsForFacilities = /**
     * @param {?} facilities
     * @return {?}
     */
    function (facilities) {
        console.log('Getting all active units: ' + this.locationsConfigService.getActiveUnitsEndpoint() + facilities);
        return this.http.get(this.locationsConfigService.getActiveUnitsEndpoint() + facilities);
    };
    /**
     * @return {?}
     */
    LocationsApiService.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.facilitySubscription && !this.facilitySubscription.closed) {
            this.facilitySubscription.unsubscribe();
        }
        if (this.unitSubscription && !this.unitSubscription.closed) {
            this.unitSubscription.unsubscribe();
        }
    };
    LocationsApiService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    LocationsApiService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: LocationsConfigService }
    ]; };
    /** @nocollapse */ LocationsApiService.ngInjectableDef = i0.defineInjectable({ factory: function LocationsApiService_Factory() { return new LocationsApiService(i0.inject(i1.HttpClient), i0.inject(i2.LocationsConfigService)); }, token: LocationsApiService, providedIn: "root" });
    return LocationsApiService;
}());
export { LocationsApiService };
if (false) {
    /** @type {?} */
    LocationsApiService.prototype.facilitySubscription;
    /** @type {?} */
    LocationsApiService.prototype.unitSubscription;
    /** @type {?} */
    LocationsApiService.prototype.facilitiesAndUnit$;
    /** @type {?} */
    LocationsApiService.prototype.locations;
    /** @type {?} */
    LocationsApiService.prototype.http;
    /** @type {?} */
    LocationsApiService.prototype.locationsConfigService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRpb25zLWFwaS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctY29tbW9uLWxpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9sb2NhdGlvbnMvYXBpL2xvY2F0aW9ucy1hcGkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQVksTUFBTSxlQUFlLENBQUM7QUFHcEQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBQzFFLE9BQU8sRUFBYSxPQUFPLEVBQWUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7SUFjakQsNkJBQ1UsTUFDQTtRQURBLFNBQUksR0FBSixJQUFJO1FBQ0osMkJBQXNCLEdBQXRCLHNCQUFzQjt5QkFKRCxJQUFJLFNBQVMsRUFBRTtRQUs1QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQTZDLENBQUM7S0FDcEY7Ozs7OztJQU1NLG1EQUFxQjs7Ozs7OztRQUMxQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQzlDO1FBQUMsSUFBSSxDQUFDLENBQUM7O1lBRU4sSUFBSSxDQUFDLG9CQUFv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QXNCLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxVQUFVLENBQUMsQ0FBQztLQUNqSDs7OztJQUVELHlDQUFXOzs7SUFBWDtRQUNFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ25FLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUN6QztRQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNyQztLQUNGOztnQkE3RUYsVUFBVSxTQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7OztnQkFSTyxVQUFVO2dCQUNWLHNCQUFzQjs7OzhCQUo5Qjs7U0FZYSxtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGUsIE9uRGVzdHJveX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1VuaXR9IGZyb20gJy4uLy4uLy4uL21vZGVsL1VuaXQnO1xuaW1wb3J0IHtGYWNpbGl0eX0gZnJvbSAnLi4vLi4vLi4vbW9kZWwvRmFjaWxpdHknO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0xvY2F0aW9uc0NvbmZpZ1NlcnZpY2V9IGZyb20gJy4uL2NvbmZpZy9sb2NhdGlvbnMtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7TG9jYXRpb25zfSBmcm9tICcuLi8uLi8uLi9tb2RlbC9Mb2NhdGlvbnMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBMb2NhdGlvbnNBcGlTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuICBwcml2YXRlIGZhY2lsaXR5U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgdW5pdFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIHB1YmxpYyByZWFkb25seSBmYWNpbGl0aWVzQW5kVW5pdCQ6IFN1YmplY3Q8eyBmYWNpbGl0aWVzOiBGYWNpbGl0eVtdLCB1bml0czogVW5pdFtdIH0+O1xuXG4gIHByaXZhdGUgbG9jYXRpb25zOiBMb2NhdGlvbnMgPSBuZXcgTG9jYXRpb25zKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgbG9jYXRpb25zQ29uZmlnU2VydmljZTogTG9jYXRpb25zQ29uZmlnU2VydmljZSkge1xuICAgIHRoaXMuZmFjaWxpdGllc0FuZFVuaXQkID0gbmV3IFN1YmplY3Q8eyBmYWNpbGl0aWVzOiBGYWNpbGl0eVtdLCB1bml0czogVW5pdFtdIH0+KCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyBmYWNpbGl0aWVzIGFuZCB1bml0cyBhbmQgY2FsbHMgdGhlIGZhY2lsaXRpZXNBbmRVbml0U3ViamVjdCB3aGVuIGl0IGNvbXBsZXRlcy5cbiAgICogV2lsbCB1c2UgYSBjYWNoZSBpZiB0aGV5IHdlcmUgcHJldmlvdXNseSByZXRyaWV2ZWQuXG4gICAqL1xuICBwdWJsaWMgZ2V0RmFjaWxpdGllc0FuZFVuaXRzKCkge1xuICAgIGlmICh0aGlzLmxvY2F0aW9ucy5mYWNpbGl0aWVzICYmIHRoaXMubG9jYXRpb25zLmZhY2lsaXRpZXMubGVuZ3RoID4gMCAmJiB0aGlzLmxvY2F0aW9ucy51bml0cyAmJiB0aGlzLmxvY2F0aW9ucy51bml0cy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmZhY2lsaXRpZXNBbmRVbml0JC5uZXh0KHRoaXMubG9jYXRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLyoqIFJlY2VpdmUgYWxsIGZhY2lsaXRpZXMgYW5kIGFjdGl2ZSB1bml0cyBhbmQgc2V0IGluc3RhbmNlIHZhcmlhYmxlcyBmb3IgY2FjaGluZyAqL1xuICAgICAgdGhpcy5mYWNpbGl0eVN1YnNjcmlwdGlvbiA9IHRoaXMuZ2V0QWN0aXZlRmFjaWxpdGllcygpLnBpcGUobWFwKChmKSA9PiBmLmZhY2lsaXRpZXMpKS5zdWJzY3JpYmUoKGZhY2lsaXRpZXM6IEZhY2lsaXR5W10pID0+IHtcbiAgICAgICAgaWYgKGZhY2lsaXRpZXMgJiYgZmFjaWxpdGllcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgZmFjaWxpdHlJZHM6IFN0cmluZ1tdID0gW107XG4gICAgICAgICAgZm9yIChjb25zdCBmYWNpbGl0eSBvZiBmYWNpbGl0aWVzKSB7XG4gICAgICAgICAgICBmYWNpbGl0eUlkcy5wdXNoKGZhY2lsaXR5LmZhY2lsaXR5SUQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnVuaXRTdWJzY3JpcHRpb24gPSB0aGlzLmdldEFjdGl2ZVVuaXRzRm9yRmFjaWxpdGllcyhmYWNpbGl0eUlkcykucGlwZSgobWFwKCh1KSA9PiB1LnVuaXRzKSkpLnN1YnNjcmliZSgodW5pdHM6IFVuaXRbXSkgPT4ge1xuICAgICAgICAgICAgLy8gZmlsdGVyIG91dCBmYWNpbGl0aWVzIHdpdGggbm8gYWN0aXZlIHVuaXRzXG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IG5ldyBMb2NhdGlvbnMoKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZiBvZiBmYWNpbGl0aWVzKSB7XG4gICAgICAgICAgICAgIGxldCBoYXNBY3RpdmVVbml0cyA9IGZhbHNlO1xuICAgICAgICAgICAgICBmb3IgKGNvbnN0IHUgb2YgdW5pdHMpIHtcbiAgICAgICAgICAgICAgICBpZiAodS5rZXkuZmFjaWxpdHlJRCA9PT0gZi5mYWNpbGl0eUlEKSB7XG4gICAgICAgICAgICAgICAgICBoYXNBY3RpdmVVbml0cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKGhhc0FjdGl2ZVVuaXRzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMuZmFjaWxpdGllcy5wdXNoKGYpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9ucy51bml0cyA9IHVuaXRzO1xuICAgICAgICAgICAgdGhpcy5mYWNpbGl0aWVzQW5kVW5pdCQubmV4dCh0aGlzLmxvY2F0aW9ucyk7XG4gICAgICAgICAgfSwgKGUpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDb3VsZCBub3QgdXBkYXRlIHVuaXRzISBFcnJvciA9ICcgKyBlLm1lc3NhZ2UpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LCAoZSkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnQ291bGQgbm90IHVwZGF0ZSBmYWNpbGl0aWVzISBFcnJvciA9ICcgKyBlLm1lc3NhZ2UpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QWN0aXZlRmFjaWxpdGllcygpOiBPYnNlcnZhYmxlPHsgZmFjaWxpdGllczogQXJyYXk8RmFjaWxpdHk+IH0+IHtcbiAgICBjb25zb2xlLmxvZygnR2V0dGluZyBhbGwgZmFjaWxpdGllczogJyArIHRoaXMubG9jYXRpb25zQ29uZmlnU2VydmljZS5nZXRBY3RpdmVGYWNpbGl0aWVzRW5kcG9pbnQoKSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8eyBmYWNpbGl0aWVzOiBBcnJheTxGYWNpbGl0eT4gfT4odGhpcy5sb2NhdGlvbnNDb25maWdTZXJ2aWNlLmdldEFjdGl2ZUZhY2lsaXRpZXNFbmRwb2ludCgpKTtcbiAgfVxuXG4gIGdldEFjdGl2ZVVuaXRzRm9yRmFjaWxpdGllcyhmYWNpbGl0aWVzOiBTdHJpbmdbXSk6IE9ic2VydmFibGU8eyB1bml0czogQXJyYXk8VW5pdD4gfT4ge1xuICAgIGNvbnNvbGUubG9nKCdHZXR0aW5nIGFsbCBhY3RpdmUgdW5pdHM6ICcgKyB0aGlzLmxvY2F0aW9uc0NvbmZpZ1NlcnZpY2UuZ2V0QWN0aXZlVW5pdHNFbmRwb2ludCgpICsgZmFjaWxpdGllcyk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8eyB1bml0czogQXJyYXk8VW5pdD4gfT4odGhpcy5sb2NhdGlvbnNDb25maWdTZXJ2aWNlLmdldEFjdGl2ZVVuaXRzRW5kcG9pbnQoKSArIGZhY2lsaXRpZXMpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZmFjaWxpdHlTdWJzY3JpcHRpb24gJiYgIXRoaXMuZmFjaWxpdHlTdWJzY3JpcHRpb24uY2xvc2VkKSB7XG4gICAgICB0aGlzLmZhY2lsaXR5U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnVuaXRTdWJzY3JpcHRpb24gJiYgIXRoaXMudW5pdFN1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIHRoaXMudW5pdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxufVxuIl19