/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { of, Subject, timer } from 'rxjs';
import { TokenApiService } from '../../token/api/token-api.service';
import { PatientAccess } from '../../../model/PatientAccess';
import { UsageType } from '../../../model/UsageType';
import { JwtHelperService } from '@auth0/angular-jwt';
import { UsageConfigService } from '../config/usage-config.service';
import { first, map, tap } from 'rxjs/operators';
import * as moment_ from 'moment-timezone';
import { LocationsApiService } from '../../locations/api/locations-api.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@auth0/angular-jwt/src/jwthelper.service";
import * as i3 from "../config/usage-config.service";
import * as i4 from "../../locations/api/locations-api.service";
import * as i5 from "../../token/api/token-api.service";
/** @type {?} */
var moment = moment_;
var UsageApiService = /** @class */ (function () {
    // The token service is necessary to get the appId
    function UsageApiService(http, jwtHelper, usageConfigService, locationService, tokenApiService) {
        this.http = http;
        this.jwtHelper = jwtHelper;
        this.usageConfigService = usageConfigService;
        this.locationService = locationService;
        this.tokenApiService = tokenApiService;
        this.usageData = new Array();
        this.viewedVisits = [];
        this.initialized = false;
        this.locationsLoaded$ = new Subject();
        this.locationsLoaded = false;
        this.startedLoadingLocations = false;
        this.graphUpdated$ = new Subject();
        this.usageDataAdded$ = new Subject();
    }
    /**
     * @return {?}
     */
    UsageApiService.prototype.init = /**
     * @return {?}
     */
    function () {
        if (!this.initialized) {
            this.initialized = true;
        }
    };
    /**
     * @return {?}
     */
    UsageApiService.prototype.startUsageReportingService = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.pollInstance$ = timer(0, this.usageConfigService.getUsagePollingInterval());
        this.pollInstance$.subscribe(function () {
            if (_this.usageData && _this.usageData.length > 0) {
                _this.submitUsageData();
            }
        });
        if (this.usageData && this.usageData.length > 0) {
            // Submit now in case the user closes the window before the timer fires
            this.submitUsageData();
        }
        // get all the locations when the service is initialized
        this.locationService.facilitiesAndUnit$.pipe(first()).subscribe(function (locations) {
            _this.locations = locations;
            _this.locationsLoaded = true;
            _this.locationsLoaded$.next(true);
        });
        this.locationService.getFacilitiesAndUnits();
    };
    /**
     * @return {?}
     */
    UsageApiService.prototype.submitUsageData = /**
     * @return {?}
     */
    function () {
        console.log('Submitting usage data for app ' + this.tokenApiService.getAppId() + ' Size = ' + this.usageData.length);
        /** @type {?} */
        var usageDataCopy = this.usageData.slice();
        this.usageData = [];
        this.http.post(this.usageConfigService.getUsageDataEndPoint(), usageDataCopy).pipe(first()).subscribe();
    };
    /**
     * When the user logs out of the system, we need to clear the cache
     * so that the graph views are sent if they log in again.
     * @return {?}
     */
    UsageApiService.prototype.clearUsageCache = /**
     * When the user logs out of the system, we need to clear the cache
     * so that the graph views are sent if they log in again.
     * @return {?}
     */
    function () {
        this.viewedVisits = [];
    };
    /**
     * Add usage data.
     * @param {?} graphToLog The information that was viewed.
     * @param {?} usageType The context in which the information was viewed.
     * @return {?}
     */
    UsageApiService.prototype.addUsageData = /**
     * Add usage data.
     * @param {?} graphToLog The information that was viewed.
     * @param {?} usageType The context in which the information was viewed.
     * @return {?}
     */
    function (graphToLog, usageType) {
        var _this = this;
        // We have to replace the facility and unit IDs with the real deals
        this.updateFacilityAndUnitIdsForGraph(graphToLog).pipe(first(), tap(function (graph) {
            _this.tokenApiService.token$.pipe(first()).subscribe(function (token) {
                if (usageType === UsageType.Array) {
                    // Only log 1 graph view per session when viewed in the array view
                    if (graph && _this.viewedVisits.indexOf(graph.vnm) < 0) {
                        // We only log 1 visit view of a specific type per session
                        // We only log 1 visit view of a specific type per session
                        _this.viewedVisits.push(graph.vnm);
                        _this.addUsageDataFromToken(graph, usageType, token);
                    }
                }
                else {
                    // Always add graph views because the user clicked on a graph in the array view
                    // Always add graph views because the user clicked on a graph in the array view
                    _this.addUsageDataFromToken(graph, usageType, token);
                }
            });
            _this.tokenApiService.getExistingToken();
        })).subscribe();
        if (!this.locationsLoaded && !this.startedLoadingLocations) {
            this.startedLoadingLocations = true;
            this.locationService.getFacilitiesAndUnits();
        }
    };
    /**
     * lookup and insert the unit id and fac id of graph to log
     * @param {?} graph - graph to log
     * @return {?}
     */
    UsageApiService.prototype.updateFacilityAndUnitIdsForGraph = /**
     * lookup and insert the unit id and fac id of graph to log
     * @param {?} graph - graph to log
     * @return {?}
     */
    function (graph) {
        var _this = this;
        /** @type {?} */
        var cloneGraph = JSON.parse(JSON.stringify(graph));
        if (this.locationsLoaded === true) {
            return of(UsageApiService.assignUnitAndFacIdToPeraGraph(cloneGraph, this.locations));
        }
        else {
            return this.locationsLoaded$.pipe(map(function () {
                return UsageApiService.assignUnitAndFacIdToPeraGraph(cloneGraph, _this.locations);
            }));
        }
    };
    /**
     * helper method for looking up fac and unit ids
     * @param {?} graph - graph to replace unitId and facId of
     * @param {?} locations - all locations available to search
     * @return {?}
     */
    UsageApiService.assignUnitAndFacIdToPeraGraph = /**
     * helper method for looking up fac and unit ids
     * @param {?} graph - graph to replace unitId and facId of
     * @param {?} locations - all locations available to search
     * @return {?}
     */
    function (graph, locations) {
        try {
            for (var _a = tslib_1.__values(locations.facilities), _b = _a.next(); !_b.done; _b = _a.next()) {
                var fac = _b.value;
                if (graph.facilityId === fac.displayName) {
                    graph.facilityId = fac.facilityID;
                    break;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_1) throw e_1.error; }
        }
        try {
            for (var _d = tslib_1.__values(locations.units), _e = _d.next(); !_e.done; _e = _d.next()) {
                var unit = _e.value;
                if (graph.unitId === unit.displayName) {
                    graph.unitId = unit.key.unitID;
                    break;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_e && !_e.done && (_f = _d.return)) _f.call(_d);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return graph;
        var e_1, _c, e_2, _f;
    };
    /**
     * @param {?} graph
     * @param {?} usageType
     * @param {?} token
     * @return {?}
     */
    UsageApiService.prototype.addUsageDataFromToken = /**
     * @param {?} graph
     * @param {?} usageType
     * @param {?} token
     * @return {?}
     */
    function (graph, usageType, token) {
        /** @type {?} */
        var decodedToken = this.jwtHelper.decodeToken(token);
        if (decodedToken) {
            /** @type {?} */
            var pa = new PatientAccess(decodedToken['sub'], // The claims subject is the username
            // The claims subject is the username
            graph.patient.lname + ', ' + graph.patient.fname, graph.vipIndicator, graph.vnm, graph.patient.medicalRecordNumber, graph.admitDate, graph.dischargeDate, graph.facilityId, graph.unitId, graph.attendingProvider.lastName + ', ' + graph.attendingProvider.firstName, graph.visitUnitType, usageType, moment.valueOf());
            this.usageData.push(pa);
            // This can be used for testing and for the timing of individual calls to submitUsageData()
            this.usageDataAdded$.next(pa);
        }
    };
    UsageApiService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    UsageApiService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: JwtHelperService },
        { type: UsageConfigService },
        { type: LocationsApiService },
        { type: TokenApiService }
    ]; };
    /** @nocollapse */ UsageApiService.ngInjectableDef = i0.defineInjectable({ factory: function UsageApiService_Factory() { return new UsageApiService(i0.inject(i1.HttpClient), i0.inject(i2.JwtHelperService), i0.inject(i3.UsageConfigService), i0.inject(i4.LocationsApiService), i0.inject(i5.TokenApiService)); }, token: UsageApiService, providedIn: "root" });
    return UsageApiService;
}());
export { UsageApiService };
if (false) {
    /** @type {?} */
    UsageApiService.prototype.usageDataAdded$;
    /** @type {?} */
    UsageApiService.prototype.pollInstance$;
    /** @type {?} */
    UsageApiService.prototype.graphUpdated$;
    /** @type {?} */
    UsageApiService.prototype.usageData;
    /** @type {?} */
    UsageApiService.prototype.viewedVisits;
    /** @type {?} */
    UsageApiService.prototype.initialized;
    /** @type {?} */
    UsageApiService.prototype.locations;
    /** @type {?} */
    UsageApiService.prototype.locationsLoaded$;
    /** @type {?} */
    UsageApiService.prototype.locationsLoaded;
    /** @type {?} */
    UsageApiService.prototype.startedLoadingLocations;
    /** @type {?} */
    UsageApiService.prototype.http;
    /** @type {?} */
    UsageApiService.prototype.jwtHelper;
    /** @type {?} */
    UsageApiService.prototype.usageConfigService;
    /** @type {?} */
    UsageApiService.prototype.locationService;
    /** @type {?} */
    UsageApiService.prototype.tokenApiService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNhZ2UtYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1jb21tb24tbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL3VzYWdlL2FwaS91c2FnZS1hcGkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBOEIsRUFBRSxFQUFFLE9BQU8sRUFBZ0IsS0FBSyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ25GLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxtQ0FBbUMsQ0FBQztBQUNsRSxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sOEJBQThCLENBQUM7QUFDM0QsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBRW5ELE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBQ2xFLE9BQU8sRUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQy9DLE9BQU8sS0FBSyxPQUFPLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sMkNBQTJDLENBQUM7Ozs7Ozs7O0FBSzlFLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQzs7SUFtQm5CLGtEQUFrRDtJQUNsRCx5QkFBb0IsSUFBZ0IsRUFDaEIsV0FDQSxvQkFDQSxpQkFDQTtRQUpBLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsY0FBUyxHQUFULFNBQVM7UUFDVCx1QkFBa0IsR0FBbEIsa0JBQWtCO1FBQ2xCLG9CQUFlLEdBQWYsZUFBZTtRQUNmLG9CQUFlLEdBQWYsZUFBZTt5QkFkTyxJQUFJLEtB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S0FBSyxHQUFHLElBQUksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFDaEQsS0FBSyxDQUFDLFlBQVksRUFDbEIsS0FBSyxDQUFDLEdBQUcsRUFDVCxLQUFLLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUNqQyxLQUFLLENBQUMsU0FBUyxFQUNmLEtBQUssQ0FBQyxhQUFhLEVBQ25CLEtBQUssQ0FBQyxVQUFVLEVBQ2hCLEtBQUssQ0FBQyxNQUFNLEVBQ1osS0FBSyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsS0FBSyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFDM0UsS0FBSyxDQUFDLGFBQWEsRUFDbkIsU0FBUyxFQUNULE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FDbkIsQ0FBQztZQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztZQUV4QixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNqQzs7O2dCQTdKUixVQUFVLFNBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCOzs7O2dCQW5CTyxVQUFVO2dCQU1WLGdCQUFnQjtnQkFDaEIsa0JBQWtCO2dCQUdsQixtQkFBbUI7Z0JBUm5CLGVBQWU7OzswQkFIdkI7O1NBcUJhLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiwgdGltZXJ9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtUb2tlbkFwaVNlcnZpY2V9IGZyb20gJy4uLy4uL3Rva2VuL2FwaS90b2tlbi1hcGkuc2VydmljZSc7XG5pbXBvcnQge1BhdGllbnRBY2Nlc3N9IGZyb20gJy4uLy4uLy4uL21vZGVsL1BhdGllbnRBY2Nlc3MnO1xuaW1wb3J0IHtVc2FnZVR5cGV9IGZyb20gJy4uLy4uLy4uL21vZGVsL1VzYWdlVHlwZSc7XG5pbXBvcnQge1BlcmFHcmFwaH0gZnJvbSAnLi4vLi4vLi4vbW9kZWwvUGVyYUdyYXBoJztcbmltcG9ydCB7Snd0SGVscGVyU2VydmljZX0gZnJvbSAnQGF1dGgwL2FuZ3VsYXItand0JztcbmltcG9ydCB7VXNhZ2VDb25maWdTZXJ2aWNlfSBmcm9tICcuLi9jb25maWcvdXNhZ2UtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtmaXJzdCwgbWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAqIGFzIG1vbWVudF8gZnJvbSAnbW9tZW50LXRpbWV6b25lJztcbmltcG9ydCB7TG9jYXRpb25zQXBpU2VydmljZX0gZnJvbSAnLi4vLi4vbG9jYXRpb25zL2FwaS9sb2NhdGlvbnMtYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHtMb2NhdGlvbnN9IGZyb20gXCIuLi8uLi8uLi9tb2RlbC9Mb2NhdGlvbnNcIjtcblxuLy8gVGhlIEphdmFTY3JpcHQgY29tcGlsZXIgZ2l2ZXMgYSB3ZWlyZCBcIm1vbWVudCBjYW5ub3QgYmUgdXNlZCBhcyBhIG5hbWVzcGFjZVwiIHR5cGUgb2YgZXJyb3Jcbi8vIFRoaXMgaXMgdGhlIHdvcmthcm91bmQuLi5cbmNvbnN0IG1vbWVudCA9IG1vbWVudF87XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVXNhZ2VBcGlTZXJ2aWNlIHtcblxuICAgIHB1YmxpYyB1c2FnZURhdGFBZGRlZCQ6IFN1YmplY3Q8UGF0aWVudEFjY2Vzcz47XG4gICAgcHJpdmF0ZSBwb2xsSW5zdGFuY2UkOiBPYnNlcnZhYmxlPGFueT47XG4gICAgcHJpdmF0ZSByZWFkb25seSBncmFwaFVwZGF0ZWQkOiBTdWJqZWN0PFBlcmFHcmFwaD47XG4gICAgcHJpdmF0ZSB1c2FnZURhdGE6IEFycmF5PFBhdGllbnRBY2Nlc3M+ID0gbmV3IEFycmF5PFBhdGllbnRBY2Nlc3M+KCk7XG4gICAgLy8gVmlzaXRzIHRoYXQgaGF2ZSBiZWVuIHZpZXdlZCBpbiB0aGUgYXJyYXkgdmlldyBhcmUgb25seSBhZGRlZCB0byB1c2FnZURhdGEgb25jZSBwZXIgc2Vzc2lvblxuICAgIHByaXZhdGUgdmlld2VkVmlzaXRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIGxvY2F0aW9uczogTG9jYXRpb25zO1xuICAgIHByaXZhdGUgbG9jYXRpb25zTG9hZGVkJDogU3ViamVjdDxib29sZWFuPiA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG4gICAgcHJpdmF0ZSBsb2NhdGlvbnNMb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwcml2YXRlIHN0YXJ0ZWRMb2FkaW5nTG9jYXRpb25zID0gZmFsc2U7XG5cbiAgICAvLyBUaGUgdG9rZW4gc2VydmljZSBpcyBuZWNlc3NhcnkgdG8gZ2V0IHRoZSBhcHBJZFxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGp3dEhlbHBlcjogSnd0SGVscGVyU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHVzYWdlQ29uZmlnU2VydmljZTogVXNhZ2VDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgbG9jYXRpb25TZXJ2aWNlOiBMb2NhdGlvbnNBcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdG9rZW5BcGlTZXJ2aWNlOiBUb2tlbkFwaVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5ncmFwaFVwZGF0ZWQkID0gbmV3IFN1YmplY3Q8UGVyYUdyYXBoPigpO1xuICAgICAgICB0aGlzLnVzYWdlRGF0YUFkZGVkJCA9IG5ldyBTdWJqZWN0PFBhdGllbnRBY2Nlc3M+KCk7XG4gICAgfVxuXG4gICAgcHVibGljIGluaXQoKSB7XG4gICAgICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhcnRVc2FnZVJlcG9ydGluZ1NlcnZpY2UoKTogdm9pZCB7XG4gICAgICAgIHRoaXMucG9sbEluc3RhbmNlJCA9IHRpbWVyKDAsIHRoaXMudXNhZ2VDb25maWdTZXJ2aWNlLmdldFVzYWdlUG9sbGluZ0ludGVydmFsKCkpO1xuICAgICAgICB0aGlzLnBvbGxJbnN0YW5jZSQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLnVzYWdlRGF0YSAmJiB0aGlzLnVzYWdlRGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdWJtaXRVc2FnZURhdGEoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh0aGlzLnVzYWdlRGF0YSAmJiB0aGlzLnVzYWdlRGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAvLyBTdWJtaXQgbm93IGluIGNhc2UgdGhlIHVzZXIgY2xvc2VzIHRoZSB3aW5kb3cgYmVmb3JlIHRoZSB0aW1lciBmaXJlc1xuICAgICAgICAgICAgdGhpcy5zdWJtaXRVc2FnZURhdGEoKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBnZXQgYWxsIHRoZSBsb2NhdGlvbnMgd2hlbiB0aGUgc2VydmljZSBpcyBpbml0aWFsaXplZFxuICAgICAgICB0aGlzLmxvY2F0aW9uU2VydmljZS5mYWNpbGl0aWVzQW5kVW5pdCQucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoKGxvY2F0aW9uczogTG9jYXRpb25zKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9ucyA9IGxvY2F0aW9ucztcbiAgICAgICAgICAgIHRoaXMubG9jYXRpb25zTG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubG9jYXRpb25zTG9hZGVkJC5uZXh0KHRydWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sb2NhdGlvblNlcnZpY2UuZ2V0RmFjaWxpdGllc0FuZFVuaXRzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHN1Ym1pdFVzYWdlRGF0YSgpOiB2b2lkIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1N1Ym1pdHRpbmcgdXNhZ2UgZGF0YSBmb3IgYXBwICcgKyB0aGlzLnRva2VuQXBpU2VydmljZS5nZXRBcHBJZCgpICsgJyBTaXplID0gJyArIHRoaXMudXNhZ2VEYXRhLmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IHVzYWdlRGF0YUNvcHkgPSB0aGlzLnVzYWdlRGF0YS5zbGljZSgpO1xuICAgICAgICB0aGlzLnVzYWdlRGF0YSA9IFtdO1xuICAgICAgICB0aGlzLmh0dHAucG9zdCh0aGlzLnVzYWdlQ29uZmlnU2VydmljZS5nZXRVc2FnZURhdGFFbmRQb2ludCgpLCB1c2FnZURhdGFDb3B5KS5waXBlKGZpcnN0KCkpLnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdoZW4gdGhlIHVzZXIgbG9ncyBvdXQgb2YgdGhlIHN5c3RlbSwgd2UgbmVlZCB0byBjbGVhciB0aGUgY2FjaGVcbiAgICAgKiBzbyB0aGF0IHRoZSBncmFwaCB2aWV3cyBhcmUgc2VudCBpZiB0aGV5IGxvZyBpbiBhZ2Fpbi5cbiAgICAgKi9cbiAgICBwdWJsaWMgY2xlYXJVc2FnZUNhY2hlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnZpZXdlZFZpc2l0cyA9IFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCB1c2FnZSBkYXRhLlxuICAgICAqIEBwYXJhbSBncmFwaFRvTG9nIFRoZSBpbmZvcm1hdGlvbiB0aGF0IHdhcyB2aWV3ZWQuXG4gICAgICogQHBhcmFtIHVzYWdlVHlwZSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgaW5mb3JtYXRpb24gd2FzIHZpZXdlZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgYWRkVXNhZ2VEYXRhKGdyYXBoVG9Mb2c6IFBlcmFHcmFwaCwgdXNhZ2VUeXBlOiBVc2FnZVR5cGUpOiB2b2lkIHtcbiAgICAgICAgLy8gV2UgaGF2ZSB0byByZXBsYWNlIHRoZSBmYWNpbGl0eSBhbmQgdW5pdCBJRHMgd2l0aCB0aGUgcmVhbCBkZWFsc1xuICAgICAgICB0aGlzLnVwZGF0ZUZhY2lsaXR5QW5kVW5pdElkc0ZvckdyYXBoKGdyYXBoVG9Mb2cpLnBpcGUoZmlyc3QoKSwgdGFwKChncmFwaDogUGVyYUdyYXBoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnRva2VuQXBpU2VydmljZS50b2tlbiQucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoKHRva2VuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodXNhZ2VUeXBlID09PSBVc2FnZVR5cGUuQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gT25seSBsb2cgMSBncmFwaCB2aWV3IHBlciBzZXNzaW9uIHdoZW4gdmlld2VkIGluIHRoZSBhcnJheSB2aWV3XG4gICAgICAgICAgICAgICAgICAgIGlmIChncmFwaCAmJiB0aGlzLnZpZXdlZFZpc2l0cy5pbmRleE9mKGdyYXBoLnZubSkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBvbmx5IGxvZyAxIHZpc2l0IHZpZXcgb2YgYSBzcGVjaWZpYyB0eXBlIHBlciBzZXNzaW9uXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdlZFZpc2l0cy5wdXNoKGdyYXBoLnZubSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFVzYWdlRGF0YUZyb21Ub2tlbihncmFwaCwgdXNhZ2VUeXBlLCB0b2tlbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBBbHdheXMgYWRkIGdyYXBoIHZpZXdzIGJlY2F1c2UgdGhlIHVzZXIgY2xpY2tlZCBvbiBhIGdyYXBoIGluIHRoZSBhcnJheSB2aWV3XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkVXNhZ2VEYXRhRnJvbVRva2VuKGdyYXBoLCB1c2FnZVR5cGUsIHRva2VuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMudG9rZW5BcGlTZXJ2aWNlLmdldEV4aXN0aW5nVG9rZW4oKTtcbiAgICAgICAgfSkpLnN1YnNjcmliZSgpO1xuICAgICAgICBpZiAoIXRoaXMubG9jYXRpb25zTG9hZGVkICYmICF0aGlzLnN0YXJ0ZWRMb2FkaW5nTG9jYXRpb25zKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0ZWRMb2FkaW5nTG9jYXRpb25zID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubG9jYXRpb25TZXJ2aWNlLmdldEZhY2lsaXRpZXNBbmRVbml0cygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogbG9va3VwIGFuZCBpbnNlcnQgdGhlIHVuaXQgaWQgYW5kIGZhYyBpZCBvZiBncmFwaCB0byBsb2dcbiAgICAgKiBAcGFyYW0gZ3JhcGggLSBncmFwaCB0byBsb2dcbiAgICAgKi9cbiAgICBwcml2YXRlIHVwZGF0ZUZhY2lsaXR5QW5kVW5pdElkc0ZvckdyYXBoKGdyYXBoOiBQZXJhR3JhcGgpOiBPYnNlcnZhYmxlPFBlcmFHcmFwaD4ge1xuICAgICAgICAvLyBDcmVhdGUgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgZ3JhcGggc2luY2Ugd2UgYXJlIHVwZGF0aW5nIHRoZSBmYWNpbGl0eSBhbmQgdW5pdFxuICAgICAgICAvLyB0byB0aGVpciBvcmlnaW5hbCBJRHMgZm9yIFVzYWdlLlxuICAgICAgICBjb25zdCBjbG9uZUdyYXBoOiBQZXJhR3JhcGggPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGdyYXBoKSk7XG4gICAgICAgIGlmICh0aGlzLmxvY2F0aW9uc0xvYWRlZCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIG9mKFVzYWdlQXBpU2VydmljZS5hc3NpZ25Vbml0QW5kRmFjSWRUb1BlcmFHcmFwaChjbG9uZUdyYXBoLCB0aGlzLmxvY2F0aW9ucykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb25zTG9hZGVkJC5waXBlKG1hcCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFVzYWdlQXBpU2VydmljZS5hc3NpZ25Vbml0QW5kRmFjSWRUb1BlcmFHcmFwaChjbG9uZUdyYXBoLCB0aGlzLmxvY2F0aW9ucyk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBoZWxwZXIgbWV0aG9kIGZvciBsb29raW5nIHVwIGZhYyBhbmQgdW5pdCBpZHNcbiAgICAgKiBAcGFyYW0gZ3JhcGggLSBncmFwaCB0byByZXBsYWNlIHVuaXRJZCBhbmQgZmFjSWQgb2ZcbiAgICAgKiBAcGFyYW0gbG9jYXRpb25zIC0gYWxsIGxvY2F0aW9ucyBhdmFpbGFibGUgdG8gc2VhcmNoXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgYXNzaWduVW5pdEFuZEZhY0lkVG9QZXJhR3JhcGgoZ3JhcGg6IFBlcmFHcmFwaCwgbG9jYXRpb25zOiBMb2NhdGlvbnMpOiBQZXJhR3JhcGgge1xuICAgICAgICBmb3IgKGNvbnN0IGZhYyBvZiBsb2NhdGlvbnMuZmFjaWxpdGllcykge1xuICAgICAgICAgICAgaWYgKGdyYXBoLmZhY2lsaXR5SWQgPT09IGZhYy5kaXNwbGF5TmFtZSkge1xuICAgICAgICAgICAgICAgIGdyYXBoLmZhY2lsaXR5SWQgPSBmYWMuZmFjaWxpdHlJRDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IHVuaXQgb2YgbG9jYXRpb25zLnVuaXRzKSB7XG4gICAgICAgICAgICBpZiAoZ3JhcGgudW5pdElkID09PSB1bml0LmRpc3BsYXlOYW1lKSB7XG4gICAgICAgICAgICAgICAgZ3JhcGgudW5pdElkID0gdW5pdC5rZXkudW5pdElEO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBncmFwaDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZFVzYWdlRGF0YUZyb21Ub2tlbihncmFwaDogUGVyYUdyYXBoLCB1c2FnZVR5cGU6IFVzYWdlVHlwZSwgdG9rZW46IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBkZWNvZGVkVG9rZW4gPSB0aGlzLmp3dEhlbHBlci5kZWNvZGVUb2tlbih0b2tlbik7XG4gICAgICAgIGlmIChkZWNvZGVkVG9rZW4pIHtcbiAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gYSB1c2VyIG9iamVjdCB0byBzZW5kIHRvIHRoZSBSRVNUIHNlcnZpY2VcbiAgICAgICAgICAgIGNvbnN0IHBhOiBQYXRpZW50QWNjZXNzID0gbmV3IFBhdGllbnRBY2Nlc3MoXG4gICAgICAgICAgICAgICAgZGVjb2RlZFRva2VuWydzdWInXSwgLy8gVGhlIGNsYWltcyBzdWJqZWN0IGlzIHRoZSB1c2VybmFtZVxuICAgICAgICAgICAgICAgIGdyYXBoLnBhdGllbnQubG5hbWUgKyAnLCAnICsgZ3JhcGgucGF0aWVudC5mbmFtZSxcbiAgICAgICAgICAgICAgICBncmFwaC52aXBJbmRpY2F0b3IsXG4gICAgICAgICAgICAgICAgZ3JhcGgudm5tLFxuICAgICAgICAgICAgICAgIGdyYXBoLnBhdGllbnQubWVkaWNhbFJlY29yZE51bWJlcixcbiAgICAgICAgICAgICAgICBncmFwaC5hZG1pdERhdGUsXG4gICAgICAgICAgICAgICAgZ3JhcGguZGlzY2hhcmdlRGF0ZSxcbiAgICAgICAgICAgICAgICBncmFwaC5mYWNpbGl0eUlkLFxuICAgICAgICAgICAgICAgIGdyYXBoLnVuaXRJZCxcbiAgICAgICAgICAgICAgICBncmFwaC5hdHRlbmRpbmdQcm92aWRlci5sYXN0TmFtZSArICcsICcgKyBncmFwaC5hdHRlbmRpbmdQcm92aWRlci5maXJzdE5hbWUsXG4gICAgICAgICAgICAgICAgZ3JhcGgudmlzaXRVbml0VHlwZSxcbiAgICAgICAgICAgICAgICB1c2FnZVR5cGUsXG4gICAgICAgICAgICAgICAgbW9tZW50LnZhbHVlT2YoKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMudXNhZ2VEYXRhLnB1c2gocGEpO1xuICAgICAgICAgICAgLy8gVGhpcyBjYW4gYmUgdXNlZCBmb3IgdGVzdGluZyBhbmQgZm9yIHRoZSB0aW1pbmcgb2YgaW5kaXZpZHVhbCBjYWxscyB0byBzdWJtaXRVc2FnZURhdGEoKVxuICAgICAgICAgICAgdGhpcy51c2FnZURhdGFBZGRlZCQubmV4dChwYSk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=