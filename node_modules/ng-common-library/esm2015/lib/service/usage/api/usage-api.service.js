/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { of, Subject, timer } from 'rxjs';
import { TokenApiService } from '../../token/api/token-api.service';
import { PatientAccess } from '../../../model/PatientAccess';
import { UsageType } from '../../../model/UsageType';
import { JwtHelperService } from '@auth0/angular-jwt';
import { UsageConfigService } from '../config/usage-config.service';
import { first, map, tap } from 'rxjs/operators';
import * as moment_ from 'moment-timezone';
import { LocationsApiService } from '../../locations/api/locations-api.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@auth0/angular-jwt/src/jwthelper.service";
import * as i3 from "../config/usage-config.service";
import * as i4 from "../../locations/api/locations-api.service";
import * as i5 from "../../token/api/token-api.service";
/** @type {?} */
const moment = moment_;
export class UsageApiService {
    /**
     * @param {?} http
     * @param {?} jwtHelper
     * @param {?} usageConfigService
     * @param {?} locationService
     * @param {?} tokenApiService
     */
    constructor(http, jwtHelper, usageConfigService, locationService, tokenApiService) {
        this.http = http;
        this.jwtHelper = jwtHelper;
        this.usageConfigService = usageConfigService;
        this.locationService = locationService;
        this.tokenApiService = tokenApiService;
        this.usageData = new Array();
        this.viewedVisits = [];
        this.initialized = false;
        this.locationsLoaded$ = new Subject();
        this.locationsLoaded = false;
        this.startedLoadingLocations = false;
        this.graphUpdated$ = new Subject();
        this.usageDataAdded$ = new Subject();
    }
    /**
     * @return {?}
     */
    init() {
        if (!this.initialized) {
            this.initialized = true;
        }
    }
    /**
     * @return {?}
     */
    startUsageReportingService() {
        this.pollInstance$ = timer(0, this.usageConfigService.getUsagePollingInterval());
        this.pollInstance$.subscribe(() => {
            if (this.usageData && this.usageData.length > 0) {
                this.submitUsageData();
            }
        });
        if (this.usageData && this.usageData.length > 0) {
            // Submit now in case the user closes the window before the timer fires
            this.submitUsageData();
        }
        // get all the locations when the service is initialized
        this.locationService.facilitiesAndUnit$.pipe(first()).subscribe((locations) => {
            this.locations = locations;
            this.locationsLoaded = true;
            this.locationsLoaded$.next(true);
        });
        this.locationService.getFacilitiesAndUnits();
    }
    /**
     * @return {?}
     */
    submitUsageData() {
        console.log('Submitting usage data for app ' + this.tokenApiService.getAppId() + ' Size = ' + this.usageData.length);
        /** @type {?} */
        const usageDataCopy = this.usageData.slice();
        this.usageData = [];
        this.http.post(this.usageConfigService.getUsageDataEndPoint(), usageDataCopy).pipe(first()).subscribe();
    }
    /**
     * When the user logs out of the system, we need to clear the cache
     * so that the graph views are sent if they log in again.
     * @return {?}
     */
    clearUsageCache() {
        this.viewedVisits = [];
    }
    /**
     * Add usage data.
     * @param {?} graphToLog The information that was viewed.
     * @param {?} usageType The context in which the information was viewed.
     * @return {?}
     */
    addUsageData(graphToLog, usageType) {
        // We have to replace the facility and unit IDs with the real deals
        this.updateFacilityAndUnitIdsForGraph(graphToLog).pipe(first(), tap((graph) => {
            this.tokenApiService.token$.pipe(first()).subscribe((token) => {
                if (usageType === UsageType.Array) {
                    // Only log 1 graph view per session when viewed in the array view
                    if (graph && this.viewedVisits.indexOf(graph.vnm) < 0) {
                        // We only log 1 visit view of a specific type per session
                        this.viewedVisits.push(graph.vnm);
                        this.addUsageDataFromToken(graph, usageType, token);
                    }
                }
                else {
                    // Always add graph views because the user clicked on a graph in the array view
                    this.addUsageDataFromToken(graph, usageType, token);
                }
            });
            this.tokenApiService.getExistingToken();
        })).subscribe();
        if (!this.locationsLoaded && !this.startedLoadingLocations) {
            this.startedLoadingLocations = true;
            this.locationService.getFacilitiesAndUnits();
        }
    }
    /**
     * lookup and insert the unit id and fac id of graph to log
     * @param {?} graph - graph to log
     * @return {?}
     */
    updateFacilityAndUnitIdsForGraph(graph) {
        /** @type {?} */
        const cloneGraph = JSON.parse(JSON.stringify(graph));
        if (this.locationsLoaded === true) {
            return of(UsageApiService.assignUnitAndFacIdToPeraGraph(cloneGraph, this.locations));
        }
        else {
            return this.locationsLoaded$.pipe(map(() => {
                return UsageApiService.assignUnitAndFacIdToPeraGraph(cloneGraph, this.locations);
            }));
        }
    }
    /**
     * helper method for looking up fac and unit ids
     * @param {?} graph - graph to replace unitId and facId of
     * @param {?} locations - all locations available to search
     * @return {?}
     */
    static assignUnitAndFacIdToPeraGraph(graph, locations) {
        for (const fac of locations.facilities) {
            if (graph.facilityId === fac.displayName) {
                graph.facilityId = fac.facilityID;
                break;
            }
        }
        for (const unit of locations.units) {
            if (graph.unitId === unit.displayName) {
                graph.unitId = unit.key.unitID;
                break;
            }
        }
        return graph;
    }
    /**
     * @param {?} graph
     * @param {?} usageType
     * @param {?} token
     * @return {?}
     */
    addUsageDataFromToken(graph, usageType, token) {
        /** @type {?} */
        const decodedToken = this.jwtHelper.decodeToken(token);
        if (decodedToken) {
            /** @type {?} */
            const pa = new PatientAccess(decodedToken['sub'], // The claims subject is the username
            // The claims subject is the username
            graph.patient.lname + ', ' + graph.patient.fname, graph.vipIndicator, graph.vnm, graph.patient.medicalRecordNumber, graph.admitDate, graph.dischargeDate, graph.facilityId, graph.unitId, graph.attendingProvider.lastName + ', ' + graph.attendingProvider.firstName, graph.visitUnitType, usageType, moment.valueOf());
            this.usageData.push(pa);
            // This can be used for testing and for the timing of individual calls to submitUsageData()
            this.usageDataAdded$.next(pa);
        }
    }
}
UsageApiService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
UsageApiService.ctorParameters = () => [
    { type: HttpClient },
    { type: JwtHelperService },
    { type: UsageConfigService },
    { type: LocationsApiService },
    { type: TokenApiService }
];
/** @nocollapse */ UsageApiService.ngInjectableDef = i0.defineInjectable({ factory: function UsageApiService_Factory() { return new UsageApiService(i0.inject(i1.HttpClient), i0.inject(i2.JwtHelperService), i0.inject(i3.UsageConfigService), i0.inject(i4.LocationsApiService), i0.inject(i5.TokenApiService)); }, token: UsageApiService, providedIn: "root" });
if (false) {
    /** @type {?} */
    UsageApiService.prototype.usageDataAdded$;
    /** @type {?} */
    UsageApiService.prototype.pollInstance$;
    /** @type {?} */
    UsageApiService.prototype.graphUpdated$;
    /** @type {?} */
    UsageApiService.prototype.usageData;
    /** @type {?} */
    UsageApiService.prototype.viewedVisits;
    /** @type {?} */
    UsageApiService.prototype.initialized;
    /** @type {?} */
    UsageApiService.prototype.locations;
    /** @type {?} */
    UsageApiService.prototype.locationsLoaded$;
    /** @type {?} */
    UsageApiService.prototype.locationsLoaded;
    /** @type {?} */
    UsageApiService.prototype.startedLoadingLocations;
    /** @type {?} */
    UsageApiService.prototype.http;
    /** @type {?} */
    UsageApiService.prototype.jwtHelper;
    /** @type {?} */
    UsageApiService.prototype.usageConfigService;
    /** @type {?} */
    UsageApiService.prototype.locationService;
    /** @type {?} */
    UsageApiService.prototype.tokenApiService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNhZ2UtYXBpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1jb21tb24tbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL3VzYWdlL2FwaS91c2FnZS1hcGkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDaEQsT0FBTyxFQUE4QixFQUFFLEVBQUUsT0FBTyxFQUFnQixLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDbkYsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBQ2xFLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUMzRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFFbkQsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFDbEUsT0FBTyxFQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0MsT0FBTyxLQUFLLE9BQU8sTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQzs7Ozs7Ozs7QUFLOUUsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDO0FBS3ZCLE1BQU07Ozs7Ozs7O0lBZUYsWUFBb0IsSUFBZ0IsRUFDaEIsV0FDQSxvQkFDQSxpQkFDQTtRQUpBLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsY0FBUyxHQUFULFNBQVM7UUFDVCx1QkFBa0IsR0FBbEIsa0JBQWtCO1FBQ2xCLG9CQUFlLEdBQWYsZUFBZTtRQUNmLG9CQUFlLEdBQWYsZUFBZTt5QkFkTyxJQUFJLEtB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Q0FBQyxHQUFHLEVBQ1QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFDakMsS0FBSyxDQUFDLFNBQVMsRUFDZixLQUFLLENBQUMsYUFBYSxFQUNuQixLQUFLLENBQUMsVUFBVSxFQUNoQixLQUFLLENBQUMsTUFBTSxFQUNaLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQzNFLEtBQUssQ0FBQyxhQUFhLEVBQ25CLFNBQVMsRUFDVCxNQUFNLENBQUMsT0FBTyxFQUFFLENBQ25CLENBQUM7WUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzs7WUFFeEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDakM7Ozs7WUE3SlIsVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7O1lBbkJPLFVBQVU7WUFNVixnQkFBZ0I7WUFDaEIsa0JBQWtCO1lBR2xCLG1CQUFtQjtZQVJuQixlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7SHR0cENsaWVudH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24sIHRpbWVyfSBmcm9tICdyeGpzJztcbmltcG9ydCB7VG9rZW5BcGlTZXJ2aWNlfSBmcm9tICcuLi8uLi90b2tlbi9hcGkvdG9rZW4tYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHtQYXRpZW50QWNjZXNzfSBmcm9tICcuLi8uLi8uLi9tb2RlbC9QYXRpZW50QWNjZXNzJztcbmltcG9ydCB7VXNhZ2VUeXBlfSBmcm9tICcuLi8uLi8uLi9tb2RlbC9Vc2FnZVR5cGUnO1xuaW1wb3J0IHtQZXJhR3JhcGh9IGZyb20gJy4uLy4uLy4uL21vZGVsL1BlcmFHcmFwaCc7XG5pbXBvcnQge0p3dEhlbHBlclNlcnZpY2V9IGZyb20gJ0BhdXRoMC9hbmd1bGFyLWp3dCc7XG5pbXBvcnQge1VzYWdlQ29uZmlnU2VydmljZX0gZnJvbSAnLi4vY29uZmlnL3VzYWdlLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7Zmlyc3QsIG1hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgKiBhcyBtb21lbnRfIGZyb20gJ21vbWVudC10aW1lem9uZSc7XG5pbXBvcnQge0xvY2F0aW9uc0FwaVNlcnZpY2V9IGZyb20gJy4uLy4uL2xvY2F0aW9ucy9hcGkvbG9jYXRpb25zLWFwaS5zZXJ2aWNlJztcbmltcG9ydCB7TG9jYXRpb25zfSBmcm9tIFwiLi4vLi4vLi4vbW9kZWwvTG9jYXRpb25zXCI7XG5cbi8vIFRoZSBKYXZhU2NyaXB0IGNvbXBpbGVyIGdpdmVzIGEgd2VpcmQgXCJtb21lbnQgY2Fubm90IGJlIHVzZWQgYXMgYSBuYW1lc3BhY2VcIiB0eXBlIG9mIGVycm9yXG4vLyBUaGlzIGlzIHRoZSB3b3JrYXJvdW5kLi4uXG5jb25zdCBtb21lbnQgPSBtb21lbnRfO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFVzYWdlQXBpU2VydmljZSB7XG5cbiAgICBwdWJsaWMgdXNhZ2VEYXRhQWRkZWQkOiBTdWJqZWN0PFBhdGllbnRBY2Nlc3M+O1xuICAgIHByaXZhdGUgcG9sbEluc3RhbmNlJDogT2JzZXJ2YWJsZTxhbnk+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JhcGhVcGRhdGVkJDogU3ViamVjdDxQZXJhR3JhcGg+O1xuICAgIHByaXZhdGUgdXNhZ2VEYXRhOiBBcnJheTxQYXRpZW50QWNjZXNzPiA9IG5ldyBBcnJheTxQYXRpZW50QWNjZXNzPigpO1xuICAgIC8vIFZpc2l0cyB0aGF0IGhhdmUgYmVlbiB2aWV3ZWQgaW4gdGhlIGFycmF5IHZpZXcgYXJlIG9ubHkgYWRkZWQgdG8gdXNhZ2VEYXRhIG9uY2UgcGVyIHNlc3Npb25cbiAgICBwcml2YXRlIHZpZXdlZFZpc2l0czogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIGluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBsb2NhdGlvbnM6IExvY2F0aW9ucztcbiAgICBwcml2YXRlIGxvY2F0aW9uc0xvYWRlZCQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuICAgIHByaXZhdGUgbG9jYXRpb25zTG9hZGVkOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBzdGFydGVkTG9hZGluZ0xvY2F0aW9ucyA9IGZhbHNlO1xuXG4gICAgLy8gVGhlIHRva2VuIHNlcnZpY2UgaXMgbmVjZXNzYXJ5IHRvIGdldCB0aGUgYXBwSWRcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBqd3RIZWxwZXI6IEp3dEhlbHBlclNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB1c2FnZUNvbmZpZ1NlcnZpY2U6IFVzYWdlQ29uZmlnU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvY2F0aW9uU2VydmljZTogTG9jYXRpb25zQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHRva2VuQXBpU2VydmljZTogVG9rZW5BcGlTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZ3JhcGhVcGRhdGVkJCA9IG5ldyBTdWJqZWN0PFBlcmFHcmFwaD4oKTtcbiAgICAgICAgdGhpcy51c2FnZURhdGFBZGRlZCQgPSBuZXcgU3ViamVjdDxQYXRpZW50QWNjZXNzPigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbml0KCkge1xuICAgICAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXJ0VXNhZ2VSZXBvcnRpbmdTZXJ2aWNlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnBvbGxJbnN0YW5jZSQgPSB0aW1lcigwLCB0aGlzLnVzYWdlQ29uZmlnU2VydmljZS5nZXRVc2FnZVBvbGxpbmdJbnRlcnZhbCgpKTtcbiAgICAgICAgdGhpcy5wb2xsSW5zdGFuY2UkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy51c2FnZURhdGEgJiYgdGhpcy51c2FnZURhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3VibWl0VXNhZ2VEYXRhKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodGhpcy51c2FnZURhdGEgJiYgdGhpcy51c2FnZURhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy8gU3VibWl0IG5vdyBpbiBjYXNlIHRoZSB1c2VyIGNsb3NlcyB0aGUgd2luZG93IGJlZm9yZSB0aGUgdGltZXIgZmlyZXNcbiAgICAgICAgICAgIHRoaXMuc3VibWl0VXNhZ2VEYXRhKCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gZ2V0IGFsbCB0aGUgbG9jYXRpb25zIHdoZW4gdGhlIHNlcnZpY2UgaXMgaW5pdGlhbGl6ZWRcbiAgICAgICAgdGhpcy5sb2NhdGlvblNlcnZpY2UuZmFjaWxpdGllc0FuZFVuaXQkLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKChsb2NhdGlvbnM6IExvY2F0aW9ucykgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2NhdGlvbnMgPSBsb2NhdGlvbnM7XG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9uc0xvYWRlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9uc0xvYWRlZCQubmV4dCh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubG9jYXRpb25TZXJ2aWNlLmdldEZhY2lsaXRpZXNBbmRVbml0cygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdWJtaXRVc2FnZURhdGEoKTogdm9pZCB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdTdWJtaXR0aW5nIHVzYWdlIGRhdGEgZm9yIGFwcCAnICsgdGhpcy50b2tlbkFwaVNlcnZpY2UuZ2V0QXBwSWQoKSArICcgU2l6ZSA9ICcgKyB0aGlzLnVzYWdlRGF0YS5sZW5ndGgpO1xuICAgICAgICBjb25zdCB1c2FnZURhdGFDb3B5ID0gdGhpcy51c2FnZURhdGEuc2xpY2UoKTtcbiAgICAgICAgdGhpcy51c2FnZURhdGEgPSBbXTtcbiAgICAgICAgdGhpcy5odHRwLnBvc3QodGhpcy51c2FnZUNvbmZpZ1NlcnZpY2UuZ2V0VXNhZ2VEYXRhRW5kUG9pbnQoKSwgdXNhZ2VEYXRhQ29weSkucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRoZSB1c2VyIGxvZ3Mgb3V0IG9mIHRoZSBzeXN0ZW0sIHdlIG5lZWQgdG8gY2xlYXIgdGhlIGNhY2hlXG4gICAgICogc28gdGhhdCB0aGUgZ3JhcGggdmlld3MgYXJlIHNlbnQgaWYgdGhleSBsb2cgaW4gYWdhaW4uXG4gICAgICovXG4gICAgcHVibGljIGNsZWFyVXNhZ2VDYWNoZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy52aWV3ZWRWaXNpdHMgPSBbXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgdXNhZ2UgZGF0YS5cbiAgICAgKiBAcGFyYW0gZ3JhcGhUb0xvZyBUaGUgaW5mb3JtYXRpb24gdGhhdCB3YXMgdmlld2VkLlxuICAgICAqIEBwYXJhbSB1c2FnZVR5cGUgVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGluZm9ybWF0aW9uIHdhcyB2aWV3ZWQuXG4gICAgICovXG4gICAgcHVibGljIGFkZFVzYWdlRGF0YShncmFwaFRvTG9nOiBQZXJhR3JhcGgsIHVzYWdlVHlwZTogVXNhZ2VUeXBlKTogdm9pZCB7XG4gICAgICAgIC8vIFdlIGhhdmUgdG8gcmVwbGFjZSB0aGUgZmFjaWxpdHkgYW5kIHVuaXQgSURzIHdpdGggdGhlIHJlYWwgZGVhbHNcbiAgICAgICAgdGhpcy51cGRhdGVGYWNpbGl0eUFuZFVuaXRJZHNGb3JHcmFwaChncmFwaFRvTG9nKS5waXBlKGZpcnN0KCksIHRhcCgoZ3JhcGg6IFBlcmFHcmFwaCkgPT4ge1xuICAgICAgICAgICAgdGhpcy50b2tlbkFwaVNlcnZpY2UudG9rZW4kLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKCh0b2tlbjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHVzYWdlVHlwZSA9PT0gVXNhZ2VUeXBlLkFycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgbG9nIDEgZ3JhcGggdmlldyBwZXIgc2Vzc2lvbiB3aGVuIHZpZXdlZCBpbiB0aGUgYXJyYXkgdmlld1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhcGggJiYgdGhpcy52aWV3ZWRWaXNpdHMuaW5kZXhPZihncmFwaC52bm0pIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2Ugb25seSBsb2cgMSB2aXNpdCB2aWV3IG9mIGEgc3BlY2lmaWMgdHlwZSBwZXIgc2Vzc2lvblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3ZWRWaXNpdHMucHVzaChncmFwaC52bm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRVc2FnZURhdGFGcm9tVG9rZW4oZ3JhcGgsIHVzYWdlVHlwZSwgdG9rZW4pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQWx3YXlzIGFkZCBncmFwaCB2aWV3cyBiZWNhdXNlIHRoZSB1c2VyIGNsaWNrZWQgb24gYSBncmFwaCBpbiB0aGUgYXJyYXkgdmlld1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFVzYWdlRGF0YUZyb21Ub2tlbihncmFwaCwgdXNhZ2VUeXBlLCB0b2tlbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnRva2VuQXBpU2VydmljZS5nZXRFeGlzdGluZ1Rva2VuKCk7XG4gICAgICAgIH0pKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgaWYgKCF0aGlzLmxvY2F0aW9uc0xvYWRlZCAmJiAhdGhpcy5zdGFydGVkTG9hZGluZ0xvY2F0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5zdGFydGVkTG9hZGluZ0xvY2F0aW9ucyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9uU2VydmljZS5nZXRGYWNpbGl0aWVzQW5kVW5pdHMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGxvb2t1cCBhbmQgaW5zZXJ0IHRoZSB1bml0IGlkIGFuZCBmYWMgaWQgb2YgZ3JhcGggdG8gbG9nXG4gICAgICogQHBhcmFtIGdyYXBoIC0gZ3JhcGggdG8gbG9nXG4gICAgICovXG4gICAgcHJpdmF0ZSB1cGRhdGVGYWNpbGl0eUFuZFVuaXRJZHNGb3JHcmFwaChncmFwaDogUGVyYUdyYXBoKTogT2JzZXJ2YWJsZTxQZXJhR3JhcGg+IHtcbiAgICAgICAgLy8gQ3JlYXRlIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGdyYXBoIHNpbmNlIHdlIGFyZSB1cGRhdGluZyB0aGUgZmFjaWxpdHkgYW5kIHVuaXRcbiAgICAgICAgLy8gdG8gdGhlaXIgb3JpZ2luYWwgSURzIGZvciBVc2FnZS5cbiAgICAgICAgY29uc3QgY2xvbmVHcmFwaDogUGVyYUdyYXBoID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShncmFwaCkpO1xuICAgICAgICBpZiAodGhpcy5sb2NhdGlvbnNMb2FkZWQgPT09IHRydWUpIHtcbiAgICAgICAgICAgIHJldHVybiBvZihVc2FnZUFwaVNlcnZpY2UuYXNzaWduVW5pdEFuZEZhY0lkVG9QZXJhR3JhcGgoY2xvbmVHcmFwaCwgdGhpcy5sb2NhdGlvbnMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uc0xvYWRlZCQucGlwZShtYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBVc2FnZUFwaVNlcnZpY2UuYXNzaWduVW5pdEFuZEZhY0lkVG9QZXJhR3JhcGgoY2xvbmVHcmFwaCwgdGhpcy5sb2NhdGlvbnMpO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaGVscGVyIG1ldGhvZCBmb3IgbG9va2luZyB1cCBmYWMgYW5kIHVuaXQgaWRzXG4gICAgICogQHBhcmFtIGdyYXBoIC0gZ3JhcGggdG8gcmVwbGFjZSB1bml0SWQgYW5kIGZhY0lkIG9mXG4gICAgICogQHBhcmFtIGxvY2F0aW9ucyAtIGFsbCBsb2NhdGlvbnMgYXZhaWxhYmxlIHRvIHNlYXJjaFxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIGFzc2lnblVuaXRBbmRGYWNJZFRvUGVyYUdyYXBoKGdyYXBoOiBQZXJhR3JhcGgsIGxvY2F0aW9uczogTG9jYXRpb25zKTogUGVyYUdyYXBoIHtcbiAgICAgICAgZm9yIChjb25zdCBmYWMgb2YgbG9jYXRpb25zLmZhY2lsaXRpZXMpIHtcbiAgICAgICAgICAgIGlmIChncmFwaC5mYWNpbGl0eUlkID09PSBmYWMuZGlzcGxheU5hbWUpIHtcbiAgICAgICAgICAgICAgICBncmFwaC5mYWNpbGl0eUlkID0gZmFjLmZhY2lsaXR5SUQ7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCB1bml0IG9mIGxvY2F0aW9ucy51bml0cykge1xuICAgICAgICAgICAgaWYgKGdyYXBoLnVuaXRJZCA9PT0gdW5pdC5kaXNwbGF5TmFtZSkge1xuICAgICAgICAgICAgICAgIGdyYXBoLnVuaXRJZCA9IHVuaXQua2V5LnVuaXRJRDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZ3JhcGg7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRVc2FnZURhdGFGcm9tVG9rZW4oZ3JhcGg6IFBlcmFHcmFwaCwgdXNhZ2VUeXBlOiBVc2FnZVR5cGUsIHRva2VuOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZGVjb2RlZFRva2VuID0gdGhpcy5qd3RIZWxwZXIuZGVjb2RlVG9rZW4odG9rZW4pO1xuICAgICAgICBpZiAoZGVjb2RlZFRva2VuKSB7XG4gICAgICAgICAgICAvLyBDb252ZXJ0IHRvIGEgdXNlciBvYmplY3QgdG8gc2VuZCB0byB0aGUgUkVTVCBzZXJ2aWNlXG4gICAgICAgICAgICBjb25zdCBwYTogUGF0aWVudEFjY2VzcyA9IG5ldyBQYXRpZW50QWNjZXNzKFxuICAgICAgICAgICAgICAgIGRlY29kZWRUb2tlblsnc3ViJ10sIC8vIFRoZSBjbGFpbXMgc3ViamVjdCBpcyB0aGUgdXNlcm5hbWVcbiAgICAgICAgICAgICAgICBncmFwaC5wYXRpZW50LmxuYW1lICsgJywgJyArIGdyYXBoLnBhdGllbnQuZm5hbWUsXG4gICAgICAgICAgICAgICAgZ3JhcGgudmlwSW5kaWNhdG9yLFxuICAgICAgICAgICAgICAgIGdyYXBoLnZubSxcbiAgICAgICAgICAgICAgICBncmFwaC5wYXRpZW50Lm1lZGljYWxSZWNvcmROdW1iZXIsXG4gICAgICAgICAgICAgICAgZ3JhcGguYWRtaXREYXRlLFxuICAgICAgICAgICAgICAgIGdyYXBoLmRpc2NoYXJnZURhdGUsXG4gICAgICAgICAgICAgICAgZ3JhcGguZmFjaWxpdHlJZCxcbiAgICAgICAgICAgICAgICBncmFwaC51bml0SWQsXG4gICAgICAgICAgICAgICAgZ3JhcGguYXR0ZW5kaW5nUHJvdmlkZXIubGFzdE5hbWUgKyAnLCAnICsgZ3JhcGguYXR0ZW5kaW5nUHJvdmlkZXIuZmlyc3ROYW1lLFxuICAgICAgICAgICAgICAgIGdyYXBoLnZpc2l0VW5pdFR5cGUsXG4gICAgICAgICAgICAgICAgdXNhZ2VUeXBlLFxuICAgICAgICAgICAgICAgIG1vbWVudC52YWx1ZU9mKClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLnVzYWdlRGF0YS5wdXNoKHBhKTtcbiAgICAgICAgICAgIC8vIFRoaXMgY2FuIGJlIHVzZWQgZm9yIHRlc3RpbmcgYW5kIGZvciB0aGUgdGltaW5nIG9mIGluZGl2aWR1YWwgY2FsbHMgdG8gc3VibWl0VXNhZ2VEYXRhKClcbiAgICAgICAgICAgIHRoaXMudXNhZ2VEYXRhQWRkZWQkLm5leHQocGEpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19