/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, ElementRef, Input, ViewChild } from '@angular/core';
import { ArrayViewService } from './service/array-view.service';
import { BehaviorSubject, combineLatest, of } from 'rxjs';
import { filter, first, map, mergeMap, tap } from 'rxjs/operators';
import { PeraGraphService } from './group/pera-graph/service/pera-graph.service';
import { ArrayViewConfigService } from './service/array-view-config.service';
import { PriorWarningsConfigService } from './service/prior-warnings/config/prior-warnings-config.service';
import { PriorWarningsApiService } from './service/prior-warnings/api/prior-warnings-api.service';
import { FlowsheetsApiService, PeragraphApiService } from 'ng-common-library';
import { FilterService, SortService, GroupService } from 'ng-filters-library';
export class ArrayViewComponent {
    /**
     * @param {?} arrayViewService
     * @param {?} arrayViewConfigService
     * @param {?} peragraphApiService
     * @param {?} filterService
     * @param {?} flowsheetsApiService
     * @param {?} priorWarningsConfigService
     * @param {?} priorWarningsApiService
     * @param {?} peraGraphService
     * @param {?} sortService
     * @param {?} groupService
     * @param {?} ref
     */
    constructor(arrayViewService, arrayViewConfigService, peragraphApiService, filterService, flowsheetsApiService, priorWarningsConfigService, priorWarningsApiService, peraGraphService, sortService, groupService, ref) {
        this.arrayViewService = arrayViewService;
        this.arrayViewConfigService = arrayViewConfigService;
        this.peragraphApiService = peragraphApiService;
        this.filterService = filterService;
        this.flowsheetsApiService = flowsheetsApiService;
        this.priorWarningsConfigService = priorWarningsConfigService;
        this.priorWarningsApiService = priorWarningsApiService;
        this.peraGraphService = peraGraphService;
        this.sortService = sortService;
        this.groupService = groupService;
        this.ref = ref;
        // collects all the peraGraphs from their input sources combines them, filters them, and then passes them onto the groups
        this.filteredPeraGraphs$ = new BehaviorSubject([]);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.numGroupsDisplay = this.groupService.changeNumberOfGroupsToShow$;
        this.expandedSubject$ = this.groupService.expandGroups$;
        this.groups$ = this.groupService.groupSubject$;
        // Load the configuration for the array view and subscribe to the PeraGraphs and Flowsheet services.
        this.arrayViewConfigService.configurationLoaded$.pipe(filter((isReady) => isReady), first()).subscribe(() => this.initializeArrayView());
        this.updateBehaviorBasedOnInputs();
    }
    /**
     * @return {?}
     */
    initializeArrayView() {
        // Once we have the configuration, we can get the rest of the information that we need
        this.arrayViewService.calcCurrentTimestamp();
        // get all Peragraphs on an interval and push them into the peraGraphSubject to be filtered
        this.peraGraphSubscription = this.peragraphApiService.getPeraGraphInterval().subscribe(peraGraphs => {
            this.peragraphApiService.getPeraGraphSubject().next(peraGraphs);
        });
        // uses combineLatest to update the array view when either new graphs are added (peraGraph Subject - sourced by peraGraphInterval and manual graph refreshes) or new filters are added (filterSubject)
        // and then filters before pushing to groups
        this.filteredPeraGraphsSubscription = combineLatest(this.peragraphApiService.getPeraGraphSubject(), this.filterService.filterSubject$).pipe(map((peraGraphsAndFilters) => peraGraphsAndFilters[0].filter(peraGraph => this.arrayViewService.filterPeragraph(peraGraph, this.filterService.activeFilters))), mergeMap((peraGraphs) => this.arrayViewService.addRIToPeraGraphs(peraGraphs)), map((peraGraphs) => peraGraphs.sort((peraGraphA, peraGraphB) => this.arrayViewService.sortGraphs(peraGraphA, peraGraphB, this.sortService.activeSortFunction))), tap((peraGraphs) => {
            // if this iteration of the filtered graphs subject was triggered by the apply filters button
            // then recalculate and close the proper groups
            // if generated by refresh button or interval, don't reset the closed groups
            /** @type {?} */
            const groupDisplay = this.arrayViewService.calculateNumberOfGroupsToShow(peraGraphs);
            if (this.groupService.changeGroupsClosed) {
                this.groupService.changeNumberOfGroupsToShow$.next(groupDisplay.groupsToShow);
                this.groupService.changeGroupsClosed = false;
            }
            this.groupService.expandGroups$.next(groupDisplay.expanded);
        })).subscribe((peraGraphs) => {
            // Assign an index to the anonymous property of the PeraGraph - used by the Anonymous Patient chart title.
            /** @type {?} */
            let anonymousIndex = 1;
            peraGraphs.forEach(graph => {
                graph.anonymous = anonymousIndex;
                anonymousIndex++;
            });
            this.filteredPeraGraphs$.next(peraGraphs);
            this.arrayViewService.completedRefresh$.next();
            // Push the new Chart title selection through the Subject.
            this.arrayViewService.chartTitleSubject$.next(this.arrayViewService.selectedChartTitle);
        });
        // Whenever we get new FSCs (on an interval) push them out through the subject so the groups receive the updated map of FSCs
        this.flowSheetSubscription = this.flowsheetsApiService.getFlowSheetInterval().subscribe(flowsheets => this.flowsheetsApiService.getFlowSheetSubject().next(flowsheets.body));
        // Whenever we get new prior warnings (on an interval) push them out through the subject so the groups receive the updated map of warnings
        if (this.priorWarningsConfigService.getPriorWarningEndPoint()) {
            this.priorWarningSubscription = this.priorWarningsApiService.getPriorWarningInterval().subscribe(priorWarnings => this.priorWarningsApiService.getPriorWarningSubject().next(priorWarnings.body));
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() {
        if (this.scrollContainerWidth !== this.getScrollContainerWidth()) {
            this.scrollContainerWidth = this.getScrollContainerWidth();
            if (this.ref) {
                this.ref.detectChanges();
            }
        }
    }
    /**
     * Used to dynamically set the width of the scroll container (based on the width of the array view component)
     * @return {?}
     */
    getScrollContainerWidth() {
        /** @type {?} */
        const width = this.arrayViewElementRef.nativeElement.offsetWidth;
        // Ensure that the container has padding
        /** @type {?} */
        const padding = width * .11;
        // Get the number of graphs that we should be able to display in the window (taking the padding into account)
        /** @type {?} */
        const numGraphsInRow = Math.floor((width - padding) / this.arrayViewService.peraGraphWidth);
        // Return the width
        return numGraphsInRow * this.arrayViewService.peraGraphWidth + 'px';
    }
    /**
     * @return {?}
     */
    ngOnChanges() {
        this.updateBehaviorBasedOnInputs();
        // TODO update this when we add the ability to change the title/grouping/sorting
    }
    /**
     * Updates the fields in the array view service and in this component based on the input so that we see the desired behavior
     * @private
     * @return {?}
     */
    updateBehaviorBasedOnInputs() {
        this.disableGroupsIfAppropriate();
        this.setPeraGraphSortingFunction();
        this.updatePeraGraphDimensions();
    }
    /**
     * If we pass in an explicit width/height, use them
     * @private
     * @return {?}
     */
    updatePeraGraphDimensions() {
        if (this.peraGraphHeight && this.peraGraphWidth) {
            this.arrayViewService.peraGraphWidth = this.peraGraphWidth;
            this.arrayViewService.peraGraphHeight = this.peraGraphHeight;
            this.arrayViewService.refreshViewPort();
        }
    }
    /**
     * This sets the array view service's sorting function to the input passed to the array view component
     * @private
     * @return {?}
     */
    setPeraGraphSortingFunction() {
        if (this.peraGraphSortingFunction) {
            this.arrayViewService.sortGraphs = this.peraGraphSortingFunction;
        }
    }
    /**
     * If groups are disabled or absent, add a single group that will catch all graphs and not display a header
     * @private
     * @return {?}
     */
    disableGroupsIfAppropriate() {
        // If groups are disabled or if we don't have groups
        if (this.disableGroups || this.groups$ == null) {
            this.groups$ = of([[null, function (peraGraph) {
                        return true;
                    }]]);
        }
    }
    // not sure if this is needed since we are using combinedLatest above but I left it just in case
    // public filterChanged() {
    //   // Get the current list of PeraGraphs without making another call
    //   let peraGraphs = this.peragraphApiService.getPeraGraphSubject().value;
    //   // Filter the list according to the updated matchesFilter function within the arrayView service
    //   peraGraphs = this.arrayViewService.filterPeragraphs(peraGraphs, this.filterService.activeFilters)
    //   // Publish result to all subscribing groups
    //   this.peragraphApiService.getPeraGraphSubject().next(peraGraphs);
    // }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.ref) {
            this.ref.detach();
            this.ref = null;
        }
        if (this.peraGraphSubscription && !this.peraGraphSubscription.closed) {
            this.peraGraphSubscription.unsubscribe();
        }
        if (this.flowSheetSubscription && !this.flowSheetSubscription.closed) {
            this.flowSheetSubscription.unsubscribe();
        }
        if (this.priorWarningSubscription && !this.priorWarningSubscription.closed) {
            this.priorWarningSubscription.unsubscribe();
        }
        if (this.filteredPeraGraphsSubscription && !this.filteredPeraGraphs$.closed) {
            this.filteredPeraGraphsSubscription.unsubscribe();
        }
    }
}
ArrayViewComponent.decorators = [
    { type: Component, args: [{
                selector: 'phlib-array-view',
                template: "<div class=\"array-view\" #arrayView>\n    <!--<button class=\"btn btn-outline-success my-2 my-sm-0\" (click)=\"arrayViewService.toggleTileView()\">Tile View</button>-->\n    <phlib-group *ngFor=\"let group of groups$ | async; let i = index\"\n                 [showPeraGraphs]=\"i < numGroupsDisplay.value\"\n                 [expanded]=\"expandedSubject$.value\"\n                 [group]=\"group\" [peraGraphWidth]=\"arrayViewService.peraGraphWidth\"\n                 [peraGraphHeight]=\"arrayViewService.peraGraphHeight\" [scrollContainerWidth]=\"scrollContainerWidth\"\n                 [filteredPeraGraphs$]=\"filteredPeraGraphs$\"\n    ></phlib-group>\n</div>\n",
                styles: [""]
            }] }
];
/** @nocollapse */
ArrayViewComponent.ctorParameters = () => [
    { type: ArrayViewService },
    { type: ArrayViewConfigService },
    { type: PeragraphApiService },
    { type: FilterService },
    { type: FlowsheetsApiService },
    { type: PriorWarningsConfigService },
    { type: PriorWarningsApiService },
    { type: PeraGraphService },
    { type: SortService },
    { type: GroupService },
    { type: ChangeDetectorRef }
];
ArrayViewComponent.propDecorators = {
    peraGraphSortingFunction: [{ type: Input }],
    peraGraphTitleFunction: [{ type: Input }],
    disableGroups: [{ type: Input }],
    numGroupsDisplay: [{ type: Input }],
    peraGraphHeight: [{ type: Input }],
    peraGraphWidth: [{ type: Input }],
    arrayViewElementRef: [{ type: ViewChild, args: ['arrayView',] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.peraGraphSubscription;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.flowSheetSubscription;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.priorWarningSubscription;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.filteredPeraGraphsSubscription;
    /** @type {?} */
    ArrayViewComponent.prototype.filteredPeraGraphs$;
    /** @type {?} */
    ArrayViewComponent.prototype.peraGraphSortingFunction;
    /** @type {?} */
    ArrayViewComponent.prototype.peraGraphTitleFunction;
    /** @type {?} */
    ArrayViewComponent.prototype.groups$;
    /** @type {?} */
    ArrayViewComponent.prototype.disableGroups;
    /** @type {?} */
    ArrayViewComponent.prototype.numGroupsDisplay;
    /** @type {?} */
    ArrayViewComponent.prototype.peraGraphHeight;
    /** @type {?} */
    ArrayViewComponent.prototype.peraGraphWidth;
    /** @type {?} */
    ArrayViewComponent.prototype.arrayViewElementRef;
    /** @type {?} */
    ArrayViewComponent.prototype.scrollContainerWidth;
    /** @type {?} */
    ArrayViewComponent.prototype.expandedSubject$;
    /** @type {?} */
    ArrayViewComponent.prototype.arrayViewService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.arrayViewConfigService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.peragraphApiService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.filterService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.flowsheetsApiService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.priorWarningsConfigService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.priorWarningsApiService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.peraGraphService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.sortService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.groupService;
    /**
     * @type {?}
     * @private
     */
    ArrayViewComponent.prototype.ref;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJyYXktdmlldy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1hcnJheS12aWV3LWxpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvYXJyYXktdmlldy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFFSCxpQkFBaUIsRUFDakIsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBSUwsU0FBUyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQzlELE9BQU8sRUFBQyxlQUFlLEVBQUUsYUFBYSxFQUFFLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN4RCxPQUFPLEVBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ2pFLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLCtDQUErQyxDQUFDO0FBQy9FLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBRTNFLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLCtEQUErRCxDQUFDO0FBQ3pHLE9BQU8sRUFBQyx1QkFBdUIsRUFBQyxNQUFNLHlEQUF5RCxDQUFDO0FBQ2hHLE9BQU8sRUFBQyxvQkFBb0IsRUFBRSxtQkFBbUIsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQzVFLE9BQU8sRUFBQyxhQUFhLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBTzVFLE1BQU0sT0FBTyxrQkFBa0I7Ozs7Ozs7Ozs7Ozs7O0lBcUMzQixZQUFtQixnQkFBa0MsRUFDakMsc0JBQThDLEVBQzlDLG1CQUF3QyxFQUN4QyxhQUE0QixFQUM1QixvQkFBMEMsRUFDMUMsMEJBQXNELEVBQ3RELHVCQUFnRCxFQUNoRCxnQkFBa0MsRUFDbEMsV0FBd0IsRUFDeEIsWUFBMEIs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REFBZ0Q7Ozs7O0lBQ2hELDJDQUFvQzs7Ozs7SUFDcEMsa0RBQWtEOzs7OztJQUNsRCx3REFBOEQ7Ozs7O0lBQzlELHFEQUF3RDs7Ozs7SUFDeEQsOENBQTBDOzs7OztJQUMxQyx5Q0FBZ0M7Ozs7O0lBQ2hDLDBDQUFrQzs7Ozs7SUFDbEMsaUNBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBBZnRlclZpZXdDaGVja2VkLFxuICAgIENoYW5nZURldGVjdG9yUmVmLFxuICAgIENvbXBvbmVudCxcbiAgICBFbGVtZW50UmVmLFxuICAgIElucHV0LFxuICAgIE9uQ2hhbmdlcyxcbiAgICBPbkRlc3Ryb3ksXG4gICAgT25Jbml0LFxuICAgIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QXJyYXlWaWV3U2VydmljZX0gZnJvbSAnLi9zZXJ2aWNlL2FycmF5LXZpZXcuc2VydmljZSc7XG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmaWx0ZXIsIGZpcnN0LCBtYXAsIG1lcmdlTWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7UGVyYUdyYXBoU2VydmljZX0gZnJvbSAnLi9ncm91cC9wZXJhLWdyYXBoL3NlcnZpY2UvcGVyYS1ncmFwaC5zZXJ2aWNlJztcbmltcG9ydCB7QXJyYXlWaWV3Q29uZmlnU2VydmljZX0gZnJvbSAnLi9zZXJ2aWNlL2FycmF5LXZpZXctY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHtQZXJhR3JhcGh9IGZyb20gJ25nLWNvbW1vbi1saWJyYXJ5L2xpYi9tb2RlbC9QZXJhR3JhcGgnO1xuaW1wb3J0IHtQcmlvcldhcm5pbmdzQ29uZmlnU2VydmljZX0gZnJvbSAnLi9zZXJ2aWNlL3ByaW9yLXdhcm5pbmdzL2NvbmZpZy9wcmlvci13YXJuaW5ncy1jb25maWcuc2VydmljZSc7XG5pbXBvcnQge1ByaW9yV2FybmluZ3NBcGlTZXJ2aWNlfSBmcm9tICcuL3NlcnZpY2UvcHJpb3Itd2FybmluZ3MvYXBpL3ByaW9yLXdhcm5pbmdzLWFwaS5zZXJ2aWNlJztcbmltcG9ydCB7Rmxvd3NoZWV0c0FwaVNlcnZpY2UsIFBlcmFncmFwaEFwaVNlcnZpY2V9IGZyb20gJ25nLWNvbW1vbi1saWJyYXJ5JztcbmltcG9ydCB7RmlsdGVyU2VydmljZSwgU29ydFNlcnZpY2UsIEdyb3VwU2VydmljZX0gZnJvbSAnbmctZmlsdGVycy1saWJyYXJ5JztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdwaGxpYi1hcnJheS12aWV3JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXJyYXktdmlldy5jb21wb25lbnQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vYXJyYXktdmlldy5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgQXJyYXlWaWV3Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcywgQWZ0ZXJWaWV3Q2hlY2tlZCB7XG5cbiAgICBwcml2YXRlIHBlcmFHcmFwaFN1YnNjcmlwdGlvbjtcbiAgICBwcml2YXRlIGZsb3dTaGVldFN1YnNjcmlwdGlvbjtcbiAgICBwcml2YXRlIHByaW9yV2FybmluZ1N1YnNjcmlwdGlvbjtcbiAgICBwcml2YXRlIGZpbHRlcmVkUGVyYUdyYXBoc1N1YnNjcmlwdGlvbjtcblxuICAgIC8vIGNvbGxlY3RzIGFsbCB0aGUgcGVyYUdyYXBocyBmcm9tIHRoZWlyIGlucHV0IHNvdXJjZXMgY29tYmluZXMgdGhlbSwgZmlsdGVycyB0aGVtLCBhbmQgdGhlbiBwYXNzZXMgdGhlbSBvbnRvIHRoZSBncm91cHNcbiAgICBmaWx0ZXJlZFBlcmFHcmFwaHMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxQZXJhR3JhcGhbXT4oW10pO1xuXG4gICAgQElucHV0KClcbiAgICBwZXJhR3JhcGhTb3J0aW5nRnVuY3Rpb246IChmaXJzdEdyYXBoOiBQZXJhR3JhcGgsIHNlY29uZEdyYXBoOiBQZXJhR3JhcGgpID0+IG51bWJlcjtcblxuICAgIEBJbnB1dCgpXG4gICAgcGVyYUdyYXBoVGl0bGVGdW5jdGlvbjogKGdyYXBoOiBQZXJhR3JhcGgpID0+IHN0cmluZztcblxuICAgIGdyb3VwcyQ7XG5cbiAgICBASW5wdXQoKVxuICAgIGRpc2FibGVHcm91cHM6IGJvb2xlYW47XG5cbiAgICBASW5wdXQoKVxuICAgIG51bUdyb3Vwc0Rpc3BsYXk6IEJlaGF2aW9yU3ViamVjdDxudW1iZXI+O1xuXG4gICAgQElucHV0KClcbiAgICBwZXJhR3JhcGhIZWlnaHQ6IG51bWJlcjtcblxuICAgIEBJbnB1dCgpXG4gICAgcGVyYUdyYXBoV2lkdGg6IG51bWJlcjtcblxuICAgIEBWaWV3Q2hpbGQoJ2FycmF5VmlldycpXG4gICAgYXJyYXlWaWV3RWxlbWVudFJlZjogRWxlbWVudFJlZjtcblxuICAgIHNjcm9sbENvbnRhaW5lcldpZHRoOiBzdHJpbmc7XG5cbiAgICBleHBhbmRlZFN1YmplY3QkOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj47XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgYXJyYXlWaWV3U2VydmljZTogQXJyYXlWaWV3U2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGFycmF5Vmlld0NvbmZpZ1NlcnZpY2U6IEFycmF5Vmlld0NvbmZpZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBwZXJhZ3JhcGhBcGlTZXJ2aWNlOiBQZXJhZ3JhcGhBcGlTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZmlsdGVyU2VydmljZTogRmlsdGVyU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGZsb3dzaGVldHNBcGlTZXJ2aWNlOiBGbG93c2hlZXRzQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHByaW9yV2FybmluZ3NDb25maWdTZXJ2aWNlOiBQcmlvcldhcm5pbmdzQ29uZmlnU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHByaW9yV2FybmluZ3NBcGlTZXJ2aWNlOiBQcmlvcldhcm5pbmdzQXBpU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHBlcmFHcmFwaFNlcnZpY2U6IFBlcmFHcmFwaFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzb3J0U2VydmljZTogU29ydFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBncm91cFNlcnZpY2U6IEdyb3VwU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5udW1Hcm91cHNEaXNwbGF5ID0gdGhpcy5ncm91cFNlcnZpY2UuY2hhbmdlTnVtYmVyT2ZHcm91cHNUb1Nob3ckO1xuICAgICAgICB0aGlzLmV4cGFuZGVkU3ViamVjdCQgPSB0aGlzLmdyb3VwU2VydmljZS5leHBhbmRHcm91cHMkO1xuICAgICAgICB0aGlzLmdyb3VwcyQgPSB0aGlzLmdyb3VwU2VydmljZS5ncm91cFN1YmplY3QkO1xuICAgICAgICAvLyBMb2FkIHRoZSBjb25maWd1cmF0aW9uIGZvciB0aGUgYXJyYXkgdmlldyBhbmQgc3Vic2NyaWJlIHRvIHRoZSBQZXJhR3JhcGhzIGFuZCBGbG93c2hlZXQgc2VydmljZXMuXG4gICAgICAgIHRoaXMuYXJyYXlWaWV3Q29uZmlnU2VydmljZS5jb25maWd1cmF0aW9uTG9hZGVkJC5waXBlKGZpbHRlcigoaXNSZWFkeTogYm9vbGVhbikgPT4gaXNSZWFkeSksIGZpcnN0KCkpLnN1YnNjcmliZSgoKSA9PiB0aGlzLmluaXRpYWxpemVBcnJheVZpZXcoKSk7XG5cbiAgICAgICAgdGhpcy51cGRhdGVCZWhhdmlvckJhc2VkT25JbnB1dHMoKTtcbiAgICB9XG5cbiAgICBpbml0aWFsaXplQXJyYXlWaWV3KCkge1xuXG4gICAgICAgIC8vIE9uY2Ugd2UgaGF2ZSB0aGUgY29uZmlndXJhdGlvbiwgd2UgY2FuIGdldCB0aGUgcmVzdCBvZiB0aGUgaW5mb3JtYXRpb24gdGhhdCB3ZSBuZWVkXG4gICAgICAgIHRoaXMuYXJyYXlWaWV3U2VydmljZS5jYWxjQ3VycmVudFRpbWVzdGFtcCgpO1xuXG4gICAgICAgIC8vIGdldCBhbGwgUGVyYWdyYXBocyBvbiBhbiBpbnRlcnZhbCBhbmQgcHVzaCB0aGVtIGludG8gdGhlIHBlcmFHcmFwaFN1YmplY3QgdG8gYmUgZmlsdGVyZWRcbiAgICAgICAgdGhpcy5wZXJhR3JhcGhTdWJzY3JpcHRpb24gPSB0aGlzLnBlcmFncmFwaEFwaVNlcnZpY2UuZ2V0UGVyYUdyYXBoSW50ZXJ2YWwoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICBwZXJhR3JhcGhzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnBlcmFncmFwaEFwaVNlcnZpY2UuZ2V0UGVyYUdyYXBoU3ViamVjdCgpLm5leHQocGVyYUdyYXBocyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gdXNlcyBjb21iaW5lTGF0ZXN0IHRvIHVwZGF0ZSB0aGUgYXJyYXkgdmlldyB3aGVuIGVpdGhlciBuZXcgZ3JhcGhzIGFyZSBhZGRlZCAocGVyYUdyYXBoIFN1YmplY3QgLSBzb3VyY2VkIGJ5IHBlcmFHcmFwaEludGVydmFsIGFuZCBtYW51YWwgZ3JhcGggcmVmcmVzaGVzKSBvciBuZXcgZmlsdGVycyBhcmUgYWRkZWQgKGZpbHRlclN1YmplY3QpXG4gICAgICAgIC8vIGFuZCB0aGVuIGZpbHRlcnMgYmVmb3JlIHB1c2hpbmcgdG8gZ3JvdXBzXG4gICAgICAgIHRoaXMuZmlsdGVyZWRQZXJhR3JhcGhzU3Vic2NyaXB0aW9uID0gY29tYmluZUxhdGVzdCh0aGlzLnBlcmFncmFwaEFwaVNlcnZpY2UuZ2V0UGVyYUdyYXBoU3ViamVjdCgpLCB0aGlzLmZpbHRlclNlcnZpY2UuZmlsdGVyU3ViamVjdCQpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHBlcmFHcmFwaHNBbmRGaWx0ZXJzKSA9PiBwZXJhR3JhcGhzQW5kRmlsdGVyc1swXS5maWx0ZXIocGVyYUdyYXBoID0+XG4gICAgICAgICAgICB0aGlzLmFycmF5Vmlld1NlcnZpY2UuZmlsdGVyUGVyYWdyYXBoKHBlcmFHcmFwaCwgdGhpcy5maWx0ZXJTZXJ2aWNlLmFjdGl2ZUZpbHRlcnMpKVxuICAgICAgICApLCBtZXJnZU1hcCgocGVyYUdyYXBocykgPT4gdGhpcy5hcnJheVZpZXdTZXJ2aWNlLmFkZFJJVG9QZXJhR3JhcGhzKHBlcmFHcmFwaHMpXG4gICAgICAgICksIG1hcCgocGVyYUdyYXBoczogUGVyYUdyYXBoW10pID0+IHBlcmFHcmFwaHMuc29ydCgocGVyYUdyYXBoQTogUGVyYUdyYXBoLCBwZXJhR3JhcGhCOiBQZXJhR3JhcGgpID0+IHRoaXMuYXJyYXlWaWV3U2VydmljZS5zb3J0R3JhcGhzKHBlcmFHcmFwaEEsIHBlcmFHcmFwaEIsIHRoaXMuc29ydFNlcnZpY2UuYWN0aXZlU29ydEZ1bmN0aW9uKVxuICAgICAgICApKSwgdGFwKChwZXJhR3JhcGhzOiBQZXJhR3JhcGhbXSkgPT4ge1xuICAgICAgICAgICAgLy8gaWYgdGhpcyBpdGVyYXRpb24gb2YgdGhlIGZpbHRlcmVkIGdyYXBocyBzdWJqZWN0IHdhcyB0cmlnZ2VyZWQgYnkgdGhlIGFwcGx5IGZpbHRlcnMgYnV0dG9uXG4gICAgICAgICAgICAvLyB0aGVuIHJlY2FsY3VsYXRlIGFuZCBjbG9zZSB0aGUgcHJvcGVyIGdyb3Vwc1xuICAgICAgICAgICAgLy8gaWYgZ2VuZXJhdGVkIGJ5IHJlZnJlc2ggYnV0dG9uIG9yIGludGVydmFsLCBkb24ndCByZXNldCB0aGUgY2xvc2VkIGdyb3Vwc1xuICAgICAgICAgICAgY29uc3QgZ3JvdXBEaXNwbGF5OiB7Z3JvdXBzVG9TaG93OiBudW1iZXIsIGV4cGFuZGVkOiBib29sZWFufSA9IHRoaXMuYXJyYXlWaWV3U2VydmljZS5jYWxjdWxhdGVOdW1iZXJPZkdyb3Vwc1RvU2hvdyhwZXJhR3JhcGhzKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmdyb3VwU2VydmljZS5jaGFuZ2VHcm91cHNDbG9zZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmdyb3VwU2VydmljZS5jaGFuZ2VOdW1iZXJPZkdyb3Vwc1RvU2hvdyQubmV4dChncm91cERpc3BsYXkuZ3JvdXBzVG9TaG93KTtcbiAgICAgICAgICAgICAgICB0aGlzLmdyb3VwU2VydmljZS5jaGFuZ2VHcm91cHNDbG9zZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZ3JvdXBTZXJ2aWNlLmV4cGFuZEdyb3VwcyQubmV4dChncm91cERpc3BsYXkuZXhwYW5kZWQpO1xuICAgICAgICB9KSkuc3Vic2NyaWJlKChwZXJhR3JhcGhzOiBQZXJhR3JhcGhbXSkgPT4ge1xuICAgICAgICAgICAgLy8gQXNzaWduIGFuIGluZGV4IHRvIHRoZSBhbm9ueW1vdXMgcHJvcGVydHkgb2YgdGhlIFBlcmFHcmFwaCAtIHVzZWQgYnkgdGhlIEFub255bW91cyBQYXRpZW50IGNoYXJ0IHRpdGxlLlxuICAgICAgICAgICAgbGV0IGFub255bW91c0luZGV4ID0gMTtcbiAgICAgICAgICAgIHBlcmFHcmFwaHMuZm9yRWFjaChncmFwaCA9PiB7XG4gICAgICAgICAgICAgICAgZ3JhcGguYW5vbnltb3VzID0gYW5vbnltb3VzSW5kZXg7XG4gICAgICAgICAgICAgICAgYW5vbnltb3VzSW5kZXgrKztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFBlcmFHcmFwaHMkLm5leHQocGVyYUdyYXBocyk7XG4gICAgICAgICAgICB0aGlzLmFycmF5Vmlld1NlcnZpY2UuY29tcGxldGVkUmVmcmVzaCQubmV4dCgpO1xuXG4gICAgICAgICAgICAvLyBQdXNoIHRoZSBuZXcgQ2hhcnQgdGl0bGUgc2VsZWN0aW9uIHRocm91Z2ggdGhlIFN1YmplY3QuXG4gICAgICAgICAgICB0aGlzLmFycmF5Vmlld1NlcnZpY2UuY2hhcnRUaXRsZVN1YmplY3QkLm5leHQodGhpcy5hcnJheVZpZXdTZXJ2aWNlLnNlbGVjdGVkQ2hhcnRUaXRsZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFdoZW5ldmVyIHdlIGdldCBuZXcgRlNDcyAob24gYW4gaW50ZXJ2YWwpIHB1c2ggdGhlbSBvdXQgdGhyb3VnaCB0aGUgc3ViamVjdCBzbyB0aGUgZ3JvdXBzIHJlY2VpdmUgdGhlIHVwZGF0ZWQgbWFwIG9mIEZTQ3NcbiAgICAgICAgdGhpcy5mbG93U2hlZXRTdWJzY3JpcHRpb24gPSB0aGlzLmZsb3dzaGVldHNBcGlTZXJ2aWNlLmdldEZsb3dTaGVldEludGVydmFsKCkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgZmxvd3NoZWV0cyA9PiB0aGlzLmZsb3dzaGVldHNBcGlTZXJ2aWNlLmdldEZsb3dTaGVldFN1YmplY3QoKS5uZXh0KGZsb3dzaGVldHMuYm9keSkpO1xuXG4gICAgICAgIC8vIFdoZW5ldmVyIHdlIGdldCBuZXcgcHJpb3Igd2FybmluZ3MgKG9uIGFuIGludGVydmFsKSBwdXNoIHRoZW0gb3V0IHRocm91Z2ggdGhlIHN1YmplY3Qgc28gdGhlIGdyb3VwcyByZWNlaXZlIHRoZSB1cGRhdGVkIG1hcCBvZiB3YXJuaW5nc1xuICAgICAgICBpZiAodGhpcy5wcmlvcldhcm5pbmdzQ29uZmlnU2VydmljZS5nZXRQcmlvcldhcm5pbmdFbmRQb2ludCgpKSB7XG4gICAgICAgICAgICB0aGlzLnByaW9yV2FybmluZ1N1YnNjcmlwdGlvbiA9IHRoaXMucHJpb3JXYXJuaW5nc0FwaVNlcnZpY2UuZ2V0UHJpb3JXYXJuaW5nSW50ZXJ2YWwoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgcHJpb3JXYXJuaW5ncyA9PiB0aGlzLnByaW9yV2FybmluZ3NBcGlTZXJ2aWNlLmdldFByaW9yV2FybmluZ1N1YmplY3QoKS5uZXh0KHByaW9yV2FybmluZ3MuYm9keSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdBZnRlclZpZXdDaGVja2VkKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5zY3JvbGxDb250YWluZXJXaWR0aCAhPT0gdGhpcy5nZXRTY3JvbGxDb250YWluZXJXaWR0aCgpKSB7XG4gICAgICAgICAgICB0aGlzLnNjcm9sbENvbnRhaW5lcldpZHRoID0gdGhpcy5nZXRTY3JvbGxDb250YWluZXJXaWR0aCgpO1xuICAgICAgICAgICAgaWYgKHRoaXMucmVmKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXNlZCB0byBkeW5hbWljYWxseSBzZXQgdGhlIHdpZHRoIG9mIHRoZSBzY3JvbGwgY29udGFpbmVyIChiYXNlZCBvbiB0aGUgd2lkdGggb2YgdGhlIGFycmF5IHZpZXcgY29tcG9uZW50KVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRTY3JvbGxDb250YWluZXJXaWR0aCgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCB3aWR0aCA9IHRoaXMuYXJyYXlWaWV3RWxlbWVudFJlZi5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuICAgICAgICAvLyBFbnN1cmUgdGhhdCB0aGUgY29udGFpbmVyIGhhcyBwYWRkaW5nXG4gICAgICAgIGNvbnN0IHBhZGRpbmcgPSB3aWR0aCAqIC4xMTtcbiAgICAgICAgLy8gR2V0IHRoZSBudW1iZXIgb2YgZ3JhcGhzIHRoYXQgd2Ugc2hvdWxkIGJlIGFibGUgdG8gZGlzcGxheSBpbiB0aGUgd2luZG93ICh0YWtpbmcgdGhlIHBhZGRpbmcgaW50byBhY2NvdW50KVxuICAgICAgICBjb25zdCBudW1HcmFwaHNJblJvdyA9IE1hdGguZmxvb3IoKHdpZHRoIC0gcGFkZGluZykgLyB0aGlzLmFycmF5Vmlld1NlcnZpY2UucGVyYUdyYXBoV2lkdGgpO1xuICAgICAgICAvLyBSZXR1cm4gdGhlIHdpZHRoXG4gICAgICAgIHJldHVybiBudW1HcmFwaHNJblJvdyAqIHRoaXMuYXJyYXlWaWV3U2VydmljZS5wZXJhR3JhcGhXaWR0aCArICdweCc7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoKSB7XG4gICAgICAgIHRoaXMudXBkYXRlQmVoYXZpb3JCYXNlZE9uSW5wdXRzKCk7XG4gICAgICAgIC8vIFRPRE8gdXBkYXRlIHRoaXMgd2hlbiB3ZSBhZGQgdGhlIGFiaWxpdHkgdG8gY2hhbmdlIHRoZSB0aXRsZS9ncm91cGluZy9zb3J0aW5nXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgZmllbGRzIGluIHRoZSBhcnJheSB2aWV3IHNlcnZpY2UgYW5kIGluIHRoaXMgY29tcG9uZW50IGJhc2VkIG9uIHRoZSBpbnB1dCBzbyB0aGF0IHdlIHNlZSB0aGUgZGVzaXJlZCBiZWhhdmlvclxuICAgICAqL1xuICAgIHByaXZhdGUgdXBkYXRlQmVoYXZpb3JCYXNlZE9uSW5wdXRzKCkge1xuICAgICAgICB0aGlzLmRpc2FibGVHcm91cHNJZkFwcHJvcHJpYXRlKCk7XG4gICAgICAgIHRoaXMuc2V0UGVyYUdyYXBoU29ydGluZ0Z1bmN0aW9uKCk7XG4gICAgICAgIHRoaXMudXBkYXRlUGVyYUdyYXBoRGltZW5zaW9ucygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIElmIHdlIHBhc3MgaW4gYW4gZXhwbGljaXQgd2lkdGgvaGVpZ2h0LCB1c2UgdGhlbVxuICAgICAqL1xuICAgIHByaXZhdGUgdXBkYXRlUGVyYUdyYXBoRGltZW5zaW9ucygpIHtcbiAgICAgICAgaWYgKHRoaXMucGVyYUdyYXBoSGVpZ2h0ICYmIHRoaXMucGVyYUdyYXBoV2lkdGgpIHtcbiAgICAgICAgICAgIHRoaXMuYXJyYXlWaWV3U2VydmljZS5wZXJhR3JhcGhXaWR0aCA9IHRoaXMucGVyYUdyYXBoV2lkdGg7XG4gICAgICAgICAgICB0aGlzLmFycmF5Vmlld1NlcnZpY2UucGVyYUdyYXBoSGVpZ2h0ID0gdGhpcy5wZXJhR3JhcGhIZWlnaHQ7XG4gICAgICAgICAgICB0aGlzLmFycmF5Vmlld1NlcnZpY2UucmVmcmVzaFZpZXdQb3J0KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIHNldHMgdGhlIGFycmF5IHZpZXcgc2VydmljZSdzIHNvcnRpbmcgZnVuY3Rpb24gdG8gdGhlIGlucHV0IHBhc3NlZCB0byB0aGUgYXJyYXkgdmlldyBjb21wb25lbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIHNldFBlcmFHcmFwaFNvcnRpbmdGdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMucGVyYUdyYXBoU29ydGluZ0Z1bmN0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLmFycmF5Vmlld1NlcnZpY2Uuc29ydEdyYXBocyA9IHRoaXMucGVyYUdyYXBoU29ydGluZ0Z1bmN0aW9uO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSWYgZ3JvdXBzIGFyZSBkaXNhYmxlZCBvciBhYnNlbnQsIGFkZCBhIHNpbmdsZSBncm91cCB0aGF0IHdpbGwgY2F0Y2ggYWxsIGdyYXBocyBhbmQgbm90IGRpc3BsYXkgYSBoZWFkZXJcbiAgICAgKi9cbiAgICBwcml2YXRlIGRpc2FibGVHcm91cHNJZkFwcHJvcHJpYXRlKCkge1xuICAgICAgICAvLyBJZiBncm91cHMgYXJlIGRpc2FibGVkIG9yIGlmIHdlIGRvbid0IGhhdmUgZ3JvdXBzXG4gICAgICAgIGlmICh0aGlzLmRpc2FibGVHcm91cHMgfHwgdGhpcy5ncm91cHMkID09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBzJCA9IG9mKFtbbnVsbCwgZnVuY3Rpb24gKHBlcmFHcmFwaDogUGVyYUdyYXBoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gbm90IHN1cmUgaWYgdGhpcyBpcyBuZWVkZWQgc2luY2Ugd2UgYXJlIHVzaW5nIGNvbWJpbmVkTGF0ZXN0IGFib3ZlIGJ1dCBJIGxlZnQgaXQganVzdCBpbiBjYXNlXG4gICAgLy8gcHVibGljIGZpbHRlckNoYW5nZWQoKSB7XG4gICAgLy8gICAvLyBHZXQgdGhlIGN1cnJlbnQgbGlzdCBvZiBQZXJhR3JhcGhzIHdpdGhvdXQgbWFraW5nIGFub3RoZXIgY2FsbFxuICAgIC8vICAgbGV0IHBlcmFHcmFwaHMgPSB0aGlzLnBlcmFncmFwaEFwaVNlcnZpY2UuZ2V0UGVyYUdyYXBoU3ViamVjdCgpLnZhbHVlO1xuICAgIC8vICAgLy8gRmlsdGVyIHRoZSBsaXN0IGFjY29yZGluZyB0byB0aGUgdXBkYXRlZCBtYXRjaGVzRmlsdGVyIGZ1bmN0aW9uIHdpdGhpbiB0aGUgYXJyYXlWaWV3IHNlcnZpY2VcbiAgICAvLyAgIHBlcmFHcmFwaHMgPSB0aGlzLmFycmF5Vmlld1NlcnZpY2UuZmlsdGVyUGVyYWdyYXBocyhwZXJhR3JhcGhzLCB0aGlzLmZpbHRlclNlcnZpY2UuYWN0aXZlRmlsdGVycylcbiAgICAvLyAgIC8vIFB1Ymxpc2ggcmVzdWx0IHRvIGFsbCBzdWJzY3JpYmluZyBncm91cHNcbiAgICAvLyAgIHRoaXMucGVyYWdyYXBoQXBpU2VydmljZS5nZXRQZXJhR3JhcGhTdWJqZWN0KCkubmV4dChwZXJhR3JhcGhzKTtcbiAgICAvLyB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVmKSB7XG4gICAgICAgICAgICB0aGlzLnJlZi5kZXRhY2goKTtcbiAgICAgICAgICAgIHRoaXMucmVmID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wZXJhR3JhcGhTdWJzY3JpcHRpb24gJiYgIXRoaXMucGVyYUdyYXBoU3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgICAgICAgdGhpcy5wZXJhR3JhcGhTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5mbG93U2hlZXRTdWJzY3JpcHRpb24gJiYgIXRoaXMuZmxvd1NoZWV0U3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgICAgICAgdGhpcy5mbG93U2hlZXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wcmlvcldhcm5pbmdTdWJzY3JpcHRpb24gJiYgIXRoaXMucHJpb3JXYXJuaW5nU3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgICAgICAgdGhpcy5wcmlvcldhcm5pbmdTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5maWx0ZXJlZFBlcmFHcmFwaHNTdWJzY3JpcHRpb24gJiYgIXRoaXMuZmlsdGVyZWRQZXJhR3JhcGhzJC5jbG9zZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRQZXJhR3JhcGhzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=