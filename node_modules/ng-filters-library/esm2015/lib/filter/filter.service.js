/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { LocationSelectorService } from './locations/location-selector.service';
import { Locations } from './model/locations';
import { FilterQueryRestService } from './query-filters/filter-query-rest.service';
import { SortService } from '../sort/sort.service';
import { SortChoices } from '../sort/SortEnum';
import { GroupService } from '../group/group.service';
import * as i0 from "@angular/core";
import * as i1 from "./locations/location-selector.service";
import * as i2 from "./query-filters/filter-query-rest.service";
import * as i3 from "../sort/sort.service";
import * as i4 from "../group/group.service";
/**
 * Manages the staging filters object -> the current status of the sidebar,
 * the active filters object -> the filters currently being applied to the array view,
 * and the subject which is used to update the array view when filters are applied.
 */
export class FilterService {
    /**
     * @param {?} locationSelectorService
     * @param {?} filterRestService
     * @param {?} sortService
     * @param {?} groupService
     */
    constructor(locationSelectorService, filterRestService, sortService, groupService) {
        this.locationSelectorService = locationSelectorService;
        this.filterRestService = filterRestService;
        this.sortService = sortService;
        this.groupService = groupService;
        /**
         * BehaviorSubject for when selected locations change.
         */
        this.locationsChanged = new BehaviorSubject({
            locations: new Locations(),
            executeFilterQuery: false,
        });
        /**
         * Filters actively applied to the array view.
         */
        this.activeFilters = {};
        /**
         * Filters currently selected in the sidebar but NOT applied.
         */
        this.stagingFilters = {};
        /**
         * visit numbers of patients filtered out by server side filters
         */
        this.serverFilteredVisits = [];
        /**
         * name of filter for server side filters
         */
        this.serverFilterName = 'query-filter';
        /**
         * criteria to build filter query from as currently represented in sidebar
         */
        this.stagedServerFilterCriteria = {};
        /**
         * criteria for server side filtering currently ACTIVE in array view
         */
        this._activeServerFilterCriteria = {};
        /**
         * Subject which is updated when filters are applied.
         */
        this.filterSubject$ = new BehaviorSubject(this.activeFilters);
    }
    /**
     * Adds a staged filter (prior to activating the filters)
     * @param {?} filterName Name of the filter to stage.
     * @param {?} filterFunction The filter function to stage.
     * @return {?}
     */
    stageFilter(filterName, filterFunction) {
        this.stagingFilters[filterName] = filterFunction;
    }
    /**
     * Removes a staged filter.
     * @param {?} filterName Name of filter to unstage.
     * @return {?}
     */
    unstageFilter(filterName) {
        delete this.stagingFilters[filterName];
    }
    /**
     * gets filter function that filters out patients based on criteria from conglomerated filter query
     * @return {?}
     */
    getServerSideFilterFunction() {
        /** @type {?} */
        const thisRef = this;
        return function (peragraph) {
            for (const vnm of thisRef.serverFilteredVisits) {
                if (vnm === peragraph.vnm) {
                    return true;
                }
            }
            return false;
        };
    }
    /**
     * add filter criteria to criteria object
     * @param {?} criteria - array of criteria to add to filter
     * @param {?} title - property name of criteria on the filterCriteria object -> MUST match a
     * QueryParam in the REST call located in common.FilterController or it won't be applied
     * @return {?}
     */
    stageServerFilterCriteria(criteria, title) {
        this.stagedServerFilterCriteria[title] = criteria;
        this.stageFilter(this.serverFilterName, this.getServerSideFilterFunction());
    }
    /**
     * removes a criteria object from the filter criteria object
     * if no criterion remain, the filter is removed from the staged filters
     * @param {?} title - name of the criteria to be removed
     * @return {?}
     */
    removeStagedServerCriteria(title) {
        delete this.stagedServerFilterCriteria[title];
        if (Object.keys(this.stagedServerFilterCriteria).length === 0) {
            this.unstageFilter(this.serverFilterName);
        }
    }
    /**
     * return staged server side filter parameters
     * @return {?}
     */
    getStagedServerSideFilterCriteria() {
        return this.stagedServerFilterCriteria;
    }
    /**
     * returns a function which returns the current active filters at the given time
     * @return {?}
     */
    getActiveServerFilterCriteria() {
        /** @type {?} */
        const filterServiceRef = this;
        return function () {
            return filterServiceRef._activeServerFilterCriteria;
        };
    }
    /**
     * what to do if sidebar is destroyed
     * @return {?}
     */
    clearAllFilters() {
        this.activeFilters = {};
        this.stagingFilters = {};
        this.serverFilteredVisits = [];
        this.stagedServerFilterCriteria = {};
        this._activeServerFilterCriteria = {};
        this.filterSubject$.next({});
        this.groupService.clearGroupBy();
        this.sortService.clearSort();
    }
    /**
     * Activate the staged filters
     *
     * 2 seperate paths:
     *      A. Location changes -> refresh graphs is called after changing the endpoint parameters and a variable is passed in
     *                              to let refresh changes know if the server side filter needs to be refreshed
     *      B. No location changes -> If the server side filtering needs to be refreshed, its REST call is initiated before client side filtering occurs,
     *                              otherwise client side filtering occurs immediatley on existing graphs
     * @return {?}
     */
    activateFilters() {
        // close appropriate groups if changing, filters, group by, or sort
        this.groupService.changeGroupsClosed = true;
        // set staged sort to active
        this.sortService.activeSortFunction = this.sortService.getStagedSortFunction();
        this.sortService.activeSortName = this.sortService.stagedSortName;
        // set staged filters to active filters
        this.activeFilters = {};
        for (const filter in this.stagingFilters) {
            if (this.stagingFilters.hasOwnProperty(filter)) {
                this.activeFilters[filter] = this.stagingFilters[filter];
            }
        }
        // set staged server side filtering query parameters to active
        this._activeServerFilterCriteria = {};
        for (const criteria in this.stagedServerFilterCriteria) {
            if (this.stagedServerFilterCriteria.hasOwnProperty(criteria)) {
                this._activeServerFilterCriteria[criteria] = this.stagedServerFilterCriteria[criteria];
            }
        }
        /** @type {?} */
        const executeQuery = this.activeFilters.hasOwnProperty(this.serverFilterName);
        // Check if unit selection has changed
        if (!this.locationSelectorService.isLocationSelectionTheSame() || this.sortService.activeSortName === SortChoices.RIScore || this.groupService.stagedGroup.groupName !== this.groupService.activeGroup.groupName) {
            this.groupService.activeGroup = this.groupService.stagedGroup;
            this.groupService.groupSubject$.next(this.groupService.activeGroup.lanes);
            /** @type {?} */
            const selectedLocations = this.locationSelectorService.getLocationsToFilter();
            // Signal that location selections have changed and whether or not to execute the filter query
            this.locationsChanged.next({ locations: selectedLocations, executeFilterQuery: executeQuery });
        }
        else {
            // if filter query needs to be executed, wait for it to return before filtering the graphs in the client
            if (executeQuery) {
                this.filterRestService.getFilteredVisits(this.getActiveServerFilterCriteria()).subscribe((visits) => {
                    this.serverFilteredVisits = visits;
                    this.filterSubject$.next(this.activeFilters);
                });
            }
            else {
                // pass the filter subject with the updated filters
                setTimeout(() => this.filterSubject$.next(this.activeFilters), 500);
            }
        }
    }
}
FilterService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
FilterService.ctorParameters = () => [
    { type: LocationSelectorService },
    { type: FilterQueryRestService },
    { type: SortService },
    { type: GroupService }
];
/** @nocollapse */ FilterService.ngInjectableDef = i0.defineInjectable({ factory: function FilterService_Factory() { return new FilterService(i0.inject(i1.LocationSelectorService), i0.inject(i2.FilterQueryRestService), i0.inject(i3.SortService), i0.inject(i4.GroupService)); }, token: FilterService, providedIn: "root" });
if (false) {
    /**
     * BehaviorSubject for when selected locations change.
     * @type {?}
     */
    FilterService.prototype.locationsChanged;
    /**
     * Filters actively applied to the array view.
     * @type {?}
     */
    FilterService.prototype.activeFilters;
    /**
     * Filters currently selected in the sidebar but NOT applied.
     * @type {?}
     */
    FilterService.prototype.stagingFilters;
    /**
     * visit numbers of patients filtered out by server side filters
     * @type {?}
     */
    FilterService.prototype.serverFilteredVisits;
    /**
     * name of filter for server side filters
     * @type {?}
     */
    FilterService.prototype.serverFilterName;
    /**
     * criteria to build filter query from as currently represented in sidebar
     * @type {?}
     */
    FilterService.prototype.stagedServerFilterCriteria;
    /**
     * criteria for server side filtering currently ACTIVE in array view
     * @type {?}
     */
    FilterService.prototype._activeServerFilterCriteria;
    /**
     * Subject which is updated when filters are applied.
     * @type {?}
     */
    FilterService.prototype.filterSubject$;
    /** @type {?} */
    FilterService.prototype.locationSelectorService;
    /** @type {?} */
    FilterService.prototype.filterRestService;
    /** @type {?} */
    FilterService.prototype.sortService;
    /** @type {?} */
    FilterService.prototype.groupService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1maWx0ZXJzLWxpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvZmlsdGVyL2ZpbHRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFckMsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFDOUUsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQzVDLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLDJDQUEyQyxDQUFDO0FBQ2pGLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDN0MsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLHdCQUF3QixDQUFDOzs7Ozs7Ozs7OztBQVVwRCxNQUFNOzs7Ozs7O0lBcUNKLFlBQW9CLHVCQUFnRCxFQUNoRCxtQkFDQSxhQUNBO1FBSEEsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxzQkFBaUIsR0FBakIsaUJBQWlCO1FBQ2pCLGdCQUFXLEdBQVgsV0FBVztRQUNYLGlCQUFZLEdBQVosWUFBWTs7OztnQ0FyQ04sSUFBSSxlQUFlLENBQXdEO1lBQ25HLFNBQVMsRUFBRSxJQUFJLFNBQVMsRUFBRTtZQUMxQixrQkFBa0IsRUFBRSxLQUFLO1NBQzFCLENBQUM7Ozs7NkJBR3FCLEVBQUU7Ozs7OEJBR0EsRUFBRTs7OztvQ0FLYSxFQUFFOzs7O2dDQUtmLGNBQWM7Ozs7MENBS0osRUFBRTs7OzsyQ0FLRCxFQUFFOzs7OzhCQUdoQixJQUFJLGVBQWUsQ0FBTSxJQUFJLENBQUMsYUFBYSxDQUFDO0tBTW5FOzs7Ozs7O0lBT0QsV0FBVyxD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QUFrQixFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7U0FDOUY7UUFBQyxJQUFJLENBQUMsQ0FBQzs7WUFFTixFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUNqQixJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLDZCQUE2QixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFnQixFQUFFLEVBQUU7b0JBQzVHLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxNQUFNLENBQUM7b0JBQ25DLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztpQkFDOUMsQ0FBQyxDQUFDO2FBQ0o7WUFBQyxJQUFJLENBQUMsQ0FBQzs7Z0JBRU4sVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUNyRTtTQUNGO0tBQ0Y7OztZQTFMRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFkTyx1QkFBdUI7WUFFdkIsc0JBQXNCO1lBQ3RCLFdBQVc7WUFFWCxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QmVoYXZpb3JTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7UGVyYUdyYXBofSBmcm9tICduZy1jb21tb24tbGlicmFyeSc7XG5pbXBvcnQge0xvY2F0aW9uU2VsZWN0b3JTZXJ2aWNlfSBmcm9tICcuL2xvY2F0aW9ucy9sb2NhdGlvbi1zZWxlY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7TG9jYXRpb25zfSBmcm9tICcuL21vZGVsL2xvY2F0aW9ucyc7XG5pbXBvcnQge0ZpbHRlclF1ZXJ5UmVzdFNlcnZpY2V9IGZyb20gJy4vcXVlcnktZmlsdGVycy9maWx0ZXItcXVlcnktcmVzdC5zZXJ2aWNlJztcbmltcG9ydCB7U29ydFNlcnZpY2V9IGZyb20gJy4uL3NvcnQvc29ydC5zZXJ2aWNlJztcbmltcG9ydCB7U29ydENob2ljZXN9IGZyb20gJy4uL3NvcnQvU29ydEVudW0nO1xuaW1wb3J0IHtHcm91cFNlcnZpY2V9IGZyb20gJy4uL2dyb3VwL2dyb3VwLnNlcnZpY2UnO1xuXG4vKipcbiAqIE1hbmFnZXMgdGhlIHN0YWdpbmcgZmlsdGVycyBvYmplY3QgLT4gdGhlIGN1cnJlbnQgc3RhdHVzIG9mIHRoZSBzaWRlYmFyLFxuICogdGhlIGFjdGl2ZSBmaWx0ZXJzIG9iamVjdCAtPiB0aGUgZmlsdGVycyBjdXJyZW50bHkgYmVpbmcgYXBwbGllZCB0byB0aGUgYXJyYXkgdmlldyxcbiAqIGFuZCB0aGUgc3ViamVjdCB3aGljaCBpcyB1c2VkIHRvIHVwZGF0ZSB0aGUgYXJyYXkgdmlldyB3aGVuIGZpbHRlcnMgYXJlIGFwcGxpZWQuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEZpbHRlclNlcnZpY2Uge1xuXG4gIC8qKiBCZWhhdmlvclN1YmplY3QgZm9yIHdoZW4gc2VsZWN0ZWQgbG9jYXRpb25zIGNoYW5nZS4gKi9cbiAgcHVibGljIGxvY2F0aW9uc0NoYW5nZWQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHsgbG9jYXRpb25zOiBMb2NhdGlvbnMsIGV4ZWN1dGVGaWx0ZXJRdWVyeTogYm9vbGVhbiB9Pih7XG4gICAgbG9jYXRpb25zOiBuZXcgTG9jYXRpb25zKCksXG4gICAgZXhlY3V0ZUZpbHRlclF1ZXJ5OiBmYWxzZSxcbiAgfSk7XG5cbiAgLyoqIEZpbHRlcnMgYWN0aXZlbHkgYXBwbGllZCB0byB0aGUgYXJyYXkgdmlldy4gKi9cbiAgcHVibGljIGFjdGl2ZUZpbHRlcnMgPSB7fTtcblxuICAvKiogRmlsdGVycyBjdXJyZW50bHkgc2VsZWN0ZWQgaW4gdGhlIHNpZGViYXIgYnV0IE5PVCBhcHBsaWVkLiAqL1xuICBwcml2YXRlIHN0YWdpbmdGaWx0ZXJzID0ge307XG5cbiAgLyoqXG4gICAqIHZpc2l0IG51bWJlcnMgb2YgcGF0aWVudHMgZmlsdGVyZWQgb3V0IGJ5IHNlcnZlciBzaWRlIGZpbHRlcnNcbiAgICovXG4gIHB1YmxpYyBzZXJ2ZXJGaWx0ZXJlZFZpc2l0czogc3RyaW5nW10gPSBbXTtcblxuICAvKipcbiAgICogbmFtZSBvZiBmaWx0ZXIgZm9yIHNlcnZlciBzaWRlIGZpbHRlcnNcbiAgICovXG4gIHByaXZhdGUgc2VydmVyRmlsdGVyTmFtZSA9ICdxdWVyeS1maWx0ZXInO1xuXG4gIC8qKlxuICAgKiBjcml0ZXJpYSB0byBidWlsZCBmaWx0ZXIgcXVlcnkgZnJvbSBhcyBjdXJyZW50bHkgcmVwcmVzZW50ZWQgaW4gc2lkZWJhclxuICAgKi9cbiAgcHJpdmF0ZSBzdGFnZWRTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSA9IHt9O1xuXG4gIC8qKlxuICAgKiBjcml0ZXJpYSBmb3Igc2VydmVyIHNpZGUgZmlsdGVyaW5nIGN1cnJlbnRseSBBQ1RJVkUgaW4gYXJyYXkgdmlld1xuICAgKi9cbiAgcHJpdmF0ZSBfYWN0aXZlU2VydmVyRmlsdGVyQ3JpdGVyaWEgPSB7fTtcblxuICAvKiogU3ViamVjdCB3aGljaCBpcyB1cGRhdGVkIHdoZW4gZmlsdGVycyBhcmUgYXBwbGllZC4gKi9cbiAgcHVibGljIGZpbHRlclN1YmplY3QkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnk+KHRoaXMuYWN0aXZlRmlsdGVycyk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2NhdGlvblNlbGVjdG9yU2VydmljZTogTG9jYXRpb25TZWxlY3RvclNlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgZmlsdGVyUmVzdFNlcnZpY2U6IEZpbHRlclF1ZXJ5UmVzdFNlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgc29ydFNlcnZpY2U6IFNvcnRTZXJ2aWNlLFxuICAgICAgICAgICAgICBwcml2YXRlIGdyb3VwU2VydmljZTogR3JvdXBTZXJ2aWNlKSB7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0YWdlZCBmaWx0ZXIgKHByaW9yIHRvIGFjdGl2YXRpbmcgdGhlIGZpbHRlcnMpXG4gICAqIEBwYXJhbSBmaWx0ZXJOYW1lIE5hbWUgb2YgdGhlIGZpbHRlciB0byBzdGFnZS5cbiAgICogQHBhcmFtIGZpbHRlckZ1bmN0aW9uIFRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gc3RhZ2UuXG4gICAqL1xuICBzdGFnZUZpbHRlcihmaWx0ZXJOYW1lOiBzdHJpbmcsIGZpbHRlckZ1bmN0aW9uOiAocGVyYWdyYXBoOiBQZXJhR3JhcGgpID0+IGJvb2xlYW4pIHtcbiAgICB0aGlzLnN0YWdpbmdGaWx0ZXJzW2ZpbHRlck5hbWVdID0gZmlsdGVyRnVuY3Rpb247XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhIHN0YWdlZCBmaWx0ZXIuXG4gICAqIEBwYXJhbSBmaWx0ZXJOYW1lIE5hbWUgb2YgZmlsdGVyIHRvIHVuc3RhZ2UuXG4gICAqL1xuICB1bnN0YWdlRmlsdGVyKGZpbHRlck5hbWU6IHN0cmluZykge1xuICAgIGRlbGV0ZSB0aGlzLnN0YWdpbmdGaWx0ZXJzW2ZpbHRlck5hbWVdO1xuICB9XG5cbiAgLyoqXG4gICAqIGdldHMgZmlsdGVyIGZ1bmN0aW9uIHRoYXQgZmlsdGVycyBvdXQgcGF0aWVudHMgYmFzZWQgb24gY3JpdGVyaWEgZnJvbSBjb25nbG9tZXJhdGVkIGZpbHRlciBxdWVyeVxuICAgKi9cbiAgZ2V0U2VydmVyU2lkZUZpbHRlckZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHRoaXNSZWYgPSB0aGlzO1xuICAgIHJldHVybiBmdW5jdGlvbiAocGVyYWdyYXBoOiBQZXJhR3JhcGgpOiBib29sZWFuIHtcbiAgICAgIGZvciAoY29uc3Qgdm5tIG9mIHRoaXNSZWYuc2VydmVyRmlsdGVyZWRWaXNpdHMpIHtcbiAgICAgICAgaWYgKHZubSA9PT0gcGVyYWdyYXBoLnZubSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBhZGQgZmlsdGVyIGNyaXRlcmlhIHRvIGNyaXRlcmlhIG9iamVjdFxuICAgKiBAcGFyYW0gY3JpdGVyaWEgLSBhcnJheSBvZiBjcml0ZXJpYSB0byBhZGQgdG8gZmlsdGVyXG4gICAqIEBwYXJhbSB0aXRsZSAtIHByb3BlcnR5IG5hbWUgb2YgY3JpdGVyaWEgb24gdGhlIGZpbHRlckNyaXRlcmlhIG9iamVjdCAtPiBNVVNUIG1hdGNoIGFcbiAgICogUXVlcnlQYXJhbSBpbiB0aGUgUkVTVCBjYWxsIGxvY2F0ZWQgaW4gY29tbW9uLkZpbHRlckNvbnRyb2xsZXIgb3IgaXQgd29uJ3QgYmUgYXBwbGllZFxuICAgKi9cbiAgc3RhZ2VTZXJ2ZXJGaWx0ZXJDcml0ZXJpYShjcml0ZXJpYTogQXJyYXk8c3RyaW5nPiwgdGl0bGU6IHN0cmluZykge1xuICAgIHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWFbdGl0bGVdID0gY3JpdGVyaWE7XG4gICAgdGhpcy5zdGFnZUZpbHRlcih0aGlzLnNlcnZlckZpbHRlck5hbWUsIHRoaXMuZ2V0U2VydmVyU2lkZUZpbHRlckZ1bmN0aW9uKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIHJlbW92ZXMgYSBjcml0ZXJpYSBvYmplY3QgZnJvbSB0aGUgZmlsdGVyIGNyaXRlcmlhIG9iamVjdFxuICAgKiBpZiBubyBjcml0ZXJpb24gcmVtYWluLCB0aGUgZmlsdGVyIGlzIHJlbW92ZWQgZnJvbSB0aGUgc3RhZ2VkIGZpbHRlcnNcbiAgICogQHBhcmFtIHRpdGxlIC0gbmFtZSBvZiB0aGUgY3JpdGVyaWEgdG8gYmUgcmVtb3ZlZFxuICAgKi9cbiAgcmVtb3ZlU3RhZ2VkU2VydmVyQ3JpdGVyaWEodGl0bGU6IHN0cmluZykge1xuICAgIGRlbGV0ZSB0aGlzLnN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhW3RpdGxlXTtcbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5zdGFnZWRTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSkubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLnVuc3RhZ2VGaWx0ZXIodGhpcy5zZXJ2ZXJGaWx0ZXJOYW1lKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogcmV0dXJuIHN0YWdlZCBzZXJ2ZXIgc2lkZSBmaWx0ZXIgcGFyYW1ldGVyc1xuICAgKi9cbiAgZ2V0U3RhZ2VkU2VydmVyU2lkZUZpbHRlckNyaXRlcmlhKCkge1xuICAgIHJldHVybiB0aGlzLnN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhO1xuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybnMgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIHRoZSBjdXJyZW50IGFjdGl2ZSBmaWx0ZXJzIGF0IHRoZSBnaXZlbiB0aW1lXG4gICAqL1xuICBnZXRBY3RpdmVTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSgpOiB7fSB7XG4gICAgY29uc3QgZmlsdGVyU2VydmljZVJlZiA9IHRoaXM7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpOiB7fSB7XG4gICAgICByZXR1cm4gZmlsdGVyU2VydmljZVJlZi5fYWN0aXZlU2VydmVyRmlsdGVyQ3JpdGVyaWE7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiB3aGF0IHRvIGRvIGlmIHNpZGViYXIgaXMgZGVzdHJveWVkXG4gICAqL1xuICBjbGVhckFsbEZpbHRlcnMoKSB7XG4gICAgdGhpcy5hY3RpdmVGaWx0ZXJzID0ge307XG4gICAgdGhpcy5zdGFnaW5nRmlsdGVycyA9IHt9O1xuICAgIHRoaXMuc2VydmVyRmlsdGVyZWRWaXNpdHMgPSBbXTtcbiAgICB0aGlzLnN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhID0ge307XG4gICAgdGhpcy5fYWN0aXZlU2VydmVyRmlsdGVyQ3JpdGVyaWEgPSB7fTtcbiAgICB0aGlzLmZpbHRlclN1YmplY3QkLm5leHQoe30pO1xuICAgIHRoaXMuZ3JvdXBTZXJ2aWNlLmNsZWFyR3JvdXBCeSgpO1xuICAgIHRoaXMuc29ydFNlcnZpY2UuY2xlYXJTb3J0KCk7XG4gIH1cblxuICAvKipcbiAgICogQWN0aXZhdGUgdGhlIHN0YWdlZCBmaWx0ZXJzXG4gICAqXG4gICAqIDIgc2VwZXJhdGUgcGF0aHM6XG4gICAqICAgICAgQS4gTG9jYXRpb24gY2hhbmdlcyAtPiByZWZyZXNoIGdyYXBocyBpcyBjYWxsZWQgYWZ0ZXIgY2hhbmdpbmcgdGhlIGVuZHBvaW50IHBhcmFtZXRlcnMgYW5kIGEgdmFyaWFibGUgaXMgcGFzc2VkIGluXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gbGV0IHJlZnJlc2ggY2hhbmdlcyBrbm93IGlmIHRoZSBzZXJ2ZXIgc2lkZSBmaWx0ZXIgbmVlZHMgdG8gYmUgcmVmcmVzaGVkXG4gICAqICAgICAgQi4gTm8gbG9jYXRpb24gY2hhbmdlcyAtPiBJZiB0aGUgc2VydmVyIHNpZGUgZmlsdGVyaW5nIG5lZWRzIHRvIGJlIHJlZnJlc2hlZCwgaXRzIFJFU1QgY2FsbCBpcyBpbml0aWF0ZWQgYmVmb3JlIGNsaWVudCBzaWRlIGZpbHRlcmluZyBvY2N1cnMsXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXJ3aXNlIGNsaWVudCBzaWRlIGZpbHRlcmluZyBvY2N1cnMgaW1tZWRpYXRsZXkgb24gZXhpc3RpbmcgZ3JhcGhzXG4gICAqL1xuICBhY3RpdmF0ZUZpbHRlcnMoKSB7XG4gICAgLy8gY2xvc2UgYXBwcm9wcmlhdGUgZ3JvdXBzIGlmIGNoYW5naW5nLCBmaWx0ZXJzLCBncm91cCBieSwgb3Igc29ydFxuICAgIHRoaXMuZ3JvdXBTZXJ2aWNlLmNoYW5nZUdyb3Vwc0Nsb3NlZCA9IHRydWU7XG4gICAgLy8gc2V0IHN0YWdlZCBzb3J0IHRvIGFjdGl2ZVxuICAgIHRoaXMuc29ydFNlcnZpY2UuYWN0aXZlU29ydEZ1bmN0aW9uID0gdGhpcy5zb3J0U2VydmljZS5nZXRTdGFnZWRTb3J0RnVuY3Rpb24oKTtcbiAgICB0aGlzLnNvcnRTZXJ2aWNlLmFjdGl2ZVNvcnROYW1lID0gdGhpcy5zb3J0U2VydmljZS5zdGFnZWRTb3J0TmFtZTtcblxuICAgIC8vIHNldCBzdGFnZWQgZmlsdGVycyB0byBhY3RpdmUgZmlsdGVyc1xuICAgIHRoaXMuYWN0aXZlRmlsdGVycyA9IHt9O1xuICAgIGZvciAoY29uc3QgZmlsdGVyIGluIHRoaXMuc3RhZ2luZ0ZpbHRlcnMpIHtcbiAgICAgIGlmICh0aGlzLnN0YWdpbmdGaWx0ZXJzLmhhc093blByb3BlcnR5KGZpbHRlcikpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVGaWx0ZXJzW2ZpbHRlcl0gPSB0aGlzLnN0YWdpbmdGaWx0ZXJzW2ZpbHRlcl07XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHNldCBzdGFnZWQgc2VydmVyIHNpZGUgZmlsdGVyaW5nIHF1ZXJ5IHBhcmFtZXRlcnMgdG8gYWN0aXZlXG4gICAgdGhpcy5fYWN0aXZlU2VydmVyRmlsdGVyQ3JpdGVyaWEgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGNyaXRlcmlhIGluIHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWEpIHtcbiAgICAgIGlmICh0aGlzLnN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhLmhhc093blByb3BlcnR5KGNyaXRlcmlhKSkge1xuICAgICAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJGaWx0ZXJDcml0ZXJpYVtjcml0ZXJpYV0gPSB0aGlzLnN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhW2NyaXRlcmlhXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBjaGVjayBpZiB0aGUgZmlsdGVyIHF1ZXJ5IG5lZWRzIHRvIGJlIHJ1blxuICAgIGNvbnN0IGV4ZWN1dGVRdWVyeSA9IHRoaXMuYWN0aXZlRmlsdGVycy5oYXNPd25Qcm9wZXJ0eSh0aGlzLnNlcnZlckZpbHRlck5hbWUpO1xuXG4gICAgLy8gQ2hlY2sgaWYgdW5pdCBzZWxlY3Rpb24gaGFzIGNoYW5nZWRcbiAgICBpZiAoIXRoaXMubG9jYXRpb25TZWxlY3RvclNlcnZpY2UuaXNMb2NhdGlvblNlbGVjdGlvblRoZVNhbWUoKSB8fCB0aGlzLnNvcnRTZXJ2aWNlLmFjdGl2ZVNvcnROYW1lID09PSBTb3J0Q2hvaWNlcy5SSVNjb3JlIHx8IHRoaXMuZ3JvdXBTZXJ2aWNlLnN0YWdlZEdyb3VwLmdyb3VwTmFtZSAhPT0gdGhpcy5ncm91cFNlcnZpY2UuYWN0aXZlR3JvdXAuZ3JvdXBOYW1lKSB7XG4gICAgICB0aGlzLmdyb3VwU2VydmljZS5hY3RpdmVHcm91cCA9IHRoaXMuZ3JvdXBTZXJ2aWNlLnN0YWdlZEdyb3VwO1xuICAgICAgdGhpcy5ncm91cFNlcnZpY2UuZ3JvdXBTdWJqZWN0JC5uZXh0KHRoaXMuZ3JvdXBTZXJ2aWNlLmFjdGl2ZUdyb3VwLmxhbmVzKTtcbiAgICAgIC8vIGdldCBzZWxlY3RlZCB1bml0IGFuZCBmYWNpbGl0eSBpZHNcbiAgICAgIGNvbnN0IHNlbGVjdGVkTG9jYXRpb25zOiBMb2NhdGlvbnMgPSB0aGlzLmxvY2F0aW9uU2VsZWN0b3JTZXJ2aWNlLmdldExvY2F0aW9uc1RvRmlsdGVyKCk7XG4gICAgICAvLyBTaWduYWwgdGhhdCBsb2NhdGlvbiBzZWxlY3Rpb25zIGhhdmUgY2hhbmdlZCBhbmQgd2hldGhlciBvciBub3QgdG8gZXhlY3V0ZSB0aGUgZmlsdGVyIHF1ZXJ5XG4gICAgICB0aGlzLmxvY2F0aW9uc0NoYW5nZWQubmV4dCh7bG9jYXRpb25zOiBzZWxlY3RlZExvY2F0aW9ucywgZXhlY3V0ZUZpbHRlclF1ZXJ5OiBleGVjdXRlUXVlcnl9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaWYgZmlsdGVyIHF1ZXJ5IG5lZWRzIHRvIGJlIGV4ZWN1dGVkLCB3YWl0IGZvciBpdCB0byByZXR1cm4gYmVmb3JlIGZpbHRlcmluZyB0aGUgZ3JhcGhzIGluIHRoZSBjbGllbnRcbiAgICAgIGlmIChleGVjdXRlUXVlcnkpIHtcbiAgICAgICAgdGhpcy5maWx0ZXJSZXN0U2VydmljZS5nZXRGaWx0ZXJlZFZpc2l0cyh0aGlzLmdldEFjdGl2ZVNlcnZlckZpbHRlckNyaXRlcmlhKCkpLnN1YnNjcmliZSgodmlzaXRzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgICAgIHRoaXMuc2VydmVyRmlsdGVyZWRWaXNpdHMgPSB2aXNpdHM7XG4gICAgICAgICAgdGhpcy5maWx0ZXJTdWJqZWN0JC5uZXh0KHRoaXMuYWN0aXZlRmlsdGVycyk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gcGFzcyB0aGUgZmlsdGVyIHN1YmplY3Qgd2l0aCB0aGUgdXBkYXRlZCBmaWx0ZXJzXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5maWx0ZXJTdWJqZWN0JC5uZXh0KHRoaXMuYWN0aXZlRmlsdGVycyksIDUwMCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=