/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { EventEmitter, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class LocationSelectorService {
    constructor() {
        this.loadedLocations = new Subject();
        this.selectAll = new EventEmitter();
        this.deselectAll = new EventEmitter();
        this.checkForIndeterminate = new EventEmitter();
        this.expandUnitsList = new EventEmitter();
        this.collapseUnitsList = new EventEmitter();
        this.selectedUnits = [];
        this.previousUnits = [];
    }
    /**
     * @param {?} unitID
     * @return {?}
     */
    checkUnitSelection(unitID) {
        for (const unit of this.selectedUnits) {
            if (unitID === unit.key.unitID) {
                return true;
            }
        }
        return false;
    }
    /**
     * @param {?} unit
     * @return {?}
     */
    selectUnit(unit) {
        if (this.selectedUnits.indexOf(unit) < 0) {
            this.selectedUnits.push(unit);
        }
        this.checkForIndeterminate.emit(unit.key.facilityID);
    }
    /**
     * @param {?} unit
     * @return {?}
     */
    deselectUnit(unit) {
        /** @type {?} */
        const index = this.selectedUnits.indexOf(unit);
        if (index !== -1) {
            this.selectedUnits.splice(index, 1);
        }
        this.checkForIndeterminate.emit(unit.key.facilityID);
    }
    /**
     * @param {?} facility
     * @return {?}
     */
    selectAllUnitsFromAFacility(facility) {
        for (const unit of this.units) {
            if (unit.key.facilityID === facility.facilityID && this.selectedUnits.indexOf(unit) < 0) {
                this.selectedUnits.push(unit);
            }
        }
    }
    /**
     * @param {?} facility
     * @return {?}
     */
    deselectAllUnitsFromAFacility(facility) {
        for (const unit of this.units) {
            if (unit.key.facilityID === facility.facilityID) {
                /** @type {?} */
                const index = this.selectedUnits.indexOf(unit);
                if (index !== -1) {
                    this.selectedUnits.splice(index, 1);
                }
            }
        }
    }
    /**
     * Check if previous units and selected units are the same
     * @return {?}
     */
    isLocationSelectionTheSame() {
        // quickest way to decide
        if (this.selectedUnits.length !== this.previousUnits.length) {
            return false;
        }
        // check if every unit from selected units exists in previous units
        for (const unit of this.selectedUnits) {
            /** @type {?} */
            let found = false;
            for (const u of this.previousUnits) {
                // match on facility id and unit id
                if (u.key.facilityID === unit.key.facilityID && u.key.unitID === unit.key.unitID) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                return false;
            }
        }
        // check if every unit from previous units exists in selected units
        for (const unit of this.previousUnits) {
            /** @type {?} */
            let found = false;
            for (const u of this.selectedUnits) {
                // match on facility id and unit id
                if (u.key.facilityID === unit.key.facilityID && u.key.unitID === unit.key.unitID) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                return false;
            }
        }
        return true;
    }
    /**
     * @param {?} facilityId
     * @return {?}
     */
    getUnitCountForFacility(facilityId) {
        /** @type {?} */
        let unitCount = 0;
        for (const u of this.units) {
            if (u.key.facilityID === facilityId) {
                unitCount++;
            }
        }
        return unitCount;
    }
    /**
     * Builds string []s for change of peragraph and FLC REST calls when filtering
     * @return {?}
     */
    getLocationsToFilter() {
        /** @type {?} */
        const selectedLocations = { facilities: [], units: [] };
        for (const u of this.selectedUnits) {
            selectedLocations.units.push(u.key.unitID);
            if (selectedLocations.facilities.indexOf(u.key.facilityID) < 0) {
                selectedLocations.facilities.push(u.key.facilityID);
            }
        }
        /** *
         * If any of the facilities in the selectedLocations are "indeterminate"
         *  then we must supply the list of units. Otherwise we can specify "*"
         *  for the units which makes the rest / sql calls run faster.
          @type {?} */
        let foundIndeterminateFacility = false;
        for (const fId of selectedLocations.facilities) {
            if (this.indeterminateFacilities.indexOf(fId) >= 0) {
                foundIndeterminateFacility = true;
                // It only takes one...
                break;
            }
        }
        if (!foundIndeterminateFacility) {
            selectedLocations.units = ['*'];
        }
        return selectedLocations;
    }
    /**
     * @param {?} facilityID
     * @param {?} isIndeterminate
     * @return {?}
     */
    setFacilityIndeterminateState(facilityID, isIndeterminate) {
        if (isIndeterminate) {
            this.indeterminateFacilities.push(facilityID);
        }
        else {
            if (this.indeterminateFacilities.indexOf(facilityID) >= 0) {
                this.indeterminateFacilities.splice(this.indeterminateFacilities.indexOf(facilityID), 1);
            }
        }
    }
    /**
     * @return {?}
     */
    clearIndeterminateFacilities() {
        this.indeterminateFacilities = [];
    }
}
LocationSelectorService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
LocationSelectorService.ctorParameters = () => [];
/** @nocollapse */ LocationSelectorService.ngInjectableDef = i0.defineInjectable({ factory: function LocationSelectorService_Factory() { return new LocationSelectorService(); }, token: LocationSelectorService, providedIn: "root" });
if (false) {
    /** @type {?} */
    LocationSelectorService.prototype.loadedLocations;
    /** @type {?} */
    LocationSelectorService.prototype.facilities;
    /** @type {?} */
    LocationSelectorService.prototype.units;
    /**
     * Facilities that do not have all of their units selected
     *  This is useful when setting up the rest call
     *  NOTE: I thought about making facilities a map and putting units
     *       as the value, but the REST call just takes the list of facilities
     *       and units.. so it really is all units or some units with the call.
     * @type {?}
     */
    LocationSelectorService.prototype.indeterminateFacilities;
    /** @type {?} */
    LocationSelectorService.prototype.selectAll;
    /** @type {?} */
    LocationSelectorService.prototype.deselectAll;
    /** @type {?} */
    LocationSelectorService.prototype.checkForIndeterminate;
    /** @type {?} */
    LocationSelectorService.prototype.expandUnitsList;
    /** @type {?} */
    LocationSelectorService.prototype.collapseUnitsList;
    /** @type {?} */
    LocationSelectorService.prototype.selectedUnits;
    /** @type {?} */
    LocationSelectorService.prototype.previousUnits;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRpb24tc2VsZWN0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWZpbHRlcnMtbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9maWx0ZXIvbG9jYXRpb25zL2xvY2F0aW9uLXNlbGVjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxZQUFZLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBSXZELE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxNQUFNLENBQUM7O0FBSzdCLE1BQU07SUE2Qko7K0JBM0J5QixJQUFJLE9BQU8sRUFBUTt5QkFhaEMsSUFBSSxZQUFZLEVBQVk7MkJBRTFCLElBQUksWUFBWSxFQUFZO3FDQUVsQixJQUFJLFlBQVksRUFBVTsrQkFFaEMsSUFBSSxZQUFZLEVBQVE7aUNBRXRCLElBQUksWUFBWSxFQUFROzZCQUVwQixFQUFFOzZCQUVGLEVBQUU7S0FHekI7Ozs7O0lBRUQsa0JBQWtCLENBQUMsTUFBYztRQUMvQixHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUN0QyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixNQUFNLENBQUMsSUFBSSxDQUFDO2FBQ2I7U0FDRjtRQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7S0FDZDs7Ozs7SUFFRCxVQUFVLENBQUMsSUFBVTtRQUNuQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQy9CO1FBQ0QsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FB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ZXNDb250ZW50IjpbImltcG9ydCB7RXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7RmFjaWxpdHl9IGZyb20gJ25nLWNvbW1vbi1saWJyYXJ5L2xpYi9tb2RlbC9GYWNpbGl0eSc7XG5pbXBvcnQge1VuaXR9IGZyb20gJ25nLWNvbW1vbi1saWJyYXJ5L2xpYi9tb2RlbC9Vbml0JztcbmltcG9ydCB7TG9jYXRpb25zfSBmcm9tICcuLi9tb2RlbC9sb2NhdGlvbnMnO1xuaW1wb3J0IHtTdWJqZWN0fSBmcm9tICdyeGpzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTG9jYXRpb25TZWxlY3RvclNlcnZpY2Uge1xuXG4gIHB1YmxpYyBsb2FkZWRMb2NhdGlvbnMgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIC8vIE1hcCBvZiBmYWNpbGl0eSB0byBpbmRldGVybWluYXRlIHN0YXRlXG4gIGZhY2lsaXRpZXM6IEZhY2lsaXR5W107XG4gIHVuaXRzOiBVbml0W107XG4gIC8qKiBGYWNpbGl0aWVzIHRoYXQgZG8gbm90IGhhdmUgYWxsIG9mIHRoZWlyIHVuaXRzIHNlbGVjdGVkXG4gICAqICBUaGlzIGlzIHVzZWZ1bCB3aGVuIHNldHRpbmcgdXAgdGhlIHJlc3QgY2FsbFxuICAgKiAgTk9URTogSSB0aG91Z2h0IGFib3V0IG1ha2luZyBmYWNpbGl0aWVzIGEgbWFwIGFuZCBwdXR0aW5nIHVuaXRzXG4gICAqICAgICAgIGFzIHRoZSB2YWx1ZSwgYnV0IHRoZSBSRVNUIGNhbGwganVzdCB0YWtlcyB0aGUgbGlzdCBvZiBmYWNpbGl0aWVzXG4gICAqICAgICAgIGFuZCB1bml0cy4uIHNvIGl0IHJlYWxseSBpcyBhbGwgdW5pdHMgb3Igc29tZSB1bml0cyB3aXRoIHRoZSBjYWxsLlxuICAgKi9cbiAgaW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXM6IHN0cmluZ1tdO1xuXG4gIHNlbGVjdEFsbCA9IG5ldyBFdmVudEVtaXR0ZXI8RmFjaWxpdHk+KCk7XG5cbiAgZGVzZWxlY3RBbGwgPSBuZXcgRXZlbnRFbWl0dGVyPEZhY2lsaXR5PigpO1xuXG4gIGNoZWNrRm9ySW5kZXRlcm1pbmF0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIGV4cGFuZFVuaXRzTGlzdCA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBjb2xsYXBzZVVuaXRzTGlzdCA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBzZWxlY3RlZFVuaXRzOiBVbml0W10gPSBbXTtcblxuICBwcmV2aW91c1VuaXRzOiBVbml0W10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgfVxuXG4gIGNoZWNrVW5pdFNlbGVjdGlvbih1bml0SUQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGZvciAoY29uc3QgdW5pdCBvZiB0aGlzLnNlbGVjdGVkVW5pdHMpIHtcbiAgICAgIGlmICh1bml0SUQgPT09IHVuaXQua2V5LnVuaXRJRCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgc2VsZWN0VW5pdCh1bml0OiBVbml0KSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRVbml0cy5pbmRleE9mKHVuaXQpIDwgMCkge1xuICAgICAgdGhpcy5zZWxlY3RlZFVuaXRzLnB1c2godW5pdCk7XG4gICAgfVxuICAgIHRoaXMuY2hlY2tGb3JJbmRldGVybWluYXRlLmVtaXQodW5pdC5rZXkuZmFjaWxpdHlJRCk7XG4gIH1cblxuICBkZXNlbGVjdFVuaXQodW5pdDogVW5pdCkge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zZWxlY3RlZFVuaXRzLmluZGV4T2YodW5pdCk7XG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgdGhpcy5zZWxlY3RlZFVuaXRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuICAgIHRoaXMuY2hlY2tGb3JJbmRldGVybWluYXRlLmVtaXQodW5pdC5rZXkuZmFjaWxpdHlJRCk7XG4gIH1cblxuICBzZWxlY3RBbGxVbml0c0Zyb21BRmFjaWxpdHkoZmFjaWxpdHk6IEZhY2lsaXR5KSB7XG4gICAgZm9yIChjb25zdCB1bml0IG9mIHRoaXMudW5pdHMpIHtcbiAgICAgIGlmICh1bml0LmtleS5mYWNpbGl0eUlEID09PSBmYWNpbGl0eS5mYWNpbGl0eUlEICYmIHRoaXMuc2VsZWN0ZWRVbml0cy5pbmRleE9mKHVuaXQpIDwgMCkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkVW5pdHMucHVzaCh1bml0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBkZXNlbGVjdEFsbFVuaXRzRnJvbUFGYWNpbGl0eShmYWNpbGl0eTogRmFjaWxpdHkpIHtcbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgdGhpcy51bml0cykge1xuICAgICAgaWYgKHVuaXQua2V5LmZhY2lsaXR5SUQgPT09IGZhY2lsaXR5LmZhY2lsaXR5SUQpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGVkVW5pdHMuaW5kZXhPZih1bml0KTtcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVbml0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqIENoZWNrIGlmIHByZXZpb3VzIHVuaXRzIGFuZCBzZWxlY3RlZCB1bml0cyBhcmUgdGhlIHNhbWUgKi9cbiAgaXNMb2NhdGlvblNlbGVjdGlvblRoZVNhbWUoKTogYm9vbGVhbiB7XG4gICAgLy8gcXVpY2tlc3Qgd2F5IHRvIGRlY2lkZVxuICAgIGlmICh0aGlzLnNlbGVjdGVkVW5pdHMubGVuZ3RoICE9PSB0aGlzLnByZXZpb3VzVW5pdHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIC8vIGNoZWNrIGlmIGV2ZXJ5IHVuaXQgZnJvbSBzZWxlY3RlZCB1bml0cyBleGlzdHMgaW4gcHJldmlvdXMgdW5pdHNcbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgdGhpcy5zZWxlY3RlZFVuaXRzKSB7XG4gICAgICAvLyBib29sIHRvIHRyYWNrIGlmIGEgdW5pdCBoYXMgYmVlbiBmb3VuZCBpbiB0aGUgb3RoZXIgbGlzdFxuICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICBmb3IgKGNvbnN0IHUgb2YgdGhpcy5wcmV2aW91c1VuaXRzKSB7XG4gICAgICAgIC8vIG1hdGNoIG9uIGZhY2lsaXR5IGlkIGFuZCB1bml0IGlkXG4gICAgICAgIGlmICh1LmtleS5mYWNpbGl0eUlEID09PSB1bml0LmtleS5mYWNpbGl0eUlEICYmIHUua2V5LnVuaXRJRCA9PT0gdW5pdC5rZXkudW5pdElEKSB7XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gY2hlY2sgaWYgZXZlcnkgdW5pdCBmcm9tIHByZXZpb3VzIHVuaXRzIGV4aXN0cyBpbiBzZWxlY3RlZCB1bml0c1xuICAgIGZvciAoY29uc3QgdW5pdCBvZiB0aGlzLnByZXZpb3VzVW5pdHMpIHtcbiAgICAgIC8vIGJvb2wgdG8gdHJhY2sgaWYgYSB1bml0IGhhcyBiZWVuIGZvdW5kIGluIHRoZSBvdGhlciBsaXN0XG4gICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAoY29uc3QgdSBvZiB0aGlzLnNlbGVjdGVkVW5pdHMpIHtcbiAgICAgICAgLy8gbWF0Y2ggb24gZmFjaWxpdHkgaWQgYW5kIHVuaXQgaWRcbiAgICAgICAgaWYgKHUua2V5LmZhY2lsaXR5SUQgPT09IHVuaXQua2V5LmZhY2lsaXR5SUQgJiYgdS5rZXkudW5pdElEID09PSB1bml0LmtleS51bml0SUQpIHtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VW5pdENvdW50Rm9yRmFjaWxpdHkoZmFjaWxpdHlJZDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBsZXQgdW5pdENvdW50ID0gMDtcbiAgICBmb3IgKGNvbnN0IHUgb2YgdGhpcy51bml0cykge1xuICAgICAgaWYgKHUua2V5LmZhY2lsaXR5SUQgPT09IGZhY2lsaXR5SWQpIHtcbiAgICAgICAgdW5pdENvdW50Kys7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bml0Q291bnQ7XG4gIH1cblxuICAvKiogQnVpbGRzIHN0cmluZyBbXXMgZm9yIGNoYW5nZSBvZiBwZXJhZ3JhcGggYW5kIEZMQyBSRVNUIGNhbGxzIHdoZW4gZmlsdGVyaW5nICovXG4gIGdldExvY2F0aW9uc1RvRmlsdGVyKCk6IExvY2F0aW9ucyB7XG5cbiAgICBjb25zdCBzZWxlY3RlZExvY2F0aW9uczogTG9jYXRpb25zID0ge2ZhY2lsaXRpZXM6IFtdLCB1bml0czogW119O1xuICAgIGZvciAoY29uc3QgdSBvZiB0aGlzLnNlbGVjdGVkVW5pdHMpIHtcbiAgICAgIHNlbGVjdGVkTG9jYXRpb25zLnVuaXRzLnB1c2godS5rZXkudW5pdElEKTtcbiAgICAgIGlmIChzZWxlY3RlZExvY2F0aW9ucy5mYWNpbGl0aWVzLmluZGV4T2YodS5rZXkuZmFjaWxpdHlJRCkgPCAwKSB7XG4gICAgICAgIHNlbGVjdGVkTG9jYXRpb25zLmZhY2lsaXRpZXMucHVzaCh1LmtleS5mYWNpbGl0eUlEKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJZiBhbnkgb2YgdGhlIGZhY2lsaXRpZXMgaW4gdGhlIHNlbGVjdGVkTG9jYXRpb25zIGFyZSBcImluZGV0ZXJtaW5hdGVcIlxuICAgICAqICB0aGVuIHdlIG11c3Qgc3VwcGx5IHRoZSBsaXN0IG9mIHVuaXRzLiBPdGhlcndpc2Ugd2UgY2FuIHNwZWNpZnkgXCIqXCJcbiAgICAgKiAgZm9yIHRoZSB1bml0cyB3aGljaCBtYWtlcyB0aGUgcmVzdCAvIHNxbCBjYWxscyBydW4gZmFzdGVyLlxuICAgICAqL1xuICAgIGxldCBmb3VuZEluZGV0ZXJtaW5hdGVGYWNpbGl0eSA9IGZhbHNlO1xuICAgIGZvciAoY29uc3QgZklkIG9mIHNlbGVjdGVkTG9jYXRpb25zLmZhY2lsaXRpZXMpIHtcbiAgICAgIGlmICh0aGlzLmluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzLmluZGV4T2YoZklkKSA+PSAwKSB7XG4gICAgICAgIGZvdW5kSW5kZXRlcm1pbmF0ZUZhY2lsaXR5ID0gdHJ1ZTtcbiAgICAgICAgLy8gSXQgb25seSB0YWtlcyBvbmUuLi5cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghZm91bmRJbmRldGVybWluYXRlRmFjaWxpdHkpIHtcbiAgICAgIHNlbGVjdGVkTG9jYXRpb25zLnVuaXRzID0gWycqJ107XG4gICAgfVxuICAgIHJldHVybiBzZWxlY3RlZExvY2F0aW9ucztcbiAgfVxuXG4gIHB1YmxpYyBzZXRGYWNpbGl0eUluZGV0ZXJtaW5hdGVTdGF0ZShmYWNpbGl0eUlEOiBzdHJpbmcsIGlzSW5kZXRlcm1pbmF0ZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmIChpc0luZGV0ZXJtaW5hdGUpIHtcbiAgICAgIHRoaXMuaW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXMucHVzaChmYWNpbGl0eUlEKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuaW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXMuaW5kZXhPZihmYWNpbGl0eUlEKSA+PSAwKSB7XG4gICAgICAgIHRoaXMuaW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXMuc3BsaWNlKHRoaXMuaW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXMuaW5kZXhPZihmYWNpbGl0eUlEKSwgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsZWFySW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXMoKTogdm9pZCB7XG4gICAgdGhpcy5pbmRldGVybWluYXRlRmFjaWxpdGllcyA9IFtdO1xuICB9XG59XG4iXX0=