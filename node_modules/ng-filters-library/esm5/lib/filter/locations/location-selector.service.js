/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { EventEmitter, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
var LocationSelectorService = /** @class */ (function () {
    function LocationSelectorService() {
        this.loadedLocations = new Subject();
        this.selectAll = new EventEmitter();
        this.deselectAll = new EventEmitter();
        this.checkForIndeterminate = new EventEmitter();
        this.expandUnitsList = new EventEmitter();
        this.collapseUnitsList = new EventEmitter();
        this.selectedUnits = [];
        this.previousUnits = [];
    }
    /**
     * @param {?} unitID
     * @return {?}
     */
    LocationSelectorService.prototype.checkUnitSelection = /**
     * @param {?} unitID
     * @return {?}
     */
    function (unitID) {
        try {
            for (var _a = tslib_1.__values(this.selectedUnits), _b = _a.next(); !_b.done; _b = _a.next()) {
                var unit = _b.value;
                if (unitID === unit.key.unitID) {
                    return true;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return false;
        var e_1, _c;
    };
    /**
     * @param {?} unit
     * @return {?}
     */
    LocationSelectorService.prototype.selectUnit = /**
     * @param {?} unit
     * @return {?}
     */
    function (unit) {
        if (this.selectedUnits.indexOf(unit) < 0) {
            this.selectedUnits.push(unit);
        }
        this.checkForIndeterminate.emit(unit.key.facilityID);
    };
    /**
     * @param {?} unit
     * @return {?}
     */
    LocationSelectorService.prototype.deselectUnit = /**
     * @param {?} unit
     * @return {?}
     */
    function (unit) {
        /** @type {?} */
        var index = this.selectedUnits.indexOf(unit);
        if (index !== -1) {
            this.selectedUnits.splice(index, 1);
        }
        this.checkForIndeterminate.emit(unit.key.facilityID);
    };
    /**
     * @param {?} facility
     * @return {?}
     */
    LocationSelectorService.prototype.selectAllUnitsFromAFacility = /**
     * @param {?} facility
     * @return {?}
     */
    function (facility) {
        try {
            for (var _a = tslib_1.__values(this.units), _b = _a.next(); !_b.done; _b = _a.next()) {
                var unit = _b.value;
                if (unit.key.facilityID === facility.facilityID && this.selectedUnits.indexOf(unit) < 0) {
                    this.selectedUnits.push(unit);
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_2) throw e_2.error; }
        }
        var e_2, _c;
    };
    /**
     * @param {?} facility
     * @return {?}
     */
    LocationSelectorService.prototype.deselectAllUnitsFromAFacility = /**
     * @param {?} facility
     * @return {?}
     */
    function (facility) {
        try {
            for (var _a = tslib_1.__values(this.units), _b = _a.next(); !_b.done; _b = _a.next()) {
                var unit = _b.value;
                if (unit.key.facilityID === facility.facilityID) {
                    /** @type {?} */
                    var index = this.selectedUnits.indexOf(unit);
                    if (index !== -1) {
                        this.selectedUnits.splice(index, 1);
                    }
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_3) throw e_3.error; }
        }
        var e_3, _c;
    };
    /** Check if previous units and selected units are the same */
    /**
     * Check if previous units and selected units are the same
     * @return {?}
     */
    LocationSelectorService.prototype.isLocationSelectionTheSame = /**
     * Check if previous units and selected units are the same
     * @return {?}
     */
    function () {
        // quickest way to decide
        if (this.selectedUnits.length !== this.previousUnits.length) {
            return false;
        }
        try {
            // check if every unit from selected units exists in previous units
            for (var _a = tslib_1.__values(this.selectedUnits), _b = _a.next(); !_b.done; _b = _a.next()) {
                var unit = _b.value;
                /** @type {?} */
                var found = false;
                try {
                    for (var _c = tslib_1.__values(this.previousUnits), _d = _c.next(); !_d.done; _d = _c.next()) {
                        var u = _d.value;
                        // match on facility id and unit id
                        if (u.key.facilityID === unit.key.facilityID && u.key.unitID === unit.key.unitID) {
                            found = true;
                            break;
                        }
                    }
                }
                catch (e_4_1) { e_4 = { error: e_4_1 }; }
                finally {
                    try {
                        if (_d && !_d.done && (_e = _c.return)) _e.call(_c);
                    }
                    finally { if (e_4) throw e_4.error; }
                }
                if (!found) {
                    return false;
                }
            }
        }
        catch (e_5_1) { e_5 = { error: e_5_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_f = _a.return)) _f.call(_a);
            }
            finally { if (e_5) throw e_5.error; }
        }
        try {
            // check if every unit from previous units exists in selected units
            for (var _g = tslib_1.__values(this.previousUnits), _h = _g.next(); !_h.done; _h = _g.next()) {
                var unit = _h.value;
                /** @type {?} */
                var found = false;
                try {
                    for (var _j = tslib_1.__values(this.selectedUnits), _k = _j.next(); !_k.done; _k = _j.next()) {
                        var u = _k.value;
                        // match on facility id and unit id
                        if (u.key.facilityID === unit.key.facilityID && u.key.unitID === unit.key.unitID) {
                            found = true;
                            break;
                        }
                    }
                }
                catch (e_6_1) { e_6 = { error: e_6_1 }; }
                finally {
                    try {
                        if (_k && !_k.done && (_l = _j.return)) _l.call(_j);
                    }
                    finally { if (e_6) throw e_6.error; }
                }
                if (!found) {
                    return false;
                }
            }
        }
        catch (e_7_1) { e_7 = { error: e_7_1 }; }
        finally {
            try {
                if (_h && !_h.done && (_m = _g.return)) _m.call(_g);
            }
            finally { if (e_7) throw e_7.error; }
        }
        return true;
        var e_5, _f, e_4, _e, e_7, _m, e_6, _l;
    };
    /**
     * @param {?} facilityId
     * @return {?}
     */
    LocationSelectorService.prototype.getUnitCountForFacility = /**
     * @param {?} facilityId
     * @return {?}
     */
    function (facilityId) {
        /** @type {?} */
        var unitCount = 0;
        try {
            for (var _a = tslib_1.__values(this.units), _b = _a.next(); !_b.done; _b = _a.next()) {
                var u = _b.value;
                if (u.key.facilityID === facilityId) {
                    unitCount++;
                }
            }
        }
        catch (e_8_1) { e_8 = { error: e_8_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_8) throw e_8.error; }
        }
        return unitCount;
        var e_8, _c;
    };
    /** Builds string []s for change of peragraph and FLC REST calls when filtering */
    /**
     * Builds string []s for change of peragraph and FLC REST calls when filtering
     * @return {?}
     */
    LocationSelectorService.prototype.getLocationsToFilter = /**
     * Builds string []s for change of peragraph and FLC REST calls when filtering
     * @return {?}
     */
    function () {
        /** @type {?} */
        var selectedLocations = { facilities: [], units: [] };
        try {
            for (var _a = tslib_1.__values(this.selectedUnits), _b = _a.next(); !_b.done; _b = _a.next()) {
                var u = _b.value;
                selectedLocations.units.push(u.key.unitID);
                if (selectedLocations.facilities.indexOf(u.key.facilityID) < 0) {
                    selectedLocations.facilities.push(u.key.facilityID);
                }
            }
        }
        catch (e_9_1) { e_9 = { error: e_9_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_9) throw e_9.error; }
        }
        /** *
         * If any of the facilities in the selectedLocations are "indeterminate"
         *  then we must supply the list of units. Otherwise we can specify "*"
         *  for the units which makes the rest / sql calls run faster.
          @type {?} */
        var foundIndeterminateFacility = false;
        try {
            for (var _d = tslib_1.__values(selectedLocations.facilities), _e = _d.next(); !_e.done; _e = _d.next()) {
                var fId = _e.value;
                if (this.indeterminateFacilities.indexOf(fId) >= 0) {
                    foundIndeterminateFacility = true;
                    // It only takes one...
                    break;
                }
            }
        }
        catch (e_10_1) { e_10 = { error: e_10_1 }; }
        finally {
            try {
                if (_e && !_e.done && (_f = _d.return)) _f.call(_d);
            }
            finally { if (e_10) throw e_10.error; }
        }
        if (!foundIndeterminateFacility) {
            selectedLocations.units = ['*'];
        }
        return selectedLocations;
        var e_9, _c, e_10, _f;
    };
    /**
     * @param {?} facilityID
     * @param {?} isIndeterminate
     * @return {?}
     */
    LocationSelectorService.prototype.setFacilityIndeterminateState = /**
     * @param {?} facilityID
     * @param {?} isIndeterminate
     * @return {?}
     */
    function (facilityID, isIndeterminate) {
        if (isIndeterminate) {
            this.indeterminateFacilities.push(facilityID);
        }
        else {
            if (this.indeterminateFacilities.indexOf(facilityID) >= 0) {
                this.indeterminateFacilities.splice(this.indeterminateFacilities.indexOf(facilityID), 1);
            }
        }
    };
    /**
     * @return {?}
     */
    LocationSelectorService.prototype.clearIndeterminateFacilities = /**
     * @return {?}
     */
    function () {
        this.indeterminateFacilities = [];
    };
    LocationSelectorService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    LocationSelectorService.ctorParameters = function () { return []; };
    /** @nocollapse */ LocationSelectorService.ngInjectableDef = i0.defineInjectable({ factory: function LocationSelectorService_Factory() { return new LocationSelectorService(); }, token: LocationSelectorService, providedIn: "root" });
    return LocationSelectorService;
}());
export { LocationSelectorService };
if (false) {
    /** @type {?} */
    LocationSelectorService.prototype.loadedLocations;
    /** @type {?} */
    LocationSelectorService.prototype.facilities;
    /** @type {?} */
    LocationSelectorService.prototype.units;
    /**
     * Facilities that do not have all of their units selected
     *  This is useful when setting up the rest call
     *  NOTE: I thought about making facilities a map and putting units
     *       as the value, but the REST call just takes the list of facilities
     *       and units.. so it really is all units or some units with the call.
     * @type {?}
     */
    LocationSelectorService.prototype.indeterminateFacilities;
    /** @type {?} */
    LocationSelectorService.prototype.selectAll;
    /** @type {?} */
    LocationSelectorService.prototype.deselectAll;
    /** @type {?} */
    LocationSelectorService.prototype.checkForIndeterminate;
    /** @type {?} */
    LocationSelectorService.prototype.expandUnitsList;
    /** @type {?} */
    LocationSelectorService.prototype.collapseUnitsList;
    /** @type {?} */
    LocationSelectorService.prototype.selectedUnits;
    /** @type {?} */
    LocationSelectorService.prototype.previousUnits;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRpb24tc2VsZWN0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWZpbHRlcnMtbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9maWx0ZXIvbG9jYXRpb25zL2xvY2F0aW9uLXNlbGVjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUl2RCxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sTUFBTSxDQUFDOzs7SUFrQzNCOytCQTNCeUIsSUFBSSxPQUFPLEVBQVE7eUJBYWhDLElBQUksWUFBWSxFQUFZOzJCQUUxQixJQUFJLFlBQVksRUFBWTtxQ0FFbEIsSUFBSSxZQUFZLEVBQVU7K0JBRWhDLElBQUksWUFBWSxFQUFRO2lDQUV0QixJQUFJLFlBQVksRUFBUTs2QkFFcEIsRUFBRTs2QkFFRixFQUFFO0tBR3pCOzs7OztJQUVELG9EQUFrQjs7OztJQUFsQixVQUFtQixNQUFjOztZQUMvQixHQUFHLENBQUMsQ0FBZSxJQUFBLEtBQUEsaUJBQUEsSUFBSSxDQUFDLGFBQWEsQ0FBQSxnQkFBQTtnQkFBaEMsSUFBTSxJQUFJLFdBQUE7Z0JBQ2IsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDL0IsTUFBTSxDQUFDLElBQUksQ0FBQztpQkFDYjthQUNGOzs7Ozs7Ozs7UUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDOztLQUNkOzs7OztJQUVELDRDQUFVOzs7O0lBQVYsVUFBVyxJQUFVO1FBQ25CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDL0I7UUFDRCxJQUFJ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LENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQy9DO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUMxRjtTQUNGOzs7OztJQUdJLDhEQUE0Qjs7OztRQUNqQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsRUFBRSxDQUFDOzs7Z0JBeEtyQyxVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7OztrQ0FSRDs7U0FTYSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0V2ZW50RW1pdHRlciwgSW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0ZhY2lsaXR5fSBmcm9tICduZy1jb21tb24tbGlicmFyeS9saWIvbW9kZWwvRmFjaWxpdHknO1xuaW1wb3J0IHtVbml0fSBmcm9tICduZy1jb21tb24tbGlicmFyeS9saWIvbW9kZWwvVW5pdCc7XG5pbXBvcnQge0xvY2F0aW9uc30gZnJvbSAnLi4vbW9kZWwvbG9jYXRpb25zJztcbmltcG9ydCB7U3ViamVjdH0gZnJvbSAncnhqcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIExvY2F0aW9uU2VsZWN0b3JTZXJ2aWNlIHtcblxuICBwdWJsaWMgbG9hZGVkTG9jYXRpb25zID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAvLyBNYXAgb2YgZmFjaWxpdHkgdG8gaW5kZXRlcm1pbmF0ZSBzdGF0ZVxuICBmYWNpbGl0aWVzOiBGYWNpbGl0eVtdO1xuICB1bml0czogVW5pdFtdO1xuICAvKiogRmFjaWxpdGllcyB0aGF0IGRvIG5vdCBoYXZlIGFsbCBvZiB0aGVpciB1bml0cyBzZWxlY3RlZFxuICAgKiAgVGhpcyBpcyB1c2VmdWwgd2hlbiBzZXR0aW5nIHVwIHRoZSByZXN0IGNhbGxcbiAgICogIE5PVEU6IEkgdGhvdWdodCBhYm91dCBtYWtpbmcgZmFjaWxpdGllcyBhIG1hcCBhbmQgcHV0dGluZyB1bml0c1xuICAgKiAgICAgICBhcyB0aGUgdmFsdWUsIGJ1dCB0aGUgUkVTVCBjYWxsIGp1c3QgdGFrZXMgdGhlIGxpc3Qgb2YgZmFjaWxpdGllc1xuICAgKiAgICAgICBhbmQgdW5pdHMuLiBzbyBpdCByZWFsbHkgaXMgYWxsIHVuaXRzIG9yIHNvbWUgdW5pdHMgd2l0aCB0aGUgY2FsbC5cbiAgICovXG4gIGluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzOiBzdHJpbmdbXTtcblxuICBzZWxlY3RBbGwgPSBuZXcgRXZlbnRFbWl0dGVyPEZhY2lsaXR5PigpO1xuXG4gIGRlc2VsZWN0QWxsID0gbmV3IEV2ZW50RW1pdHRlcjxGYWNpbGl0eT4oKTtcblxuICBjaGVja0ZvckluZGV0ZXJtaW5hdGUgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICBleHBhbmRVbml0c0xpc3QgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgY29sbGFwc2VVbml0c0xpc3QgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgc2VsZWN0ZWRVbml0czogVW5pdFtdID0gW107XG5cbiAgcHJldmlvdXNVbml0czogVW5pdFtdID0gW107XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gIH1cblxuICBjaGVja1VuaXRTZWxlY3Rpb24odW5pdElEOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgdGhpcy5zZWxlY3RlZFVuaXRzKSB7XG4gICAgICBpZiAodW5pdElEID09PSB1bml0LmtleS51bml0SUQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHNlbGVjdFVuaXQodW5pdDogVW5pdCkge1xuICAgIGlmICh0aGlzLnNlbGVjdGVkVW5pdHMuaW5kZXhPZih1bml0KSA8IDApIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRVbml0cy5wdXNoKHVuaXQpO1xuICAgIH1cbiAgICB0aGlzLmNoZWNrRm9ySW5kZXRlcm1pbmF0ZS5lbWl0KHVuaXQua2V5LmZhY2lsaXR5SUQpO1xuICB9XG5cbiAgZGVzZWxlY3RVbml0KHVuaXQ6IFVuaXQpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuc2VsZWN0ZWRVbml0cy5pbmRleE9mKHVuaXQpO1xuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRVbml0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgICB0aGlzLmNoZWNrRm9ySW5kZXRlcm1pbmF0ZS5lbWl0KHVuaXQua2V5LmZhY2lsaXR5SUQpO1xuICB9XG5cbiAgc2VsZWN0QWxsVW5pdHNGcm9tQUZhY2lsaXR5KGZhY2lsaXR5OiBGYWNpbGl0eSkge1xuICAgIGZvciAoY29uc3QgdW5pdCBvZiB0aGlzLnVuaXRzKSB7XG4gICAgICBpZiAodW5pdC5rZXkuZmFjaWxpdHlJRCA9PT0gZmFjaWxpdHkuZmFjaWxpdHlJRCAmJiB0aGlzLnNlbGVjdGVkVW5pdHMuaW5kZXhPZih1bml0KSA8IDApIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFVuaXRzLnB1c2godW5pdCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZGVzZWxlY3RBbGxVbml0c0Zyb21BRmFjaWxpdHkoZmFjaWxpdHk6IEZhY2lsaXR5KSB7XG4gICAgZm9yIChjb25zdCB1bml0IG9mIHRoaXMudW5pdHMpIHtcbiAgICAgIGlmICh1bml0LmtleS5mYWNpbGl0eUlEID09PSBmYWNpbGl0eS5mYWNpbGl0eUlEKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zZWxlY3RlZFVuaXRzLmluZGV4T2YodW5pdCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICB0aGlzLnNlbGVjdGVkVW5pdHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKiBDaGVjayBpZiBwcmV2aW91cyB1bml0cyBhbmQgc2VsZWN0ZWQgdW5pdHMgYXJlIHRoZSBzYW1lICovXG4gIGlzTG9jYXRpb25TZWxlY3Rpb25UaGVTYW1lKCk6IGJvb2xlYW4ge1xuICAgIC8vIHF1aWNrZXN0IHdheSB0byBkZWNpZGVcbiAgICBpZiAodGhpcy5zZWxlY3RlZFVuaXRzLmxlbmd0aCAhPT0gdGhpcy5wcmV2aW91c1VuaXRzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICAvLyBjaGVjayBpZiBldmVyeSB1bml0IGZyb20gc2VsZWN0ZWQgdW5pdHMgZXhpc3RzIGluIHByZXZpb3VzIHVuaXRzXG4gICAgZm9yIChjb25zdCB1bml0IG9mIHRoaXMuc2VsZWN0ZWRVbml0cykge1xuICAgICAgLy8gYm9vbCB0byB0cmFjayBpZiBhIHVuaXQgaGFzIGJlZW4gZm91bmQgaW4gdGhlIG90aGVyIGxpc3RcbiAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgZm9yIChjb25zdCB1IG9mIHRoaXMucHJldmlvdXNVbml0cykge1xuICAgICAgICAvLyBtYXRjaCBvbiBmYWNpbGl0eSBpZCBhbmQgdW5pdCBpZFxuICAgICAgICBpZiAodS5rZXkuZmFjaWxpdHlJRCA9PT0gdW5pdC5rZXkuZmFjaWxpdHlJRCAmJiB1LmtleS51bml0SUQgPT09IHVuaXQua2V5LnVuaXRJRCkge1xuICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmb3VuZCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIGNoZWNrIGlmIGV2ZXJ5IHVuaXQgZnJvbSBwcmV2aW91cyB1bml0cyBleGlzdHMgaW4gc2VsZWN0ZWQgdW5pdHNcbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgdGhpcy5wcmV2aW91c1VuaXRzKSB7XG4gICAgICAvLyBib29sIHRvIHRyYWNrIGlmIGEgdW5pdCBoYXMgYmVlbiBmb3VuZCBpbiB0aGUgb3RoZXIgbGlzdFxuICAgICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgICBmb3IgKGNvbnN0IHUgb2YgdGhpcy5zZWxlY3RlZFVuaXRzKSB7XG4gICAgICAgIC8vIG1hdGNoIG9uIGZhY2lsaXR5IGlkIGFuZCB1bml0IGlkXG4gICAgICAgIGlmICh1LmtleS5mYWNpbGl0eUlEID09PSB1bml0LmtleS5mYWNpbGl0eUlEICYmIHUua2V5LnVuaXRJRCA9PT0gdW5pdC5rZXkudW5pdElEKSB7XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGdldFVuaXRDb3VudEZvckZhY2lsaXR5KGZhY2lsaXR5SWQ6IHN0cmluZyk6IG51bWJlciB7XG4gICAgbGV0IHVuaXRDb3VudCA9IDA7XG4gICAgZm9yIChjb25zdCB1IG9mIHRoaXMudW5pdHMpIHtcbiAgICAgIGlmICh1LmtleS5mYWNpbGl0eUlEID09PSBmYWNpbGl0eUlkKSB7XG4gICAgICAgIHVuaXRDb3VudCsrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5pdENvdW50O1xuICB9XG5cbiAgLyoqIEJ1aWxkcyBzdHJpbmcgW11zIGZvciBjaGFuZ2Ugb2YgcGVyYWdyYXBoIGFuZCBGTEMgUkVTVCBjYWxscyB3aGVuIGZpbHRlcmluZyAqL1xuICBnZXRMb2NhdGlvbnNUb0ZpbHRlcigpOiBMb2NhdGlvbnMge1xuXG4gICAgY29uc3Qgc2VsZWN0ZWRMb2NhdGlvbnM6IExvY2F0aW9ucyA9IHtmYWNpbGl0aWVzOiBbXSwgdW5pdHM6IFtdfTtcbiAgICBmb3IgKGNvbnN0IHUgb2YgdGhpcy5zZWxlY3RlZFVuaXRzKSB7XG4gICAgICBzZWxlY3RlZExvY2F0aW9ucy51bml0cy5wdXNoKHUua2V5LnVuaXRJRCk7XG4gICAgICBpZiAoc2VsZWN0ZWRMb2NhdGlvbnMuZmFjaWxpdGllcy5pbmRleE9mKHUua2V5LmZhY2lsaXR5SUQpIDwgMCkge1xuICAgICAgICBzZWxlY3RlZExvY2F0aW9ucy5mYWNpbGl0aWVzLnB1c2godS5rZXkuZmFjaWxpdHlJRCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSWYgYW55IG9mIHRoZSBmYWNpbGl0aWVzIGluIHRoZSBzZWxlY3RlZExvY2F0aW9ucyBhcmUgXCJpbmRldGVybWluYXRlXCJcbiAgICAgKiAgdGhlbiB3ZSBtdXN0IHN1cHBseSB0aGUgbGlzdCBvZiB1bml0cy4gT3RoZXJ3aXNlIHdlIGNhbiBzcGVjaWZ5IFwiKlwiXG4gICAgICogIGZvciB0aGUgdW5pdHMgd2hpY2ggbWFrZXMgdGhlIHJlc3QgLyBzcWwgY2FsbHMgcnVuIGZhc3Rlci5cbiAgICAgKi9cbiAgICBsZXQgZm91bmRJbmRldGVybWluYXRlRmFjaWxpdHkgPSBmYWxzZTtcbiAgICBmb3IgKGNvbnN0IGZJZCBvZiBzZWxlY3RlZExvY2F0aW9ucy5mYWNpbGl0aWVzKSB7XG4gICAgICBpZiAodGhpcy5pbmRldGVybWluYXRlRmFjaWxpdGllcy5pbmRleE9mKGZJZCkgPj0gMCkge1xuICAgICAgICBmb3VuZEluZGV0ZXJtaW5hdGVGYWNpbGl0eSA9IHRydWU7XG4gICAgICAgIC8vIEl0IG9ubHkgdGFrZXMgb25lLi4uXG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWZvdW5kSW5kZXRlcm1pbmF0ZUZhY2lsaXR5KSB7XG4gICAgICBzZWxlY3RlZExvY2F0aW9ucy51bml0cyA9IFsnKiddO1xuICAgIH1cbiAgICByZXR1cm4gc2VsZWN0ZWRMb2NhdGlvbnM7XG4gIH1cblxuICBwdWJsaWMgc2V0RmFjaWxpdHlJbmRldGVybWluYXRlU3RhdGUoZmFjaWxpdHlJRDogc3RyaW5nLCBpc0luZGV0ZXJtaW5hdGU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAoaXNJbmRldGVybWluYXRlKSB7XG4gICAgICB0aGlzLmluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzLnB1c2goZmFjaWxpdHlJRCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzLmluZGV4T2YoZmFjaWxpdHlJRCkgPj0gMCkge1xuICAgICAgICB0aGlzLmluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzLnNwbGljZSh0aGlzLmluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzLmluZGV4T2YoZmFjaWxpdHlJRCksIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjbGVhckluZGV0ZXJtaW5hdGVGYWNpbGl0aWVzKCk6IHZvaWQge1xuICAgIHRoaXMuaW5kZXRlcm1pbmF0ZUZhY2lsaXRpZXMgPSBbXTtcbiAgfVxufVxuIl19