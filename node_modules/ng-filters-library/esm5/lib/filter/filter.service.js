/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { LocationSelectorService } from './locations/location-selector.service';
import { Locations } from './model/locations';
import { FilterQueryRestService } from './query-filters/filter-query-rest.service';
import { SortService } from '../sort/sort.service';
import { SortChoices } from '../sort/SortEnum';
import { GroupService } from '../group/group.service';
import * as i0 from "@angular/core";
import * as i1 from "./locations/location-selector.service";
import * as i2 from "./query-filters/filter-query-rest.service";
import * as i3 from "../sort/sort.service";
import * as i4 from "../group/group.service";
/**
 * Manages the staging filters object -> the current status of the sidebar,
 * the active filters object -> the filters currently being applied to the array view,
 * and the subject which is used to update the array view when filters are applied.
 */
var FilterService = /** @class */ (function () {
    function FilterService(locationSelectorService, filterRestService, sortService, groupService) {
        this.locationSelectorService = locationSelectorService;
        this.filterRestService = filterRestService;
        this.sortService = sortService;
        this.groupService = groupService;
        /**
         * BehaviorSubject for when selected locations change.
         */
        this.locationsChanged = new BehaviorSubject({
            locations: new Locations(),
            executeFilterQuery: false,
        });
        /**
         * Filters actively applied to the array view.
         */
        this.activeFilters = {};
        /**
         * Filters currently selected in the sidebar but NOT applied.
         */
        this.stagingFilters = {};
        /**
         * visit numbers of patients filtered out by server side filters
         */
        this.serverFilteredVisits = [];
        /**
         * name of filter for server side filters
         */
        this.serverFilterName = 'query-filter';
        /**
         * criteria to build filter query from as currently represented in sidebar
         */
        this.stagedServerFilterCriteria = {};
        /**
         * criteria for server side filtering currently ACTIVE in array view
         */
        this._activeServerFilterCriteria = {};
        /**
         * Subject which is updated when filters are applied.
         */
        this.filterSubject$ = new BehaviorSubject(this.activeFilters);
    }
    /**
     * Adds a staged filter (prior to activating the filters)
     * @param filterName Name of the filter to stage.
     * @param filterFunction The filter function to stage.
     */
    /**
     * Adds a staged filter (prior to activating the filters)
     * @param {?} filterName Name of the filter to stage.
     * @param {?} filterFunction The filter function to stage.
     * @return {?}
     */
    FilterService.prototype.stageFilter = /**
     * Adds a staged filter (prior to activating the filters)
     * @param {?} filterName Name of the filter to stage.
     * @param {?} filterFunction The filter function to stage.
     * @return {?}
     */
    function (filterName, filterFunction) {
        this.stagingFilters[filterName] = filterFunction;
    };
    /**
     * Removes a staged filter.
     * @param filterName Name of filter to unstage.
     */
    /**
     * Removes a staged filter.
     * @param {?} filterName Name of filter to unstage.
     * @return {?}
     */
    FilterService.prototype.unstageFilter = /**
     * Removes a staged filter.
     * @param {?} filterName Name of filter to unstage.
     * @return {?}
     */
    function (filterName) {
        delete this.stagingFilters[filterName];
    };
    /**
     * gets filter function that filters out patients based on criteria from conglomerated filter query
     */
    /**
     * gets filter function that filters out patients based on criteria from conglomerated filter query
     * @return {?}
     */
    FilterService.prototype.getServerSideFilterFunction = /**
     * gets filter function that filters out patients based on criteria from conglomerated filter query
     * @return {?}
     */
    function () {
        /** @type {?} */
        var thisRef = this;
        return function (peragraph) {
            try {
                for (var _a = tslib_1.__values(thisRef.serverFilteredVisits), _b = _a.next(); !_b.done; _b = _a.next()) {
                    var vnm = _b.value;
                    if (vnm === peragraph.vnm) {
                        return true;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
                }
                finally { if (e_1) throw e_1.error; }
            }
            return false;
            var e_1, _c;
        };
    };
    /**
     * add filter criteria to criteria object
     * @param criteria - array of criteria to add to filter
     * @param title - property name of criteria on the filterCriteria object -> MUST match a
     * QueryParam in the REST call located in common.FilterController or it won't be applied
     */
    /**
     * add filter criteria to criteria object
     * @param {?} criteria - array of criteria to add to filter
     * @param {?} title - property name of criteria on the filterCriteria object -> MUST match a
     * QueryParam in the REST call located in common.FilterController or it won't be applied
     * @return {?}
     */
    FilterService.prototype.stageServerFilterCriteria = /**
     * add filter criteria to criteria object
     * @param {?} criteria - array of criteria to add to filter
     * @param {?} title - property name of criteria on the filterCriteria object -> MUST match a
     * QueryParam in the REST call located in common.FilterController or it won't be applied
     * @return {?}
     */
    function (criteria, title) {
        this.stagedServerFilterCriteria[title] = criteria;
        this.stageFilter(this.serverFilterName, this.getServerSideFilterFunction());
    };
    /**
     * removes a criteria object from the filter criteria object
     * if no criterion remain, the filter is removed from the staged filters
     * @param title - name of the criteria to be removed
     */
    /**
     * removes a criteria object from the filter criteria object
     * if no criterion remain, the filter is removed from the staged filters
     * @param {?} title - name of the criteria to be removed
     * @return {?}
     */
    FilterService.prototype.removeStagedServerCriteria = /**
     * removes a criteria object from the filter criteria object
     * if no criterion remain, the filter is removed from the staged filters
     * @param {?} title - name of the criteria to be removed
     * @return {?}
     */
    function (title) {
        delete this.stagedServerFilterCriteria[title];
        if (Object.keys(this.stagedServerFilterCriteria).length === 0) {
            this.unstageFilter(this.serverFilterName);
        }
    };
    /**
     * return staged server side filter parameters
     */
    /**
     * return staged server side filter parameters
     * @return {?}
     */
    FilterService.prototype.getStagedServerSideFilterCriteria = /**
     * return staged server side filter parameters
     * @return {?}
     */
    function () {
        return this.stagedServerFilterCriteria;
    };
    /**
     * returns a function which returns the current active filters at the given time
     */
    /**
     * returns a function which returns the current active filters at the given time
     * @return {?}
     */
    FilterService.prototype.getActiveServerFilterCriteria = /**
     * returns a function which returns the current active filters at the given time
     * @return {?}
     */
    function () {
        /** @type {?} */
        var filterServiceRef = this;
        return function () {
            return filterServiceRef._activeServerFilterCriteria;
        };
    };
    /**
     * what to do if sidebar is destroyed
     */
    /**
     * what to do if sidebar is destroyed
     * @return {?}
     */
    FilterService.prototype.clearAllFilters = /**
     * what to do if sidebar is destroyed
     * @return {?}
     */
    function () {
        this.activeFilters = {};
        this.stagingFilters = {};
        this.serverFilteredVisits = [];
        this.stagedServerFilterCriteria = {};
        this._activeServerFilterCriteria = {};
        this.filterSubject$.next({});
        this.groupService.clearGroupBy();
        this.sortService.clearSort();
    };
    /**
     * Activate the staged filters
     *
     * 2 seperate paths:
     *      A. Location changes -> refresh graphs is called after changing the endpoint parameters and a variable is passed in
     *                              to let refresh changes know if the server side filter needs to be refreshed
     *      B. No location changes -> If the server side filtering needs to be refreshed, its REST call is initiated before client side filtering occurs,
     *                              otherwise client side filtering occurs immediatley on existing graphs
     */
    /**
     * Activate the staged filters
     *
     * 2 seperate paths:
     *      A. Location changes -> refresh graphs is called after changing the endpoint parameters and a variable is passed in
     *                              to let refresh changes know if the server side filter needs to be refreshed
     *      B. No location changes -> If the server side filtering needs to be refreshed, its REST call is initiated before client side filtering occurs,
     *                              otherwise client side filtering occurs immediatley on existing graphs
     * @return {?}
     */
    FilterService.prototype.activateFilters = /**
     * Activate the staged filters
     *
     * 2 seperate paths:
     *      A. Location changes -> refresh graphs is called after changing the endpoint parameters and a variable is passed in
     *                              to let refresh changes know if the server side filter needs to be refreshed
     *      B. No location changes -> If the server side filtering needs to be refreshed, its REST call is initiated before client side filtering occurs,
     *                              otherwise client side filtering occurs immediatley on existing graphs
     * @return {?}
     */
    function () {
        var _this = this;
        // close appropriate groups if changing, filters, group by, or sort
        this.groupService.changeGroupsClosed = true;
        // set staged sort to active
        this.sortService.activeSortFunction = this.sortService.getStagedSortFunction();
        this.sortService.activeSortName = this.sortService.stagedSortName;
        // set staged filters to active filters
        this.activeFilters = {};
        for (var filter in this.stagingFilters) {
            if (this.stagingFilters.hasOwnProperty(filter)) {
                this.activeFilters[filter] = this.stagingFilters[filter];
            }
        }
        // set staged server side filtering query parameters to active
        this._activeServerFilterCriteria = {};
        for (var criteria in this.stagedServerFilterCriteria) {
            if (this.stagedServerFilterCriteria.hasOwnProperty(criteria)) {
                this._activeServerFilterCriteria[criteria] = this.stagedServerFilterCriteria[criteria];
            }
        }
        /** @type {?} */
        var executeQuery = this.activeFilters.hasOwnProperty(this.serverFilterName);
        // Check if unit selection has changed
        if (!this.locationSelectorService.isLocationSelectionTheSame() || this.sortService.activeSortName === SortChoices.RIScore || this.groupService.stagedGroup.groupName !== this.groupService.activeGroup.groupName) {
            this.groupService.activeGroup = this.groupService.stagedGroup;
            this.groupService.groupSubject$.next(this.groupService.activeGroup.lanes);
            /** @type {?} */
            var selectedLocations = this.locationSelectorService.getLocationsToFilter();
            // Signal that location selections have changed and whether or not to execute the filter query
            this.locationsChanged.next({ locations: selectedLocations, executeFilterQuery: executeQuery });
        }
        else {
            // if filter query needs to be executed, wait for it to return before filtering the graphs in the client
            if (executeQuery) {
                this.filterRestService.getFilteredVisits(this.getActiveServerFilterCriteria()).subscribe(function (visits) {
                    _this.serverFilteredVisits = visits;
                    _this.filterSubject$.next(_this.activeFilters);
                });
            }
            else {
                // pass the filter subject with the updated filters
                setTimeout(function () { return _this.filterSubject$.next(_this.activeFilters); }, 500);
            }
        }
    };
    FilterService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    FilterService.ctorParameters = function () { return [
        { type: LocationSelectorService },
        { type: FilterQueryRestService },
        { type: SortService },
        { type: GroupService }
    ]; };
    /** @nocollapse */ FilterService.ngInjectableDef = i0.defineInjectable({ factory: function FilterService_Factory() { return new FilterService(i0.inject(i1.LocationSelectorService), i0.inject(i2.FilterQueryRestService), i0.inject(i3.SortService), i0.inject(i4.GroupService)); }, token: FilterService, providedIn: "root" });
    return FilterService;
}());
export { FilterService };
if (false) {
    /**
     * BehaviorSubject for when selected locations change.
     * @type {?}
     */
    FilterService.prototype.locationsChanged;
    /**
     * Filters actively applied to the array view.
     * @type {?}
     */
    FilterService.prototype.activeFilters;
    /**
     * Filters currently selected in the sidebar but NOT applied.
     * @type {?}
     */
    FilterService.prototype.stagingFilters;
    /**
     * visit numbers of patients filtered out by server side filters
     * @type {?}
     */
    FilterService.prototype.serverFilteredVisits;
    /**
     * name of filter for server side filters
     * @type {?}
     */
    FilterService.prototype.serverFilterName;
    /**
     * criteria to build filter query from as currently represented in sidebar
     * @type {?}
     */
    FilterService.prototype.stagedServerFilterCriteria;
    /**
     * criteria for server side filtering currently ACTIVE in array view
     * @type {?}
     */
    FilterService.prototype._activeServerFilterCriteria;
    /**
     * Subject which is updated when filters are applied.
     * @type {?}
     */
    FilterService.prototype.filterSubject$;
    /** @type {?} */
    FilterService.prototype.locationSelectorService;
    /** @type {?} */
    FilterService.prototype.filterRestService;
    /** @type {?} */
    FilterService.prototype.sortService;
    /** @type {?} */
    FilterService.prototype.groupService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1maWx0ZXJzLWxpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvZmlsdGVyL2ZpbHRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRXJDLE9BQU8sRUFBQyx1QkFBdUIsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQzlFLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUM1QyxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQztBQUNqRixPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDakQsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGtCQUFrQixDQUFDO0FBQzdDLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQzs7Ozs7Ozs7Ozs7O0lBK0NsRCx1QkFBb0IsdUJBQWdELEVBQ2hELG1CQUNBLGFBQ0E7UUFIQSw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBQ2hELHNCQUFpQixHQUFqQixpQkFBaUI7UUFDakIsZ0JBQVcsR0FBWCxXQUFXO1FBQ1gsaUJBQVksR0FBWixZQUFZOzs7O2dDQXJDTixJQUFJLGVBQWUsQ0FBd0Q7WUFDbkcsU0FBUyxFQUFFLElBQUksU0FBUyxFQUFFO1lBQzFCLGtCQUFrQixFQUFFLEtBQUs7U0FDMUIsQ0FBQzs7Ozs2QkFHcUIsRUFBRTs7Ozs4QkFHQSxFQUFFOzs7O29DQUthLEVBQUU7Ozs7Z0NBS2YsY0FBYzs7OzswQ0FLSixFQUFFOzs7OzJDQUtELEVBQUU7Ozs7OEJBR2hCLElBQUksZUFBZSxDQUFNLElBQUksQ0FBQyxhQUFhLENBQUM7S0FNbkU7SUFFRDs7OztPQUlHOzs7Ozs7O0lBQ0gsbUNBQVc7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Q0FBQyxXQUFXLENBQUM7WUFDOUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDOztZQUUxRSxJQUFNLGlCQUFpQixHQUFjLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDOztZQUV6RixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUMsU0FBUyxFQUFFLGlCQUFpQixFQUFFLGtCQUFrQixFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7U0FDOUY7UUFBQyxJQUFJLENBQUMsQ0FBQzs7WUFFTixFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUNqQixJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLDZCQUE2QixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQyxNQUFnQjtvQkFDeEcsS0FBSSxDQUFDLG9CQUFvQixHQUFHLE1BQU0sQ0FBQztvQkFDbkMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2lCQUM5QyxDQUFDLENBQUM7YUFDSjtZQUFDLElBQUksQ0FBQyxDQUFDOztnQkFFTixVQUFVLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxhQUFhLENBQUMsRUFBNUMsQ0FBNEMsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUNyRTtTQUNGO0tBQ0Y7O2dCQTFMRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dCQWRPLHVCQUF1QjtnQkFFdkIsc0JBQXNCO2dCQUN0QixXQUFXO2dCQUVYLFlBQVk7Ozt3QkFScEI7O1NBa0JhLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtQZXJhR3JhcGh9IGZyb20gJ25nLWNvbW1vbi1saWJyYXJ5JztcbmltcG9ydCB7TG9jYXRpb25TZWxlY3RvclNlcnZpY2V9IGZyb20gJy4vbG9jYXRpb25zL2xvY2F0aW9uLXNlbGVjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHtMb2NhdGlvbnN9IGZyb20gJy4vbW9kZWwvbG9jYXRpb25zJztcbmltcG9ydCB7RmlsdGVyUXVlcnlSZXN0U2VydmljZX0gZnJvbSAnLi9xdWVyeS1maWx0ZXJzL2ZpbHRlci1xdWVyeS1yZXN0LnNlcnZpY2UnO1xuaW1wb3J0IHtTb3J0U2VydmljZX0gZnJvbSAnLi4vc29ydC9zb3J0LnNlcnZpY2UnO1xuaW1wb3J0IHtTb3J0Q2hvaWNlc30gZnJvbSAnLi4vc29ydC9Tb3J0RW51bSc7XG5pbXBvcnQge0dyb3VwU2VydmljZX0gZnJvbSAnLi4vZ3JvdXAvZ3JvdXAuc2VydmljZSc7XG5cbi8qKlxuICogTWFuYWdlcyB0aGUgc3RhZ2luZyBmaWx0ZXJzIG9iamVjdCAtPiB0aGUgY3VycmVudCBzdGF0dXMgb2YgdGhlIHNpZGViYXIsXG4gKiB0aGUgYWN0aXZlIGZpbHRlcnMgb2JqZWN0IC0+IHRoZSBmaWx0ZXJzIGN1cnJlbnRseSBiZWluZyBhcHBsaWVkIHRvIHRoZSBhcnJheSB2aWV3LFxuICogYW5kIHRoZSBzdWJqZWN0IHdoaWNoIGlzIHVzZWQgdG8gdXBkYXRlIHRoZSBhcnJheSB2aWV3IHdoZW4gZmlsdGVycyBhcmUgYXBwbGllZC5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRmlsdGVyU2VydmljZSB7XG5cbiAgLyoqIEJlaGF2aW9yU3ViamVjdCBmb3Igd2hlbiBzZWxlY3RlZCBsb2NhdGlvbnMgY2hhbmdlLiAqL1xuICBwdWJsaWMgbG9jYXRpb25zQ2hhbmdlZCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8eyBsb2NhdGlvbnM6IExvY2F0aW9ucywgZXhlY3V0ZUZpbHRlclF1ZXJ5OiBib29sZWFuIH0+KHtcbiAgICBsb2NhdGlvbnM6IG5ldyBMb2NhdGlvbnMoKSxcbiAgICBleGVjdXRlRmlsdGVyUXVlcnk6IGZhbHNlLFxuICB9KTtcblxuICAvKiogRmlsdGVycyBhY3RpdmVseSBhcHBsaWVkIHRvIHRoZSBhcnJheSB2aWV3LiAqL1xuICBwdWJsaWMgYWN0aXZlRmlsdGVycyA9IHt9O1xuXG4gIC8qKiBGaWx0ZXJzIGN1cnJlbnRseSBzZWxlY3RlZCBpbiB0aGUgc2lkZWJhciBidXQgTk9UIGFwcGxpZWQuICovXG4gIHByaXZhdGUgc3RhZ2luZ0ZpbHRlcnMgPSB7fTtcblxuICAvKipcbiAgICogdmlzaXQgbnVtYmVycyBvZiBwYXRpZW50cyBmaWx0ZXJlZCBvdXQgYnkgc2VydmVyIHNpZGUgZmlsdGVyc1xuICAgKi9cbiAgcHVibGljIHNlcnZlckZpbHRlcmVkVmlzaXRzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBuYW1lIG9mIGZpbHRlciBmb3Igc2VydmVyIHNpZGUgZmlsdGVyc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXJ2ZXJGaWx0ZXJOYW1lID0gJ3F1ZXJ5LWZpbHRlcic7XG5cbiAgLyoqXG4gICAqIGNyaXRlcmlhIHRvIGJ1aWxkIGZpbHRlciBxdWVyeSBmcm9tIGFzIGN1cnJlbnRseSByZXByZXNlbnRlZCBpbiBzaWRlYmFyXG4gICAqL1xuICBwcml2YXRlIHN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhID0ge307XG5cbiAgLyoqXG4gICAqIGNyaXRlcmlhIGZvciBzZXJ2ZXIgc2lkZSBmaWx0ZXJpbmcgY3VycmVudGx5IEFDVElWRSBpbiBhcnJheSB2aWV3XG4gICAqL1xuICBwcml2YXRlIF9hY3RpdmVTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSA9IHt9O1xuXG4gIC8qKiBTdWJqZWN0IHdoaWNoIGlzIHVwZGF0ZWQgd2hlbiBmaWx0ZXJzIGFyZSBhcHBsaWVkLiAqL1xuICBwdWJsaWMgZmlsdGVyU3ViamVjdCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4odGhpcy5hY3RpdmVGaWx0ZXJzKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2F0aW9uU2VsZWN0b3JTZXJ2aWNlOiBMb2NhdGlvblNlbGVjdG9yU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBmaWx0ZXJSZXN0U2VydmljZTogRmlsdGVyUXVlcnlSZXN0U2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBzb3J0U2VydmljZTogU29ydFNlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgZ3JvdXBTZXJ2aWNlOiBHcm91cFNlcnZpY2UpIHtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgc3RhZ2VkIGZpbHRlciAocHJpb3IgdG8gYWN0aXZhdGluZyB0aGUgZmlsdGVycylcbiAgICogQHBhcmFtIGZpbHRlck5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyIHRvIHN0YWdlLlxuICAgKiBAcGFyYW0gZmlsdGVyRnVuY3Rpb24gVGhlIGZpbHRlciBmdW5jdGlvbiB0byBzdGFnZS5cbiAgICovXG4gIHN0YWdlRmlsdGVyKGZpbHRlck5hbWU6IHN0cmluZywgZmlsdGVyRnVuY3Rpb246IChwZXJhZ3JhcGg6IFBlcmFHcmFwaCkgPT4gYm9vbGVhbikge1xuICAgIHRoaXMuc3RhZ2luZ0ZpbHRlcnNbZmlsdGVyTmFtZV0gPSBmaWx0ZXJGdW5jdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGEgc3RhZ2VkIGZpbHRlci5cbiAgICogQHBhcmFtIGZpbHRlck5hbWUgTmFtZSBvZiBmaWx0ZXIgdG8gdW5zdGFnZS5cbiAgICovXG4gIHVuc3RhZ2VGaWx0ZXIoZmlsdGVyTmFtZTogc3RyaW5nKSB7XG4gICAgZGVsZXRlIHRoaXMuc3RhZ2luZ0ZpbHRlcnNbZmlsdGVyTmFtZV07XG4gIH1cblxuICAvKipcbiAgICogZ2V0cyBmaWx0ZXIgZnVuY3Rpb24gdGhhdCBmaWx0ZXJzIG91dCBwYXRpZW50cyBiYXNlZCBvbiBjcml0ZXJpYSBmcm9tIGNvbmdsb21lcmF0ZWQgZmlsdGVyIHF1ZXJ5XG4gICAqL1xuICBnZXRTZXJ2ZXJTaWRlRmlsdGVyRnVuY3Rpb24oKSB7XG4gICAgY29uc3QgdGhpc1JlZiA9IHRoaXM7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIChwZXJhZ3JhcGg6IFBlcmFHcmFwaCk6IGJvb2xlYW4ge1xuICAgICAgZm9yIChjb25zdCB2bm0gb2YgdGhpc1JlZi5zZXJ2ZXJGaWx0ZXJlZFZpc2l0cykge1xuICAgICAgICBpZiAodm5tID09PSBwZXJhZ3JhcGgudm5tKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIGFkZCBmaWx0ZXIgY3JpdGVyaWEgdG8gY3JpdGVyaWEgb2JqZWN0XG4gICAqIEBwYXJhbSBjcml0ZXJpYSAtIGFycmF5IG9mIGNyaXRlcmlhIHRvIGFkZCB0byBmaWx0ZXJcbiAgICogQHBhcmFtIHRpdGxlIC0gcHJvcGVydHkgbmFtZSBvZiBjcml0ZXJpYSBvbiB0aGUgZmlsdGVyQ3JpdGVyaWEgb2JqZWN0IC0+IE1VU1QgbWF0Y2ggYVxuICAgKiBRdWVyeVBhcmFtIGluIHRoZSBSRVNUIGNhbGwgbG9jYXRlZCBpbiBjb21tb24uRmlsdGVyQ29udHJvbGxlciBvciBpdCB3b24ndCBiZSBhcHBsaWVkXG4gICAqL1xuICBzdGFnZVNlcnZlckZpbHRlckNyaXRlcmlhKGNyaXRlcmlhOiBBcnJheTxzdHJpbmc+LCB0aXRsZTogc3RyaW5nKSB7XG4gICAgdGhpcy5zdGFnZWRTZXJ2ZXJGaWx0ZXJDcml0ZXJpYVt0aXRsZV0gPSBjcml0ZXJpYTtcbiAgICB0aGlzLnN0YWdlRmlsdGVyKHRoaXMuc2VydmVyRmlsdGVyTmFtZSwgdGhpcy5nZXRTZXJ2ZXJTaWRlRmlsdGVyRnVuY3Rpb24oKSk7XG4gIH1cblxuICAvKipcbiAgICogcmVtb3ZlcyBhIGNyaXRlcmlhIG9iamVjdCBmcm9tIHRoZSBmaWx0ZXIgY3JpdGVyaWEgb2JqZWN0XG4gICAqIGlmIG5vIGNyaXRlcmlvbiByZW1haW4sIHRoZSBmaWx0ZXIgaXMgcmVtb3ZlZCBmcm9tIHRoZSBzdGFnZWQgZmlsdGVyc1xuICAgKiBAcGFyYW0gdGl0bGUgLSBuYW1lIG9mIHRoZSBjcml0ZXJpYSB0byBiZSByZW1vdmVkXG4gICAqL1xuICByZW1vdmVTdGFnZWRTZXJ2ZXJDcml0ZXJpYSh0aXRsZTogc3RyaW5nKSB7XG4gICAgZGVsZXRlIHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWFbdGl0bGVdO1xuICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLnN0YWdlZFNlcnZlckZpbHRlckNyaXRlcmlhKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMudW5zdGFnZUZpbHRlcih0aGlzLnNlcnZlckZpbHRlck5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiByZXR1cm4gc3RhZ2VkIHNlcnZlciBzaWRlIGZpbHRlciBwYXJhbWV0ZXJzXG4gICAqL1xuICBnZXRTdGFnZWRTZXJ2ZXJTaWRlRmlsdGVyQ3JpdGVyaWEoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWE7XG4gIH1cblxuICAvKipcbiAgICogcmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgdGhlIGN1cnJlbnQgYWN0aXZlIGZpbHRlcnMgYXQgdGhlIGdpdmVuIHRpbWVcbiAgICovXG4gIGdldEFjdGl2ZVNlcnZlckZpbHRlckNyaXRlcmlhKCk6IHt9IHtcbiAgICBjb25zdCBmaWx0ZXJTZXJ2aWNlUmVmID0gdGhpcztcbiAgICByZXR1cm4gZnVuY3Rpb24gKCk6IHt9IHtcbiAgICAgIHJldHVybiBmaWx0ZXJTZXJ2aWNlUmVmLl9hY3RpdmVTZXJ2ZXJGaWx0ZXJDcml0ZXJpYTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIHdoYXQgdG8gZG8gaWYgc2lkZWJhciBpcyBkZXN0cm95ZWRcbiAgICovXG4gIGNsZWFyQWxsRmlsdGVycygpIHtcbiAgICB0aGlzLmFjdGl2ZUZpbHRlcnMgPSB7fTtcbiAgICB0aGlzLnN0YWdpbmdGaWx0ZXJzID0ge307XG4gICAgdGhpcy5zZXJ2ZXJGaWx0ZXJlZFZpc2l0cyA9IFtdO1xuICAgIHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWEgPSB7fTtcbiAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSA9IHt9O1xuICAgIHRoaXMuZmlsdGVyU3ViamVjdCQubmV4dCh7fSk7XG4gICAgdGhpcy5ncm91cFNlcnZpY2UuY2xlYXJHcm91cEJ5KCk7XG4gICAgdGhpcy5zb3J0U2VydmljZS5jbGVhclNvcnQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBY3RpdmF0ZSB0aGUgc3RhZ2VkIGZpbHRlcnNcbiAgICpcbiAgICogMiBzZXBlcmF0ZSBwYXRoczpcbiAgICogICAgICBBLiBMb2NhdGlvbiBjaGFuZ2VzIC0+IHJlZnJlc2ggZ3JhcGhzIGlzIGNhbGxlZCBhZnRlciBjaGFuZ2luZyB0aGUgZW5kcG9pbnQgcGFyYW1ldGVycyBhbmQgYSB2YXJpYWJsZSBpcyBwYXNzZWQgaW5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBsZXQgcmVmcmVzaCBjaGFuZ2VzIGtub3cgaWYgdGhlIHNlcnZlciBzaWRlIGZpbHRlciBuZWVkcyB0byBiZSByZWZyZXNoZWRcbiAgICogICAgICBCLiBObyBsb2NhdGlvbiBjaGFuZ2VzIC0+IElmIHRoZSBzZXJ2ZXIgc2lkZSBmaWx0ZXJpbmcgbmVlZHMgdG8gYmUgcmVmcmVzaGVkLCBpdHMgUkVTVCBjYWxsIGlzIGluaXRpYXRlZCBiZWZvcmUgY2xpZW50IHNpZGUgZmlsdGVyaW5nIG9jY3VycyxcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdGhlcndpc2UgY2xpZW50IHNpZGUgZmlsdGVyaW5nIG9jY3VycyBpbW1lZGlhdGxleSBvbiBleGlzdGluZyBncmFwaHNcbiAgICovXG4gIGFjdGl2YXRlRmlsdGVycygpIHtcbiAgICAvLyBjbG9zZSBhcHByb3ByaWF0ZSBncm91cHMgaWYgY2hhbmdpbmcsIGZpbHRlcnMsIGdyb3VwIGJ5LCBvciBzb3J0XG4gICAgdGhpcy5ncm91cFNlcnZpY2UuY2hhbmdlR3JvdXBzQ2xvc2VkID0gdHJ1ZTtcbiAgICAvLyBzZXQgc3RhZ2VkIHNvcnQgdG8gYWN0aXZlXG4gICAgdGhpcy5zb3J0U2VydmljZS5hY3RpdmVTb3J0RnVuY3Rpb24gPSB0aGlzLnNvcnRTZXJ2aWNlLmdldFN0YWdlZFNvcnRGdW5jdGlvbigpO1xuICAgIHRoaXMuc29ydFNlcnZpY2UuYWN0aXZlU29ydE5hbWUgPSB0aGlzLnNvcnRTZXJ2aWNlLnN0YWdlZFNvcnROYW1lO1xuXG4gICAgLy8gc2V0IHN0YWdlZCBmaWx0ZXJzIHRvIGFjdGl2ZSBmaWx0ZXJzXG4gICAgdGhpcy5hY3RpdmVGaWx0ZXJzID0ge307XG4gICAgZm9yIChjb25zdCBmaWx0ZXIgaW4gdGhpcy5zdGFnaW5nRmlsdGVycykge1xuICAgICAgaWYgKHRoaXMuc3RhZ2luZ0ZpbHRlcnMuaGFzT3duUHJvcGVydHkoZmlsdGVyKSkge1xuICAgICAgICB0aGlzLmFjdGl2ZUZpbHRlcnNbZmlsdGVyXSA9IHRoaXMuc3RhZ2luZ0ZpbHRlcnNbZmlsdGVyXTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gc2V0IHN0YWdlZCBzZXJ2ZXIgc2lkZSBmaWx0ZXJpbmcgcXVlcnkgcGFyYW1ldGVycyB0byBhY3RpdmVcbiAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSA9IHt9O1xuICAgIGZvciAoY29uc3QgY3JpdGVyaWEgaW4gdGhpcy5zdGFnZWRTZXJ2ZXJGaWx0ZXJDcml0ZXJpYSkge1xuICAgICAgaWYgKHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWEuaGFzT3duUHJvcGVydHkoY3JpdGVyaWEpKSB7XG4gICAgICAgIHRoaXMuX2FjdGl2ZVNlcnZlckZpbHRlckNyaXRlcmlhW2NyaXRlcmlhXSA9IHRoaXMuc3RhZ2VkU2VydmVyRmlsdGVyQ3JpdGVyaWFbY3JpdGVyaWFdO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGNoZWNrIGlmIHRoZSBmaWx0ZXIgcXVlcnkgbmVlZHMgdG8gYmUgcnVuXG4gICAgY29uc3QgZXhlY3V0ZVF1ZXJ5ID0gdGhpcy5hY3RpdmVGaWx0ZXJzLmhhc093blByb3BlcnR5KHRoaXMuc2VydmVyRmlsdGVyTmFtZSk7XG5cbiAgICAvLyBDaGVjayBpZiB1bml0IHNlbGVjdGlvbiBoYXMgY2hhbmdlZFxuICAgIGlmICghdGhpcy5sb2NhdGlvblNlbGVjdG9yU2VydmljZS5pc0xvY2F0aW9uU2VsZWN0aW9uVGhlU2FtZSgpIHx8IHRoaXMuc29ydFNlcnZpY2UuYWN0aXZlU29ydE5hbWUgPT09IFNvcnRDaG9pY2VzLlJJU2NvcmUgfHwgdGhpcy5ncm91cFNlcnZpY2Uuc3RhZ2VkR3JvdXAuZ3JvdXBOYW1lICE9PSB0aGlzLmdyb3VwU2VydmljZS5hY3RpdmVHcm91cC5ncm91cE5hbWUpIHtcbiAgICAgIHRoaXMuZ3JvdXBTZXJ2aWNlLmFjdGl2ZUdyb3VwID0gdGhpcy5ncm91cFNlcnZpY2Uuc3RhZ2VkR3JvdXA7XG4gICAgICB0aGlzLmdyb3VwU2VydmljZS5ncm91cFN1YmplY3QkLm5leHQodGhpcy5ncm91cFNlcnZpY2UuYWN0aXZlR3JvdXAubGFuZXMpO1xuICAgICAgLy8gZ2V0IHNlbGVjdGVkIHVuaXQgYW5kIGZhY2lsaXR5IGlkc1xuICAgICAgY29uc3Qgc2VsZWN0ZWRMb2NhdGlvbnM6IExvY2F0aW9ucyA9IHRoaXMubG9jYXRpb25TZWxlY3RvclNlcnZpY2UuZ2V0TG9jYXRpb25zVG9GaWx0ZXIoKTtcbiAgICAgIC8vIFNpZ25hbCB0aGF0IGxvY2F0aW9uIHNlbGVjdGlvbnMgaGF2ZSBjaGFuZ2VkIGFuZCB3aGV0aGVyIG9yIG5vdCB0byBleGVjdXRlIHRoZSBmaWx0ZXIgcXVlcnlcbiAgICAgIHRoaXMubG9jYXRpb25zQ2hhbmdlZC5uZXh0KHtsb2NhdGlvbnM6IHNlbGVjdGVkTG9jYXRpb25zLCBleGVjdXRlRmlsdGVyUXVlcnk6IGV4ZWN1dGVRdWVyeX0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpZiBmaWx0ZXIgcXVlcnkgbmVlZHMgdG8gYmUgZXhlY3V0ZWQsIHdhaXQgZm9yIGl0IHRvIHJldHVybiBiZWZvcmUgZmlsdGVyaW5nIHRoZSBncmFwaHMgaW4gdGhlIGNsaWVudFxuICAgICAgaWYgKGV4ZWN1dGVRdWVyeSkge1xuICAgICAgICB0aGlzLmZpbHRlclJlc3RTZXJ2aWNlLmdldEZpbHRlcmVkVmlzaXRzKHRoaXMuZ2V0QWN0aXZlU2VydmVyRmlsdGVyQ3JpdGVyaWEoKSkuc3Vic2NyaWJlKCh2aXNpdHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXJ2ZXJGaWx0ZXJlZFZpc2l0cyA9IHZpc2l0cztcbiAgICAgICAgICB0aGlzLmZpbHRlclN1YmplY3QkLm5leHQodGhpcy5hY3RpdmVGaWx0ZXJzKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBwYXNzIHRoZSBmaWx0ZXIgc3ViamVjdCB3aXRoIHRoZSB1cGRhdGVkIGZpbHRlcnNcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmZpbHRlclN1YmplY3QkLm5leHQodGhpcy5hY3RpdmVGaWx0ZXJzKSwgNTAwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==